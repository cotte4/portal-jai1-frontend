<!-- Document Confirmation Popup -->
<div class="popup-overlay" *ngIf="showConfirmPopup" (click)="cancelUpload()">
  <div class="popup-card" (click)="$event.stopPropagation()">
    <div class="popup-icon">ğŸ“„</div>
    <h2>Confirmar documento</h2>
    <p>Â¿EstÃ¡s seguro que este es tu documento <strong>{{ getSelectedTypeLabel() }}</strong>?</p>
    <p class="file-name-preview" *ngIf="pendingFile">{{ pendingFile.name }}</p>
    <p class="warning-message">âš ï¸ No podrÃ¡s eliminar este documento luego de subirlo.</p>
    <div class="popup-actions">
      <button class="btn-popup-secondary" (click)="cancelUpload()">
        No, cancelar
      </button>
      <button class="btn-popup-primary" (click)="confirmUpload()">
        SÃ­, subir documento
      </button>
    </div>
  </div>
</div>

<!-- W2 Calculator Popup -->
<div class="popup-overlay" *ngIf="showW2Popup" (click)="closeW2Popup()">
  <div class="popup-card" (click)="$event.stopPropagation()">
    <div class="popup-icon">ğŸ§®</div>
    <h2>Â¡W2 detectado!</h2>
    <p>Â¿QuerÃ©s calcular tu posible devoluciÃ³n ahora mismo con este documento?</p>
    <div class="popup-actions">
      <button class="btn-popup-secondary" (click)="closeW2Popup()">
        Ahora no
      </button>
      <button class="btn-popup-primary" (click)="goToCalculator()">
        Â¡SÃ­, calcular! ğŸš€
      </button>
    </div>
  </div>
</div>

<!-- Help Tips Modal -->
<div class="popup-overlay" *ngIf="showHelpModal" (click)="closeHelpModal()">
  <div class="popup-card help-modal" (click)="$event.stopPropagation()">
    <button class="modal-close-btn" (click)="closeHelpModal()">x</button>
    <div class="popup-icon help-icon">?</div>
    <h2>Consejos para subir documentos</h2>

    <div class="help-content">
      <div class="help-section">
        <div class="help-section-header">
          <span class="help-section-icon">ğŸ“</span>
          <h3>Formatos aceptados</h3>
        </div>
        <p>JPG, PNG y PDF</p>
      </div>

      <div class="help-section">
        <div class="help-section-header">
          <span class="help-section-icon">ğŸ’¾</span>
          <h3>Tamano maximo</h3>
        </div>
        <p>25 MB por archivo</p>
      </div>

      <div class="help-section">
        <div class="help-section-header">
          <span class="help-section-icon">ğŸ“¸</span>
          <h3>Calidad del documento</h3>
        </div>
        <ul>
          <li>El documento debe ser legible y completo</li>
          <li>Evita fotos borrosas o cortadas</li>
          <li>Asegurate que se vea toda la informacion</li>
        </ul>
      </div>

      <div class="help-section highlight-section">
        <div class="help-section-header">
          <span class="help-section-icon">ğŸ“‹</span>
          <h3>Multiples W2</h3>
        </div>
        <p class="highlight-text">Si tenes mas de un W2, podes subir todos desde el boton "W2". Se guardaran todos correctamente.</p>
      </div>
    </div>

    <div class="popup-actions">
      <button class="btn-popup-primary" (click)="closeHelpModal()">
        Entendido
      </button>
    </div>
  </div>
</div>

<!-- Payment Instructions Modal -->
<div class="popup-overlay" *ngIf="showPaymentInstructions" (click)="closePaymentInstructions()">
  <div class="popup-card payment-instructions-modal" (click)="$event.stopPropagation()">
    <button class="modal-close-btn" (click)="closePaymentInstructions()">Ã—</button>
    <div class="popup-icon payment-icon">ğŸ’³</div>
    <h2>Instrucciones de Pago</h2>

    <div class="payment-details">
      <div class="payment-row">
        <span class="payment-label">Monto:</span>
        <span class="payment-value highlight">$30 USD</span>
      </div>
      <div class="payment-row">
        <span class="payment-label">Concepto:</span>
        <span class="payment-value">Pago inicial de compromiso / reserva del servicio</span>
      </div>
    </div>

    <div class="payment-methods-section">
      <h3>Medios de pago disponibles</h3>

      <div class="payment-method">
        <div class="method-header">
          <span class="method-icon">ğŸ’¸</span>
          <span class="method-name">Zelle</span>
        </div>
        <div class="method-details">
          <p><strong>Email:</strong> pagos&#64;jai1taxes.com</p>
          <p><strong>Nombre:</strong> JAI1 Tax Services LLC</p>
        </div>
      </div>

      <div class="payment-method">
        <div class="method-header">
          <span class="method-icon">ğŸ…¿ï¸</span>
          <span class="method-name">PayPal</span>
        </div>
        <div class="method-details">
          <p><strong>Email:</strong> paypal&#64;jai1taxes.com</p>
        </div>
      </div>

      <div class="payment-method">
        <div class="method-header">
          <span class="method-icon">ğŸŒ</span>
          <span class="method-name">Western Union / MoneyGram</span>
        </div>
        <div class="method-details">
          <p><strong>Nombre:</strong> JAI1 Tax Services</p>
          <p><strong>Ciudad:</strong> Miami, FL</p>
          <p class="note">Contacta soporte para mas detalles</p>
        </div>
      </div>
    </div>

    <div class="upload-reminder">
      <span class="reminder-icon">ğŸ“¸</span>
      <p><strong>Que subir:</strong> Screenshot o comprobante del pago realizado</p>
    </div>

    <div class="popup-actions">
      <button class="btn-popup-primary" (click)="closePaymentInstructions()">
        Entendido
      </button>
    </div>
  </div>
</div>

<!-- Initial Loading Screen -->
<div class="initial-loading" *ngIf="!hasLoaded">
  <div class="loading-spinner"></div>
  <p>Cargando tus documentos...</p>
</div>

<div class="upload-content" *ngIf="hasLoaded">
  <!-- Success Screen when all required docs uploaded -->
  <div class="success-screen" *ngIf="allRequiredDocsUploaded && !showUploadView">
    <div class="success-card">
      <div class="success-icon-big">ğŸ‰</div>
      <h1>Â¡Documentos Completos!</h1>
      <p class="success-subtitle">Has subido todos los documentos necesarios</p>

      <div class="success-checklist">
        <div class="success-item completed">
          <span class="item-icon">âœ“</span>
          <span>Documento W2</span>
        </div>
        <div class="success-item completed">
          <span class="item-icon">âœ“</span>
          <span>Comprobante de Pago</span>
        </div>
      </div>

      <p class="success-message">Tu documentaciÃ³n estÃ¡ lista para ser procesada. Nuestro equipo revisarÃ¡ todo y te notificaremos cualquier novedad.</p>

      <div class="success-actions">
        <button class="btn-primary-action" (click)="goToDashboard()">
          <span>Ver mi Progreso</span>
          <span>â†’</span>
        </button>
        <button class="btn-secondary-action" (click)="goToTaxForm()">
          Completar mi DeclaraciÃ³n
        </button>
      </div>
    </div>

    <!-- Link to view uploaded documents -->
    <div class="view-docs-section">
      <p class="view-docs-text">{{ uploadedFiles.length }} documentos cargados</p>
      <button class="btn-view-docs" (click)="showUploadView = true">
        Ver mis documentos
      </button>
    </div>
  </div>

  <!-- Regular upload view -->
  <div *ngIf="!allRequiredDocsUploaded || showUploadView">
    <!-- Back to success button when viewing docs after completion -->
    <button class="btn-back-to-success" *ngIf="allRequiredDocsUploaded && showUploadView" (click)="showUploadView = false">
      â† Volver al resumen
    </button>

    <!-- Page Title with Help Button -->
    <div class="page-title-row">
      <div class="page-title">
        <h1>{{ allRequiredDocsUploaded ? 'Mis Documentos' : 'Subir Documentos' }}</h1>
        <p>{{ allRequiredDocsUploaded ? 'Gestiona tus documentos fiscales' : 'Carga tus documentos fiscales relacionados (W-2, comprobantes y mas)' }}</p>
      </div>
      <button class="btn-help" (click)="openHelpModal()" title="Consejos para subir documentos">
        <span class="help-icon-btn">?</span>
        <span class="help-text">Ayuda</span>
      </button>
    </div>

  <!-- Messages -->
  <div class="message success-message" *ngIf="successMessage">
    <span class="message-icon">âœ“</span>
    {{ successMessage }}
  </div>
  <div class="message error-message" *ngIf="errorMessage">
    <span class="message-icon">âš </span>
    {{ errorMessage }}
  </div>

 <!-- Document Type Tabs -->
  <div class="document-type-tabs">
    <button
      *ngFor="let type of documentTypes"
      class="doc-tab"
      [class.active]="selectedType === type.value"
      [class.uploaded]="uploadedTypes.has(type.value)"
      (click)="selectedType = type.value">
      <span class="tab-icon">{{ type.value === 'w2' ? 'ğŸ“‹' : type.value === 'payment_proof' ? 'ğŸ’³' : 'ğŸ“' }}</span>
      <span class="tab-label">{{ type.label }}</span>
      <span class="tab-check" *ngIf="uploadedTypes.has(type.value)">âœ“</span>
    </button>
  </div>

  <!-- W2 Multiple Upload Hint -->
  <div class="w2-hint" *ngIf="selectedType === 'w2'">
    <span class="w2-hint-icon">i</span>
    <span class="w2-hint-text">Si tenes mas de un W2, podes subir todos aca. Se guardaran todos correctamente.</span>
  </div>

  <!-- Payment Instructions Info Card (visible when payment_proof tab is selected) -->
  <div class="payment-info-card" *ngIf="isPaymentProofSelected">
    <div class="payment-info-header">
      <span class="payment-info-icon">ğŸ’µ</span>
      <div class="payment-info-title">
        <h3>Pago Inicial Requerido</h3>
        <p class="payment-amount">$30 USD</p>
      </div>
    </div>
    <p class="payment-info-description">
      Antes de subir tu comprobante, realiza el pago inicial de <strong>$30 USD</strong> como reserva del servicio.
    </p>
    <button class="btn-payment-instructions" (click)="openPaymentInstructions()">
      <span>Ver instrucciones de pago</span>
      <span class="btn-arrow">â†’</span>
    </button>
  </div>

  <!-- Upload Zone -->
  <div
    class="upload-zone"
    [class.drag-over]="dragOver"
    [class.uploading]="isUploading"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
  >
    <div class="upload-icon-wrapper">
      <span class="upload-icon">{{ isUploading ? 'â³' : 'ğŸ“¤' }}</span>
    </div>
    <h2>{{ isUploading ? 'Subiendo archivo...' : 'Arrastra y suelta tus archivos aqui' }}</h2>
    <p class="upload-or" *ngIf="!isUploading">o</p>
    <label for="fileInput" class="btn-browse" *ngIf="!isUploading">
      <span>Seleccionar archivos</span>
    </label>
    <input
      type="file"
      id="fileInput"
      (change)="onFileSelected($event)"
      accept=".pdf,.png,.jpg,.jpeg"
      multiple
      hidden
      [disabled]="isUploading"
    >
    <div class="upload-info">
      <div class="info-item">
        <span class="info-icon">ğŸ“„</span>
        <span>PDF, PNG, JPG</span>
      </div>
      <div class="info-item">
        <span class="info-icon">ğŸ’¾</span>
        <span>Maximo 25MB por archivo</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando documentos...</p>
  </div>

  <!-- Uploaded Files Section -->
  <div class="files-section" *ngIf="uploadedFiles.length > 0 && !isLoading">
    <div class="section-header">
      <h2>Documentos cargados</h2>
      <span class="file-count">{{ uploadedFiles.length }} archivo<span *ngIf="uploadedFiles.length !== 1">s</span></span>
    </div>

    <div class="files-list">
      <div class="file-card" *ngFor="let file of uploadedFiles; let i = index">
        <div class="file-icon">{{ getFileIcon(file.mimeType) }}</div>
        <div class="file-details">
          <div class="file-name">{{ file.fileName }}</div>
          <div class="file-meta">
            <span class="file-size">{{ formatFileSize(file.fileSize) }}</span>
            <span class="file-separator">|</span>
            <span class="file-date">{{ file.uploadedAt | date:'dd/MM/yyyy HH:mm' }}</span>
            <span class="file-separator">|</span>
            <span class="file-type">{{ getDocumentTypeLabel(file.type) }}</span>
            <span *ngIf="file.isReviewed" class="reviewed-badge">Revisado</span>
          </div>
        </div>
        <button class="btn-download" (click)="downloadFile(file)" title="Descargar">
          <span>â¬‡ï¸</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="uploadedFiles.length === 0 && !isLoading">
    <div class="empty-icon">ğŸ“</div>
    <h3>No hay documentos cargados todavia</h3>
    <p>Comienza subiendo tus primeros archivos usando el area de arriba</p>
  </div>

  <!-- Tips Section -->
  <div class="tips-card">
    <div class="tips-header">
      <span class="tips-icon">ğŸ’¡</span>
      <h3>Consejos para subir documentos</h3>
    </div>
    <ul class="tips-list">
      <li>Asegurate de que los documentos sean legibles y esten completos</li>
      <li>Nombra tus archivos de forma clara (ej: "W2-2024.pdf")</li>
      <li>Si tienes dudas sobre que documentos necesitas, contactanos</li>
      <li>Puedes subir multiples archivos a la vez</li>
    </ul>
  </div>
  </div><!-- End of regular upload view -->
</div>
