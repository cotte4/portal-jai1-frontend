<div class="admin-container">
  <!-- Header -->
  <header class="admin-header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">JAI1</div>
        <span class="admin-badge">Panel Admin</span>
      </div>
      <div class="header-right">
        <div class="admin-info">
          <span class="admin-icon">üë§</span>
          <span class="admin-email">Administrador</span>
        </div>
        <button class="btn-refresh" (click)="refreshData()" [disabled]="isRefreshing">
          <span *ngIf="!isRefreshing">üîÑ Actualizar</span>
          <span *ngIf="isRefreshing">‚è≥ Actualizando...</span>
        </button>
        <button class="btn-export" (click)="exportToExcel()" [disabled]="isExporting">
          <span *ngIf="!isExporting">üìä Exportar Excel</span>
          <span *ngIf="isExporting">‚è≥ Exportando...</span>
        </button>
        <button class="btn-logout" (click)="logout()">
          <span>Cerrar sesion</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="admin-main">
    <!-- Page Title -->
    <div class="page-header">
      <div>
        <h1>Dashboard de Administracion</h1>
        <p>Gestiona todos los clientes y sus declaraciones</p>
      </div>
    </div>

    <!-- Season Summary Stats -->
    <div class="season-stats" *ngIf="seasonStats || isLoadingStats">
      <div class="season-stat-card">
        <div class="season-stat-icon clients-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">{{ seasonStats?.totalClients || 0 }}</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Total Clientes</div>
        </div>
      </div>

      <div class="season-stat-card">
        <div class="season-stat-icon completed-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">{{ seasonStats?.taxesCompletedPercent || 0 }}%</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Taxes Completados</div>
        </div>
      </div>

      <div class="season-stat-card">
        <div class="season-stat-icon projected-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">${{ (seasonStats?.projectedEarnings || 0) | number:'1.0-0' }}</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Ganancias Proyectadas</div>
        </div>
      </div>

      <div class="season-stat-card highlight">
        <div class="season-stat-icon earnings-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">${{ (seasonStats?.earningsToDate || 0) | number:'1.0-0' }}</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Ganancias Realizadas</div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="errorMessage">
      <div class="error-content">
        <span class="error-icon">‚ö†Ô∏è</span>
        <div class="error-text">
          <span class="error-message">{{ errorMessage }}</span>
          <span class="error-code" *ngIf="errorCode">({{ errorCode }})</span>
        </div>
      </div>
      <div class="error-actions">
        <button class="btn-retry" (click)="refreshData()">Reintentar</button>
        <button class="btn-dismiss" (click)="clearError()">Cerrar</button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card total" [class.active]="selectedFilter === 'all'" (click)="filterClients('all')">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.total }}</div>
          <div class="stat-label">Total Clientes</div>
        </div>
      </div>

      <div class="stat-card pending" [class.active]="selectedFilter === 'group_pending'" (click)="filterClients('group_pending')">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.pending }}</div>
          <div class="stat-label">Pendientes</div>
        </div>
      </div>

      <div class="stat-card review" [class.active]="selectedFilter === 'group_in_review'" (click)="filterClients('group_in_review')">
        <div class="stat-icon">üîç</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.inReview }}</div>
          <div class="stat-label">En Proceso</div>
        </div>
      </div>

      <div class="stat-card completed" [class.active]="selectedFilter === 'group_completed'" (click)="filterClients('group_completed')">
        <div class="stat-icon">‚úì</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.completed }}</div>
          <div class="stat-label">Completados</div>
        </div>
      </div>

      <div class="stat-card attention" [class.active]="selectedFilter === 'group_needs_attention'" (click)="filterClients('group_needs_attention')">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.needsAttention }}</div>
          <div class="stat-label">Requieren Atencion</div>
        </div>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-bar">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Buscar por nombre o email..."
        (input)="onSearchInput()"
        (keyup.enter)="onSearch()"
      />
      <select [(ngModel)]="selectedFilter" (change)="filterClients(selectedFilter)">
        <option *ngFor="let filter of statusFilters" [value]="filter.value">
          {{ filter.label }}
        </option>
      </select>
      <button class="btn-search" (click)="onSearch()">Buscar</button>
    </div>

    <!-- Active Group Filter Indicator -->
    <div class="active-filter-indicator" *ngIf="getActiveGroupFilterInfo() as groupInfo">
      <div class="filter-indicator-content">
        <span class="filter-label">Filtrando: <strong>{{ groupInfo.label }}</strong></span>
        <span class="filter-includes">Incluye: {{ groupInfo.statuses.join(', ') }}</span>
      </div>
      <button class="btn-clear-indicator" (click)="filterClients('all')">Limpiar filtro</button>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Cargando clientes...</p>
    </div>

    <!-- Clients Table -->
    <div class="clients-section" *ngIf="!isLoading">
      <div class="section-header">
        <h2>Lista de Clientes</h2>
        <div class="filter-info" *ngIf="selectedFilter !== 'all'">
          <button class="btn-clear-filter" (click)="filterClients('all')">
            Mostrar todos
          </button>
        </div>
      </div>

      <div class="clients-table">
        <div class="table-header">
          <div class="col-client">Cliente</div>
          <div class="col-email">Email</div>
          <div class="col-status-phase">Estado</div>
          <div class="col-payment">Pago</div>
          <div class="col-activity">Fecha Registro</div>
          <div class="col-actions">Acciones</div>
        </div>

        <div class="table-body">
          <div class="table-row" *ngFor="let client of filteredClients" (click)="viewClient(client.id)">
            <div class="col-client">
              <div class="client-avatar" [class.ready]="client.isReadyToPresent">
                {{ getInitials(client.user?.firstName, client.user?.lastName) }}
              </div>
              <div class="client-info">
                <div class="client-name">
                  {{ client.user?.firstName || 'Sin' }} {{ client.user?.lastName || 'Nombre' }}
                  <span class="ready-badge" *ngIf="client.isReadyToPresent">‚úì</span>
                </div>
                <div class="missing-tags" *ngIf="client.missingItems && client.missingItems.length > 0">
                  <span class="missing-tag" *ngFor="let item of client.missingItems">
                    {{ item }}
                  </span>
                </div>
              </div>
            </div>

            <div class="col-email">
              {{ client.user?.email || 'Sin email' }}
            </div>

            <div class="col-status-phase">
              <!-- Pre-filing phase: show single pre-filing status -->
              <ng-container *ngIf="!client.taxesFiled">
                <span class="status-badge" [ngClass]="getPreFilingStatusClass(client.preFilingStatus)">
                  {{ getPreFilingStatusLabel(client.preFilingStatus) }}
                </span>
              </ng-container>

              <!-- Post-filing phase: show Federal and State status -->
              <ng-container *ngIf="client.taxesFiled">
                <div class="status-dual">
                  <span class="status-badge status-federal" [ngClass]="getTaxStatusClass(client.federalStatus)">
                    F: {{ getTaxStatusLabel(client.federalStatus) }}
                  </span>
                  <span class="status-badge status-state" [ngClass]="getTaxStatusClass(client.stateStatus)">
                    S: {{ getTaxStatusLabel(client.stateStatus) }}
                  </span>
                </div>
              </ng-container>
            </div>

            <div class="col-payment">
              <span class="badge" [class.success]="client.paymentReceived" [class.pending]="!client.paymentReceived">
                {{ client.paymentReceived ? '‚úì Recibido' : '‚è≥ Pendiente' }}
              </span>
            </div>

            <div class="col-activity">
              {{ client.createdAt | date:'dd/MM/yyyy' }}
            </div>

            <div class="col-actions">
              <button class="btn-view" (click)="viewClient(client.id); $event.stopPropagation()">
                Ver detalles ‚Üí
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredClients.length === 0">
        <div class="empty-icon">üìã</div>
        <h3>No hay clientes en esta categoria</h3>
        <p>Selecciona "Mostrar todos" para ver todos los clientes</p>
      </div>

      <!-- Load More / Pagination Info -->
      <div class="pagination-section" *ngIf="filteredClients.length > 0">
        <div class="pagination-info" *ngIf="hasMore">
          <span class="loaded-count">Mostrando {{ totalLoaded }} clientes</span>
          <span class="more-available">Hay mas clientes disponibles</span>
        </div>
        <button
          class="btn-load-more"
          *ngIf="hasMore"
          (click)="loadMoreClients()"
          [disabled]="isLoadingMore"
        >
          <span *ngIf="!isLoadingMore">Cargar mas clientes</span>
          <span *ngIf="isLoadingMore">Cargando...</span>
        </button>
      </div>
    </div>
  </main>
</div>
