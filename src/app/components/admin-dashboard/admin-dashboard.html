<div class="admin-container">
  <!-- Header -->
  <header class="admin-header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">JAI1</div>
        <span class="admin-badge">Panel Admin</span>
      </div>
      <div class="header-right">
        <div class="admin-info">
          <span class="admin-icon">üë§</span>
          <span class="admin-email">Administrador</span>
        </div>
        <button class="btn-nav" (click)="goToDelays()">
          üìä Demoras
        </button>
        <button class="btn-nav" (click)="goToPayments()">
          üí∞ Pagos
        </button>
        <button class="btn-nav" (click)="goToAccounts()">
          üîë Cuentas
        </button>
        <button class="btn-nav" (click)="goToReferrals()">
          üë• Referidos
        </button>
        <button class="btn-refresh" (click)="refreshData()" [disabled]="isRefreshing">
          <span *ngIf="!isRefreshing">üîÑ Actualizar</span>
          <span *ngIf="isRefreshing">‚è≥ Actualizando...</span>
        </button>
        <button class="btn-export" (click)="exportToExcel()" [disabled]="isExporting">
          <span *ngIf="!isExporting">üìä Exportar Excel</span>
          <span *ngIf="isExporting">‚è≥ Exportando...</span>
        </button>
        <button class="btn-logout" (click)="logout()">
          <span>Cerrar sesion</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="admin-main">
    <!-- Page Title -->
    <div class="page-header">
      <div>
        <h1>Dashboard de Administracion</h1>
        <p>Gestiona todos los clientes y sus declaraciones</p>
      </div>
    </div>

    <!-- Season Summary Stats -->
    <div class="season-stats" *ngIf="seasonStats || isLoadingStats">
      <div class="season-stat-card">
        <div class="season-stat-icon clients-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">{{ seasonStats?.totalClients || 0 }}</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Total Clientes</div>
        </div>
      </div>

      <div class="season-stat-card">
        <div class="season-stat-icon completed-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">{{ seasonStats?.taxesCompletedPercent || 0 }}%</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Taxes Completados</div>
        </div>
      </div>

      <div class="season-stat-card">
        <div class="season-stat-icon projected-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">${{ (seasonStats?.projectedEarnings || 0) | number:'1.0-0' }}</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Ganancias Proyectadas</div>
        </div>
      </div>

      <div class="season-stat-card highlight">
        <div class="season-stat-icon earnings-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
          </svg>
        </div>
        <div class="season-stat-content">
          <div class="season-stat-value" *ngIf="!isLoadingStats">${{ (seasonStats?.earningsToDate || 0) | number:'1.0-0' }}</div>
          <div class="season-stat-value loading" *ngIf="isLoadingStats">--</div>
          <div class="season-stat-label">Ganancias Realizadas</div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="errorMessage">
      <div class="error-content">
        <span class="error-icon">‚ö†Ô∏è</span>
        <div class="error-text">
          <span class="error-message">{{ errorMessage }}</span>
          <span class="error-code" *ngIf="errorCode">({{ errorCode }})</span>
        </div>
      </div>
      <div class="error-actions">
        <button class="btn-retry" (click)="refreshData()">Reintentar</button>
        <button class="btn-dismiss" (click)="clearError()">Cerrar</button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card total" [class.active]="selectedFilter === 'all'" (click)="filterClients('all')">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.total }}</div>
          <div class="stat-label">Total Clientes</div>
        </div>
      </div>

      <div class="stat-card pending" [class.active]="selectedFilter === 'group_pending'" (click)="filterClients('group_pending')">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.pending }}</div>
          <div class="stat-label">Pendientes</div>
        </div>
      </div>

      <div class="stat-card review" [class.active]="selectedFilter === 'group_in_review'" (click)="filterClients('group_in_review')">
        <div class="stat-icon">üîç</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.inReview }}</div>
          <div class="stat-label">En Proceso</div>
        </div>
      </div>

      <div class="stat-card completed" [class.active]="selectedFilter === 'group_completed'" (click)="filterClients('group_completed')">
        <div class="stat-icon">‚úì</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.completed }}</div>
          <div class="stat-label">Completados</div>
        </div>
      </div>

      <div class="stat-card attention" [class.active]="selectedFilter === 'group_needs_attention'" (click)="filterClients('group_needs_attention')">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-content">
          <div class="stat-value">{{ stats.needsAttention }}</div>
          <div class="stat-label">Requieren Atencion</div>
        </div>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-bar">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Buscar por nombre o email..."
        (input)="onSearchInput()"
        (keyup.enter)="onSearch()"
      />
      <select [(ngModel)]="selectedFilter" (change)="filterClients(selectedFilter)">
        <option *ngFor="let filter of statusFilters" [value]="filter.value">
          {{ filter.label }}
        </option>
      </select>
      <button class="btn-search" (click)="onSearch()">Buscar</button>
    </div>

    <!-- Active Group Filter Indicator -->
    <div class="active-filter-indicator" *ngIf="getActiveGroupFilterInfo() as groupInfo">
      <div class="filter-indicator-content">
        <span class="filter-label">Filtrando: <strong>{{ groupInfo.label }}</strong></span>
        <span class="filter-includes">Incluye: {{ groupInfo.statuses.join(', ') }}</span>
      </div>
      <button class="btn-clear-indicator" (click)="filterClients('all')">Limpiar filtro</button>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Cargando clientes...</p>
    </div>

    <!-- Clients Table -->
    <div class="clients-section" *ngIf="!isLoading">
      <div class="section-header">
        <h2>Lista de Clientes</h2>
        <div class="filter-info" *ngIf="selectedFilter !== 'all'">
          <button class="btn-clear-filter" (click)="filterClients('all')">
            Mostrar todos
          </button>
        </div>
      </div>

      <!-- Sort Buttons -->
      <div class="sort-buttons">
        <span class="sort-label">Ordenar por:</span>
        <button
          class="btn-sort"
          [class.active]="sortField === 'name'"
          (click)="sortBy('name')">
          Nombre {{ sortField === 'name' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : 'A-Z' }}
        </button>
        <button
          class="btn-sort"
          [class.active]="sortField === 'federalRefund'"
          (click)="sortBy('federalRefund')">
          Dev. Federal {{ sortField === 'federalRefund' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : '‚Üì' }}
        </button>
        <button
          class="btn-sort"
          [class.active]="sortField === 'stateRefund'"
          (click)="sortBy('stateRefund')">
          Dev. Estatal {{ sortField === 'stateRefund' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : '‚Üì' }}
        </button>
        <button
          class="btn-sort-clear"
          *ngIf="sortField"
          (click)="clearSort()">
          Limpiar
        </button>
      </div>

      <div class="clients-table-wrapper">
        <table class="clients-table-new">
          <thead>
            <tr>
              <th class="col-name">Nombre</th>
              <th class="col-ssn">SSN</th>
              <th class="col-date">Fecha Presentacion</th>
              <th class="col-date">Ultima Revision</th>
              <th class="col-notes">Obs. Federal</th>
              <th class="col-refund">Dev. Federal</th>
              <th class="col-status">Estado Fed.</th>
              <th class="col-notes">Obs. Estatal</th>
              <th class="col-refund">Dev. Estatal</th>
              <th class="col-status">Estado Est.</th>
              <th class="col-accounts">Cuentas</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let client of filteredClients" class="table-row-new">
              <!-- 1. Name -->
              <td class="col-name">
                <div class="client-name-cell">
                  <span class="client-name">{{ client.user?.firstName || 'Sin' }} {{ client.user?.lastName || 'Nombre' }}</span>
                  <span class="ready-indicator" *ngIf="client.isReadyToPresent" title="Listo para presentar">‚úì</span>
                </div>
              </td>

              <!-- 2. SSN -->
              <td class="col-ssn">{{ client.ssn || '---' }}</td>

              <!-- 3. Tax Filing Date -->
              <td class="col-date">
                <span *ngIf="client.taxesFiledAt">{{ client.taxesFiledAt | date:'dd/MM/yy' }}</span>
                <span *ngIf="!client.taxesFiledAt" class="no-data">---</span>
              </td>

              <!-- 4. Last Review Date -->
              <td class="col-date">
                <span *ngIf="client.lastReviewDate">{{ client.lastReviewDate | date:'dd/MM/yy' }}</span>
                <span *ngIf="!client.lastReviewDate" class="no-data">---</span>
              </td>

              <!-- 5. Federal Notes -->
              <td class="col-notes">
                <span class="notes-preview" *ngIf="client.federalLastComment" [title]="client.federalLastComment">
                  {{ client.federalLastComment | slice:0:30 }}{{ client.federalLastComment.length > 30 ? '...' : '' }}
                </span>
                <span *ngIf="!client.federalLastComment" class="no-data">---</span>
              </td>

              <!-- 6. Federal Refund -->
              <td class="col-refund">
                <span *ngIf="client.federalActualRefund != null" class="refund-amount">
                  ${{ client.federalActualRefund | number:'1.0-0' }}
                </span>
                <span *ngIf="client.federalActualRefund == null" class="no-data">---</span>
              </td>

              <!-- 7. Federal Status -->
              <td class="col-status">
                <span *ngIf="client.taxesFiled" class="status-badge-mini" [ngClass]="getTaxStatusClass(client.federalStatus)">
                  {{ getTaxStatusLabel(client.federalStatus) }}
                </span>
                <span *ngIf="!client.taxesFiled" class="status-badge-mini" [ngClass]="getPreFilingStatusClass(client.preFilingStatus)">
                  {{ getPreFilingStatusLabel(client.preFilingStatus) }}
                </span>
              </td>

              <!-- 8. State Notes -->
              <td class="col-notes">
                <span class="notes-preview" *ngIf="client.stateLastComment" [title]="client.stateLastComment">
                  {{ client.stateLastComment | slice:0:30 }}{{ client.stateLastComment.length > 30 ? '...' : '' }}
                </span>
                <span *ngIf="!client.stateLastComment" class="no-data">---</span>
              </td>

              <!-- 9. State Refund -->
              <td class="col-refund">
                <span *ngIf="client.stateActualRefund != null" class="refund-amount">
                  ${{ client.stateActualRefund | number:'1.0-0' }}
                </span>
                <span *ngIf="client.stateActualRefund == null" class="no-data">---</span>
              </td>

              <!-- 10. State Status -->
              <td class="col-status">
                <span *ngIf="client.taxesFiled" class="status-badge-mini" [ngClass]="getTaxStatusClass(client.stateStatus)">
                  {{ getTaxStatusLabel(client.stateStatus) }}
                </span>
                <span *ngIf="!client.taxesFiled" class="no-data">---</span>
              </td>

              <!-- 11. Client Accounts Link -->
              <td class="col-accounts">
                <button class="btn-accounts" (click)="openCredentialsModal(client)" title="Ver credenciales">
                  üîë
                </button>
              </td>

              <!-- 12. Actions -->
              <td class="col-actions">
                <button class="btn-view" (click)="viewClient(client.id)">
                  Ver ‚Üí
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredClients.length === 0">
        <div class="empty-icon">üìã</div>
        <h3>No hay clientes en esta categoria</h3>
        <p>Selecciona "Mostrar todos" para ver todos los clientes</p>
      </div>

      <!-- Load More / Pagination Info -->
      <div class="pagination-section" *ngIf="filteredClients.length > 0">
        <div class="pagination-info" *ngIf="hasMore">
          <span class="loaded-count">Mostrando {{ totalLoaded }} clientes</span>
          <span class="more-available">Hay mas clientes disponibles</span>
        </div>
        <button
          class="btn-load-more"
          *ngIf="hasMore"
          (click)="loadMoreClients()"
          [disabled]="isLoadingMore"
        >
          <span *ngIf="!isLoadingMore">Cargar mas clientes</span>
          <span *ngIf="isLoadingMore">Cargando...</span>
        </button>
      </div>
    </div>
  </main>
</div>

<!-- Credentials Modal -->
<div class="modal-overlay" *ngIf="showCredentialsModal" (click)="closeCredentialsModal()">
  <div class="modal-content credentials-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Credenciales de Cliente</h3>
      <button class="modal-close" (click)="closeCredentialsModal()">&times;</button>
    </div>
    <div class="modal-body" *ngIf="selectedClientCredentials">
      <p class="client-name-modal">{{ selectedClientCredentials.clientName }}</p>

      <div class="credentials-section">
        <h4>TurboTax</h4>
        <div class="credential-row">
          <span class="credential-label">Usuario:</span>
          <span class="credential-value" (click)="copyToClipboard(selectedClientCredentials.credentials?.turbotaxEmail)">
            {{ selectedClientCredentials.credentials?.turbotaxEmail || '---' }}
          </span>
        </div>
        <div class="credential-row">
          <span class="credential-label">Password:</span>
          <span class="credential-value" (click)="copyToClipboard(selectedClientCredentials.credentials?.turbotaxPassword)">
            {{ selectedClientCredentials.credentials?.turbotaxPassword || '---' }}
          </span>
        </div>
      </div>

      <div class="credentials-section">
        <h4>IRS</h4>
        <div class="credential-row">
          <span class="credential-label">Usuario:</span>
          <span class="credential-value" (click)="copyToClipboard(selectedClientCredentials.credentials?.irsUsername)">
            {{ selectedClientCredentials.credentials?.irsUsername || '---' }}
          </span>
        </div>
        <div class="credential-row">
          <span class="credential-label">Password:</span>
          <span class="credential-value" (click)="copyToClipboard(selectedClientCredentials.credentials?.irsPassword)">
            {{ selectedClientCredentials.credentials?.irsPassword || '---' }}
          </span>
        </div>
      </div>

      <div class="credentials-section">
        <h4>Estado</h4>
        <div class="credential-row">
          <span class="credential-label">Usuario:</span>
          <span class="credential-value" (click)="copyToClipboard(selectedClientCredentials.credentials?.stateUsername)">
            {{ selectedClientCredentials.credentials?.stateUsername || '---' }}
          </span>
        </div>
        <div class="credential-row">
          <span class="credential-label">Password:</span>
          <span class="credential-value" (click)="copyToClipboard(selectedClientCredentials.credentials?.statePassword)">
            {{ selectedClientCredentials.credentials?.statePassword || '---' }}
          </span>
        </div>
      </div>

      <p class="copy-hint">Click en cualquier valor para copiar al portapapeles</p>
    </div>
  </div>
</div>
