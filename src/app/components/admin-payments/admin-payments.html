<div class="admin-container" [class.dark-mode]="darkMode">
  <!-- Header -->
  <header class="admin-header">
    <div class="header-content">
      <div class="header-left">
        <button class="btn-back" (click)="goBack()">
          <span class="back-arrow">&#8592;</span>
          Volver
        </button>
        <div class="logo">JAI1</div>
        <span class="admin-badge">Pagos</span>
      </div>
      <div class="header-right">
        <button class="help-toggle" (click)="toggleHelp()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          {{ showHelp ? 'Ocultar ayuda' : 'Ayuda' }}
        </button>
        <button class="btn-export" (click)="exportToExcel()" [disabled]="isExporting || clients.length === 0">
          {{ isExporting ? 'Exportando...' : 'Exportar Excel' }}
        </button>
        <button class="btn-refresh" (click)="refreshData()" [disabled]="isLoading">
          <span *ngIf="!isLoading">Actualizar</span>
          <span *ngIf="isLoading">Cargando...</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="admin-main">
    <!-- Page Title -->
    <div class="page-header">
      <div>
        <h1>Resumen de Pagos</h1>
        <p>Calculo de comisiones y pagos a clientes</p>
      </div>
      <div class="total-badge" *ngIf="hasLoaded && !errorMessage && activeTab === 'all'">
        <span class="total-count">{{ clients.length }}</span>
        <span class="total-label">Clientes Cargados</span>
      </div>
      <div class="total-badge unpaid" *ngIf="unpaidHasLoaded && !errorMessage && activeTab === 'unpaid'">
        <span class="total-count">{{ unpaidTotals.clientCount }}</span>
        <span class="total-label">Pendientes de Pago</span>
      </div>
    </div>

    <!-- Help Banner -->
    <div class="help-banner" *ngIf="showHelp">
      <div class="help-section">
        <h3>Que es esto?</h3>
        <p>Esta vista muestra todos los reembolsos (refunds) de los clientes y el calculo automatico de comisiones. Permite hacer seguimiento de cuanto recibe cada cliente y cuanto corresponde de comision.</p>
      </div>

      <div class="help-section">
        <h3>Pestanas</h3>
        <div class="help-columns">
          <div class="help-column-item">
            <strong>Todos los Pagos</strong>
            <span>Vista completa de todos los clientes con sus montos de reembolso federal/estatal, comision calculada por caso, y lo que le corresponde recibir al cliente.</span>
          </div>
          <div class="help-column-item">
            <strong>Comisiones Pendientes</strong>
            <span>Clientes que ya confirmaron haber recibido su reembolso pero todavia no se cobro la comision. Desde aqui podes marcar cada comision como pagada.</span>
          </div>
        </div>
      </div>

      <div class="help-section">
        <h3>Que significa cada columna</h3>
        <div class="help-columns">
          <div class="help-column-item">
            <strong>Federal / State Taxes</strong>
            <span>Monto del reembolso federal y estatal que recibe el cliente del IRS y del estado.</span>
          </div>
          <div class="help-column-item">
            <strong>Total Taxes</strong>
            <span>Suma de ambos reembolsos (federal + estatal).</span>
          </div>
          <div class="help-column-item">
            <strong>Comision Fed. / Est.</strong>
            <span>Porcentaje del reembolso federal y estatal que corresponde como comision (11% o 22% segun el caso).</span>
          </div>
          <div class="help-column-item">
            <strong>Total Comision</strong>
            <span>Suma de ambas comisiones. Este es el monto total a cobrar por cliente.</span>
          </div>
          <div class="help-column-item">
            <strong>Cliente Recibe</strong>
            <span>Lo que le queda al cliente despues de descontar la comision (Total Taxes - Total Comision).</span>
          </div>
        </div>
      </div>

      <div class="help-section">
        <h3>Estados de pago</h3>
        <div class="color-legend">
          <div class="legend-item">
            <span class="legend-badge status-pending">Pendiente</span>
            <span class="legend-text">El cliente aun no recibio el deposito de su reembolso.</span>
          </div>
          <div class="legend-item">
            <span class="legend-badge status-deposited">Deposito Recibido</span>
            <span class="legend-text">El cliente confirmo que recibio el deposito. Falta cobrar comision.</span>
          </div>
          <div class="legend-item">
            <span class="legend-badge status-paid">Comision Pagada</span>
            <span class="legend-text">La comision ya fue cobrada. Caso cerrado.</span>
          </div>
        </div>
      </div>

      <div class="help-section">
        <h3>Tarjetas de resumen</h3>
        <div class="help-columns">
          <div class="help-column-item">
            <strong>Total Taxes (Refunds)</strong>
            <span>Suma de todos los reembolsos federales y estatales de todos los clientes.</span>
          </div>
          <div class="help-column-item">
            <strong>Total Comision</strong>
            <span>Suma de todas las comisiones. Este es el ingreso bruto total.</span>
          </div>
          <div class="help-column-item">
            <strong>Total a Clientes</strong>
            <span>Suma de lo que reciben todos los clientes despues de descontar comisiones.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'all'"
        (click)="switchTab('all')">
        Todos los Pagos
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'unpaid'"
        (click)="switchTab('unpaid')">
        Comisiones Pendientes
        <span class="tab-badge" *ngIf="unpaidTotals.clientCount > 0">{{ unpaidTotals.clientCount }}</span>
      </button>
    </div>

    <!-- Summary Cards - All Payments Tab -->
    <div class="summary-cards" *ngIf="hasLoaded && !errorMessage && activeTab === 'all'">
      <div class="summary-card">
        <div class="summary-icon taxes-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-value">{{ formatCurrency(totals.totalTaxes) }}</div>
          <div class="summary-label">Total Taxes (Refunds)</div>
        </div>
      </div>

      <div class="summary-card highlight">
        <div class="summary-icon commission-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-value">{{ formatCurrency(totals.totalCommission) }}</div>
          <div class="summary-label">Total Comision</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-icon client-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-value">{{ formatCurrency(totals.clientReceives) }}</div>
          <div class="summary-label">Total a Clientes</div>
        </div>
      </div>
    </div>

    <!-- Summary Cards - Unpaid Commissions Tab -->
    <div class="summary-cards" *ngIf="unpaidHasLoaded && !errorMessage && activeTab === 'unpaid'">
      <div class="summary-card highlight warning">
        <div class="summary-icon warning-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-value">{{ formatCurrency(unpaidTotals.totalUnpaidCommission) }}</div>
          <div class="summary-label">Total Pendiente</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-icon federal-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-value">{{ formatCurrency(unpaidTotals.unpaidFederalCommission) }}</div>
          <div class="summary-label">Federal Pendiente</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-icon state-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-value">{{ formatCurrency(unpaidTotals.unpaidStateCommission) }}</div>
          <div class="summary-label">Estatal Pendiente</div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="errorMessage">
      <div class="error-content">
        <span class="error-icon">!</span>
        <span class="error-message">{{ errorMessage }}</span>
      </div>
      <button class="btn-retry" (click)="refreshData()">Reintentar</button>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading && !hasLoaded">
      <div class="spinner"></div>
      <p>Cargando pagos...</p>
    </div>

    <!-- Payments Table - All Tab -->
    <div class="payments-section" *ngIf="hasLoaded && !errorMessage && activeTab === 'all'">
      <div class="section-header">
        <h2>Detalle de Pagos por Cliente</h2>
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (input)="filterByName()"
            placeholder="Buscar por nombre..."
            class="search-input"
          />
        </div>
      </div>

      <div class="table-wrapper">
        <div class="payments-table" *ngIf="filteredClients.length > 0">
          <div class="table-header">
            <div class="col-name">Cliente</div>
            <div class="col-federal">Federal Taxes</div>
            <div class="col-state">State Taxes</div>
            <div class="col-total-taxes">Total Taxes</div>
            <div class="col-fed-comm">Comision Fed.</div>
            <div class="col-state-comm">Comision Est.</div>
            <div class="col-total-comm">Total Comision</div>
            <div class="col-receives">Cliente Recibe</div>
            <div class="col-status">Estado</div>
          </div>

          <div class="table-body">
            <div class="table-row" *ngFor="let client of filteredClients; trackBy: trackById" (click)="viewClient(client.id)">
              <div class="col-name">
                <div class="user-avatar">
                  {{ getInitials(client.name) }}
                </div>
                <div class="user-info">
                  <span class="user-name">{{ client.name }}</span>
                  <span class="user-email">{{ client.email }}</span>
                </div>
              </div>

              <div class="col-federal">
                <span class="amount">{{ formatCurrency(client.federalTaxes) }}</span>
              </div>

              <div class="col-state">
                <span class="amount">{{ formatCurrency(client.stateTaxes) }}</span>
              </div>

              <div class="col-total-taxes">
                <span class="amount total">{{ formatCurrency(client.totalTaxes) }}</span>
              </div>

              <div class="col-fed-comm">
                <span class="amount commission">{{ formatCurrency(client.federalCommission) }}</span>
              </div>

              <div class="col-state-comm">
                <span class="amount commission">{{ formatCurrency(client.stateCommission) }}</span>
              </div>

              <div class="col-total-comm">
                <span class="amount commission total">{{ formatCurrency(client.totalCommission) }}</span>
              </div>

              <div class="col-receives">
                <span class="amount receives">{{ formatCurrency(client.clientReceives) }}</span>
              </div>

              <div class="col-status">
                <span class="status-badge" [ngClass]="getPaymentStatusClass(client)">
                  {{ getPaymentStatusLabel(client) }}
                </span>
              </div>
            </div>
          </div>

          <!-- Totals Row -->
          <div class="table-totals">
            <div class="col-name">
              <span class="totals-label">TOTALES</span>
            </div>
            <div class="col-federal">
              <span class="amount total-value">{{ formatCurrency(totals.federalTaxes) }}</span>
            </div>
            <div class="col-state">
              <span class="amount total-value">{{ formatCurrency(totals.stateTaxes) }}</span>
            </div>
            <div class="col-total-taxes">
              <span class="amount total-value highlight">{{ formatCurrency(totals.totalTaxes) }}</span>
            </div>
            <div class="col-fed-comm">
              <span class="amount total-value">{{ formatCurrency(totals.federalCommission) }}</span>
            </div>
            <div class="col-state-comm">
              <span class="amount total-value">{{ formatCurrency(totals.stateCommission) }}</span>
            </div>
            <div class="col-total-comm">
              <span class="amount total-value highlight">{{ formatCurrency(totals.totalCommission) }}</span>
            </div>
            <div class="col-receives">
              <span class="amount total-value highlight">{{ formatCurrency(totals.clientReceives) }}</span>
            </div>
            <div class="col-status"></div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredClients.length === 0">
        <div class="empty-icon">&#128176;</div>
        <h3>{{ searchQuery ? 'No se encontraron resultados' : 'No hay pagos registrados' }}</h3>
        <p>{{ searchQuery ? 'Intenta con otro nombre' : 'Cuando se registren refunds para los clientes, apareceran aqui' }}</p>
      </div>

      <!-- Load More Button -->
      <div class="load-more-section" *ngIf="hasMore && filteredClients.length > 0">
        <button
          class="btn-load-more"
          (click)="loadMorePayments()"
          [disabled]="isLoadingMore">
          <span *ngIf="!isLoadingMore">Cargar Mas</span>
          <span *ngIf="isLoadingMore">Cargando...</span>
        </button>
      </div>
    </div>

    <!-- Unpaid Commissions Section -->
    <div class="payments-section unpaid-section" *ngIf="unpaidHasLoaded && !errorMessage && activeTab === 'unpaid'">
      <div class="section-header">
        <h2>Clientes con Comisiones Pendientes</h2>
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="unpaidSearchQuery"
            (input)="filterUnpaidByName()"
            placeholder="Buscar por nombre o email..."
            class="search-input"
          />
        </div>
      </div>

      <!-- Unpaid Clients List -->
      <div class="unpaid-list" *ngIf="filteredUnpaidClients.length > 0">
        <div class="unpaid-card" *ngFor="let client of filteredUnpaidClients; trackBy: trackById" (click)="viewClient(client.id)">
          <div class="unpaid-card-header">
            <div class="client-info">
              <div class="user-avatar">{{ getInitials(client.name) }}</div>
              <div class="user-details">
                <span class="user-name">{{ client.name }}</span>
                <span class="user-email">{{ client.email }}</span>
                <span class="user-phone" *ngIf="client.phone">{{ client.phone }}</span>
              </div>
            </div>
            <div class="total-unpaid">
              <span class="unpaid-label">Pendiente:</span>
              <span class="unpaid-amount">{{ formatCurrency(client.totalUnpaidCommission) }}</span>
            </div>
          </div>

          <div class="unpaid-card-body">
            <!-- Federal Section -->
            <div class="refund-row" *ngIf="client.federal.refundReceived">
              <div class="refund-type federal">
                <span class="type-badge">Federal</span>
              </div>
              <div class="refund-details">
                <div class="refund-info">
                  <span class="refund-label">Reembolso:</span>
                  <span class="refund-value">{{ formatCurrency(client.federal.refundAmount) }}</span>
                </div>
                <div class="refund-info">
                  <span class="refund-label">Comision:</span>
                  <span class="refund-value commission">{{ formatCurrency(client.federal.commission) }}</span>
                </div>
                <div class="refund-info">
                  <span class="refund-label">Confirmado:</span>
                  <span class="refund-value date">{{ formatDate(client.federal.refundReceivedAt) }}</span>
                </div>
              </div>
              <div class="refund-action">
                <button
                  *ngIf="!client.federal.commissionPaid"
                  class="btn-mark-paid"
                  (click)="markCommissionPaid(client.id, 'federal', $event)"
                  [disabled]="markingPaidClientId === client.id && markingPaidType === 'federal'">
                  <span *ngIf="markingPaidClientId !== client.id || markingPaidType !== 'federal'">Marcar Pagado</span>
                  <span *ngIf="markingPaidClientId === client.id && markingPaidType === 'federal'">Procesando...</span>
                </button>
                <span *ngIf="client.federal.commissionPaid" class="paid-badge">
                  <span class="check-icon">✓</span> Pagado
                </span>
              </div>
            </div>

            <!-- State Section -->
            <div class="refund-row" *ngIf="client.state.refundReceived">
              <div class="refund-type state">
                <span class="type-badge">Estatal</span>
              </div>
              <div class="refund-details">
                <div class="refund-info">
                  <span class="refund-label">Reembolso:</span>
                  <span class="refund-value">{{ formatCurrency(client.state.refundAmount) }}</span>
                </div>
                <div class="refund-info">
                  <span class="refund-label">Comision:</span>
                  <span class="refund-value commission">{{ formatCurrency(client.state.commission) }}</span>
                </div>
                <div class="refund-info">
                  <span class="refund-label">Confirmado:</span>
                  <span class="refund-value date">{{ formatDate(client.state.refundReceivedAt) }}</span>
                </div>
              </div>
              <div class="refund-action">
                <button
                  *ngIf="!client.state.commissionPaid"
                  class="btn-mark-paid"
                  (click)="markCommissionPaid(client.id, 'state', $event)"
                  [disabled]="markingPaidClientId === client.id && markingPaidType === 'state'">
                  <span *ngIf="markingPaidClientId !== client.id || markingPaidType !== 'state'">Marcar Pagado</span>
                  <span *ngIf="markingPaidClientId === client.id && markingPaidType === 'state'">Procesando...</span>
                </button>
                <span *ngIf="client.state.commissionPaid" class="paid-badge">
                  <span class="check-icon">✓</span> Pagado
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State for Unpaid -->
      <div class="empty-state" *ngIf="filteredUnpaidClients.length === 0">
        <div class="empty-icon">&#10003;</div>
        <h3>{{ unpaidSearchQuery ? 'No se encontraron resultados' : 'Sin comisiones pendientes' }}</h3>
        <p>{{ unpaidSearchQuery ? 'Intenta con otro nombre o email' : 'Todos los clientes tienen sus comisiones pagadas' }}</p>
      </div>
    </div>

    <!-- Loading for Unpaid Tab -->
    <div class="loading-state" *ngIf="isLoading && activeTab === 'unpaid' && !unpaidHasLoaded">
      <div class="spinner"></div>
      <p>Cargando comisiones pendientes...</p>
    </div>
  </main>
</div>
