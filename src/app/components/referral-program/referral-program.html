<!-- Base Background (always visible) -->
<div class="referral-base-bg"></div>

<!-- Page Transition Overlay -->
@if (showTransition) {
  <div class="page-transition">
    <div class="transition-content">
      <div class="transition-icon">ğŸ</div>
      <div class="transition-text">Programa de Referidos</div>
    </div>
  </div>
}

<!-- Onboarding Overlay -->
@if (showOnboarding && !showTransition) {
  <div class="onboarding-overlay">
    <!-- Background decoration -->
    <div class="onboarding-bg">
      <div class="onboarding-gradient"></div>
      <div class="onboarding-glow glow-1"></div>
      <div class="onboarding-glow glow-2"></div>
    </div>

    <div class="onboarding-container">
      <!-- Skip button -->
      <button class="onboarding-skip" (click)="skipOnboarding()">
        Omitir
      </button>

      <!-- Step 1: Share & Earn -->
      @if (onboardingStep === 'benefit1') {
        <div class="onboarding-content">
          <div class="onboarding-icon-wrapper">
            <div class="onboarding-icon">
              <span>ğŸ</span>
            </div>
          </div>
          <h1>Comparti y gana</h1>
          <p>Cada vez que un amigo use tu codigo de referido, vos ganas descuentos en tus proximos taxes y el recibe $11 de descuento.</p>
        </div>
      }

      <!-- Step 2: Unlock Levels -->
      @if (onboardingStep === 'benefit2') {
        <div class="onboarding-content">
          <div class="onboarding-icon-wrapper">
            <div class="onboarding-icon">
              <span>ğŸ†</span>
            </div>
          </div>
          <h1>Desbloquea niveles</h1>
          <p>Mientras mas referidos tengas, mas descuento ganas. Subi de nivel desde 5% hasta 100% GRATIS en tu proxima declaracion.</p>
        </div>
      }

      <!-- Step 3: How it works -->
      @if (onboardingStep === 'benefit3') {
        <div class="onboarding-content">
          <div class="onboarding-icon-wrapper">
            <div class="onboarding-icon">
              <span>ğŸ“¤</span>
            </div>
          </div>
          <h1>Asi de facil</h1>
          <div class="onboarding-steps">
            <div class="onboarding-step-item">
              <span class="step-num">1</span>
              <span>Comparti tu codigo unico</span>
            </div>
            <div class="onboarding-step-item">
              <span class="step-num">2</span>
              <span>Tu amigo lo usa al registrarse</span>
            </div>
            <div class="onboarding-step-item">
              <span class="step-num">3</span>
              <span>Ambos ganan beneficios</span>
            </div>
          </div>
        </div>
      }

      <!-- Progress dots -->
      <div class="onboarding-dots">
        <span class="dot" [class.active]="onboardingStep === 'benefit1'"></span>
        <span class="dot" [class.active]="onboardingStep === 'benefit2'"></span>
        <span class="dot" [class.active]="onboardingStep === 'benefit3'"></span>
      </div>

      <!-- Navigation -->
      <div class="onboarding-nav">
        @if (onboardingStep !== 'benefit1') {
          <button class="btn-back" (click)="previousOnboardingStep()">
            <span>â†</span>
            <span>Atras</span>
          </button>
        } @else {
          <div></div>
        }

        <button class="btn-next" (click)="nextOnboardingStep()">
          @if (onboardingStep === 'benefit3') {
            <span>Empezar</span>
            <span>â†’</span>
          } @else {
            <span>Siguiente</span>
            <span>â†’</span>
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Main Referral Program Content -->
@if (!showOnboarding && !showTransition) {
  <div class="referral-container">
    <!-- Background Effects -->
    <div class="bg-effects">
      <div class="bg-gradient"></div>
      <div class="bg-pattern"></div>
    </div>

    <!-- Header with Mode Toggle -->
    <header class="referral-header">
      <div class="header-left">
        <div class="logo">
          <span class="logo-j">J</span><span class="logo-slash">/</span><span class="logo-ai">AI1</span>
        </div>
        <span class="header-divider">|</span>
        <span class="header-title">Programa de Referidos</span>
      </div>

      <div class="header-right">
        <button class="btn-leaderboard-header" (click)="goToLeaderboard()">
          <span class="btn-icon">ğŸ†</span>
          <span class="btn-text">Arena</span>
        </button>
        <button class="mode-toggle" (click)="goToTaxMode()">
          <span class="toggle-icon">ğŸ“‹</span>
          <span class="toggle-text">Modo Taxes</span>
          <span class="toggle-arrow">â†’</span>
        </button>
      </div>
    </header>

    <!-- Loading State -->
    @if (viewState === 'loading') {
      <div class="state-container">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <h2>Cargando tu programa de referidos...</h2>
          <p>Un momento por favor</p>
          <button class="btn-refresh-loading" (click)="refresh()" [disabled]="isRefreshing">
            <span class="refresh-icon" [class.spinning]="isRefreshing">ğŸ”„</span>
            <span>{{ isRefreshing ? 'Actualizando...' : 'Refrescar' }}</span>
          </button>
        </div>
      </div>
    }

    <!-- Error State -->
    @if (viewState === 'error') {
      <div class="state-container">
        <div class="error-content">
          <div class="error-icon">âš ï¸</div>
          <h2>Algo salio mal</h2>
          <p>{{ errorMessage }}</p>
          <div class="error-actions">
            <button class="btn-retry" (click)="refresh()" [disabled]="isRefreshing">
              <span class="refresh-icon" [class.spinning]="isRefreshing">ğŸ”„</span>
              <span>{{ isRefreshing ? 'Reintentando...' : 'Intentar de nuevo' }}</span>
            </button>
          </div>
          <button class="btn-back-link" (click)="goToTaxMode()">
            â† Volver al dashboard
          </button>
        </div>
      </div>
    }

    <!-- Not Eligible State -->
    @if (viewState === 'not-eligible') {
      <div class="state-container">
        <div class="not-eligible-content">
          <div class="not-eligible-icon">ğŸ”’</div>
          <h2>Casi sos un JAIGENT!</h2>
          <p>Para acceder al programa de referidos y empezar a ganar, primero necesitas completar y enviar tu declaracion de taxes.</p>

          <div class="benefits-preview">
            <h3>Lo que te espera:</h3>
            <div class="benefit-item">
              <span class="benefit-icon">ğŸ</span>
              <span>Tu codigo unico de referido</span>
            </div>
            <div class="benefit-item">
              <span class="benefit-icon">ğŸ’µ</span>
              <span>Gana hasta 100% de descuento por referir amigos</span>
            </div>
            <div class="benefit-item">
              <span class="benefit-icon">ğŸ†</span>
              <span>Subi de nivel y desbloquea recompensas</span>
            </div>
          </div>

          <button class="btn-cta" (click)="goToTaxForm()">
            <span>Completar mi declaracion</span>
            <span class="btn-arrow">â†’</span>
          </button>
        </div>
      </div>
    }

    <!-- Dashboard State -->
    @if (viewState === 'dashboard' && codeData?.code) {
      <main class="referral-main">

        <!-- STATE 1: No Referrals Yet - Empty State -->
        @if (!hasReferrals) {
          <!-- Welcome Section -->
          <section class="welcome-section">
            <div class="welcome-badge">
              <span class="badge-icon">ğŸŒŸ</span>
              <span class="badge-text">JAIGENT</span>
            </div>
            <h1>Bienvenido al programa, {{ userFirstName }}!</h1>
            <p>Comparti tu codigo con otros J1s y empeza a ganar descuentos increibles.</p>
          </section>

          <!-- Prominent Code Card for Empty State -->
          <section class="code-section featured">
            <div class="code-card featured">
              <div class="code-header">
                <span class="code-label">Tu codigo de referido</span>
              </div>

              <div class="code-display" (click)="copyCode()">
                <span class="code-text">{{ codeData!.code }}</span>
                <div class="copy-indicator" [class.copied]="codeCopied">
                  @if (codeCopied) {
                    <span class="copy-icon">âœ“</span>
                    <span>Copiado!</span>
                  } @else {
                    <span class="copy-icon">ğŸ“‹</span>
                    <span>Copiar</span>
                  }
                </div>
              </div>

              <div class="code-actions">
                <button class="btn-share-main" (click)="shareViaWhatsApp()">
                  <span>ğŸ“±</span>
                  <span>Compartir por WhatsApp</span>
                </button>
                <button class="btn-share-more" (click)="toggleShareOptions()">
                  <span>â‹¯</span>
                </button>
              </div>

              @if (showShareOptions) {
                <div class="share-dropdown">
                  <button class="share-option" (click)="shareViaTwitter()">
                    <span>ğŸ¦</span>
                    <span>Twitter</span>
                  </button>
                  <button class="share-option" (click)="shareViaEmail()">
                    <span>ğŸ“§</span>
                    <span>Email</span>
                  </button>
                </div>
              }

              <div class="referral-benefit">
                <span class="benefit-tag">ğŸ Beneficio para tu referido</span>
                <span class="benefit-value">$11 USD de descuento</span>
              </div>
            </div>
          </section>

          <!-- Empty State Message -->
          <section class="empty-state-hero">
            <div class="empty-state-card">
              <div class="empty-icon-large">ğŸ¯</div>
              <h2>Nadie ha usado tu codigo todavia</h2>
              <p>Compartilo para empezar a ganar descuentos! Por cada amigo que use tu codigo, vos ganas y el tambien.</p>
              <div class="first-reward-preview">
                <span class="preview-label">Tu primer beneficio:</span>
                <span class="preview-value">5% descuento</span>
              </div>
            </div>
          </section>

          <!-- Reward Tiers Preview -->
          <section class="tiers-section">
            <div class="section-header">
              <h2>ğŸ† Niveles de Descuento</h2>
              <p>Mientras mas referis, mas descuento ganas</p>
            </div>

            <div class="tiers-grid">
              @for (tier of rewardTiers; track tier.tier) {
                <div class="tier-card"
                     [class.next]="tier.tier === 1">
                  <div class="tier-icon">{{ tier.icon }}</div>
                  <div class="tier-content">
                    <span class="tier-name">Nivel {{ tier.tier }}</span>
                    <span class="tier-reward">{{ tier.reward }}</span>
                    <span class="tier-requirement">{{ tier.referralsRequired }} referido{{ tier.referralsRequired > 1 ? 's' : '' }}</span>
                  </div>
                  @if (tier.tier === 1) {
                    <span class="tier-badge next">Proximo</span>
                  } @else {
                    <span class="tier-badge locked">ğŸ”’</span>
                  }
                </div>
              }
            </div>
          </section>
        }

        <!-- STATE 2: Has Referrals - Stats & Milestones Focus -->
        @if (hasReferrals) {
          <!-- Compact Welcome -->
          <section class="welcome-section compact">
            <div class="welcome-badge">
              <span class="badge-icon">{{ currentTier?.icon || 'ğŸŒŸ' }}</span>
              <span class="badge-text">{{ currentTier ? 'JAIGENT Nivel ' + currentTier.tier : 'JAIGENT' }}</span>
            </div>
            <h1>Segui asi, {{ userFirstName }}!</h1>
          </section>

          <!-- Stats Grid - MAIN FOCUS -->
          <section class="stats-section primary">
            <div class="stats-grid large">
              <div class="stat-card referrals featured">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                  <span class="stat-value">{{ successfulReferralCount }}</span>
                  <span class="stat-label">Referidos exitosos</span>
                </div>
              </div>

              <div class="stat-card earnings featured">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-content">
                  <span class="stat-value">{{ currentDiscountPercent }}%</span>
                  <span class="stat-label">Descuento actual</span>
                </div>
              </div>
            </div>
          </section>

          <!-- Progress to Next Tier - MILESTONES -->
          @if (nextTier) {
            <section class="progress-section primary">
              <div class="progress-card">
                <div class="progress-header">
                  <div class="progress-title">
                    <span class="progress-icon">ğŸš€</span>
                    <span>Progreso al siguiente nivel</span>
                  </div>
                  <div class="progress-target">
                    <span>{{ nextTier.icon }} {{ nextTier.reward }}</span>
                  </div>
                </div>

                <div class="progress-bar-container">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="progressToNextTier"></div>
                  </div>
                  <span class="progress-text">{{ successfulReferralCount }}/{{ nextTier.referralsRequired }} referidos</span>
                </div>

                <div class="progress-hint">
                  <span>Te faltan solo <strong>{{ referralsToNextTier }}</strong> referidos para desbloquear {{ nextTier.reward }}!</span>
                </div>
              </div>
            </section>
          }

          <!-- Reward Tiers - MILESTONES -->
          <section class="tiers-section">
            <div class="section-header">
              <h2>ğŸ† Niveles de Descuento</h2>
              <p>Tu progreso hacia las mejores recompensas</p>
            </div>

            <div class="tiers-grid">
              @for (tier of rewardTiers; track tier.tier) {
                <div class="tier-card"
                     [class.unlocked]="isTierUnlocked(tier)"
                     [class.current]="isTierCurrent(tier)"
                     [class.next]="isTierNext(tier)">
                  <div class="tier-icon">{{ tier.icon }}</div>
                  <div class="tier-content">
                    <span class="tier-name">Nivel {{ tier.tier }}</span>
                    <span class="tier-reward">{{ tier.reward }}</span>
                    <span class="tier-requirement">{{ tier.referralsRequired }} referido{{ tier.referralsRequired > 1 ? 's' : '' }}</span>
                  </div>
                  @if (isTierUnlocked(tier)) {
                    <span class="tier-badge unlocked">âœ“ Desbloqueado</span>
                  } @else if (isTierNext(tier)) {
                    <span class="tier-badge next">Siguiente</span>
                  } @else {
                    <span class="tier-badge locked">ğŸ”’</span>
                  }
                </div>
              }
            </div>
          </section>

          <!-- Leaderboard Section -->
          @if (leaderboard.length > 0) {
            <section class="leaderboard-section">
              <div class="section-header">
                <div class="section-title-row">
                  <h2>ğŸ… Top Referidores</h2>
                  <button class="btn-view-leaderboard" (click)="goToLeaderboard()">
                    <span>Ver Arena</span>
                    <span class="arrow">â†’</span>
                  </button>
                </div>
                <p>Los JAIGENTs mas activos de esta temporada</p>
              </div>

              <div class="leaderboard-list">
                @for (entry of leaderboard.slice(0, 5); track entry.userId) {
                  <div class="leaderboard-item" [class.current-user]="isCurrentUser(entry)">
                    <div class="leaderboard-rank" [class.gold]="entry.rank === 1" [class.silver]="entry.rank === 2" [class.bronze]="entry.rank === 3">
                      {{ getRankIcon(entry.rank) }}
                    </div>
                    <div class="leaderboard-info">
                      <span class="leaderboard-name">
                        {{ entry.displayName }}
                        @if (isCurrentUser(entry)) {
                          <span class="you-badge">(Tu)</span>
                        }
                      </span>
                      <span class="leaderboard-tier">Nivel {{ entry.currentTier }}</span>
                    </div>
                    <div class="leaderboard-count">
                      <span class="count-value">{{ entry.successfulReferrals }}</span>
                      <span class="count-label">referidos</span>
                    </div>
                  </div>
                }
              </div>

              <!-- View Full Leaderboard Button -->
              <button class="btn-full-leaderboard" (click)="goToLeaderboard()">
                <span class="btn-icon">ğŸ†</span>
                <span class="btn-text">Ver Leaderboard Completo</span>
                <span class="btn-arrow">â†’</span>
              </button>
            </section>
          }

          <!-- Code Card - Compact for active users -->
          <section class="code-section compact">
            <div class="code-card compact">
              <div class="code-row">
                <div class="code-info">
                  <span class="code-label-sm">Tu codigo</span>
                  <span class="code-text-sm">{{ codeData!.code }}</span>
                </div>
                <div class="code-actions-compact">
                  <button class="btn-copy-sm" (click)="copyCode()">
                    @if (codeCopied) {
                      <span>âœ“</span>
                    } @else {
                      <span>ğŸ“‹</span>
                    }
                  </button>
                  <button class="btn-share-sm" (click)="shareViaWhatsApp()">
                    <span>ğŸ“±</span>
                  </button>
                </div>
              </div>
            </div>
          </section>

          <!-- Recent Referrals - At the bottom -->
          <section class="referrals-section secondary">
            <div class="section-header">
              <h2>ğŸ‘¥ Tus Referidos Recientes</h2>
            </div>

            <div class="referrals-list">
              @for (referral of referrals.slice().reverse().slice(0, 5); track referral.id) {
                <div class="referral-item">
                  <div class="referral-avatar">{{ referral.referredUser.firstName.charAt(0) || '?' }}</div>
                  <div class="referral-info">
                    <span class="referral-name">{{ referral.referredUser.firstName || 'Usuario' }} {{ referral.referredUser.lastName.charAt(0) || '' }}{{ referral.referredUser.lastName ? '.' : '' }}</span>
                    <span class="referral-date">{{ formatDate(referral.createdAt) }}</span>
                  </div>
                  <div class="referral-status" [class]="referral.status">
                    <span class="status-badge" [class]="referral.status">
                      {{ getStatusLabel(referral.status) }}
                    </span>
                  </div>
                </div>
              }
            </div>
          </section>
        }

        <!-- Footer -->
        <footer class="referral-footer">
          <div class="footer-content">
            <span>Tenes dudas sobre el programa?</span>
            <button class="btn-support" (click)="goToTaxMode()">
              <span>ğŸ’¬</span>
              <span>Contactar soporte</span>
            </button>
          </div>
        </footer>
      </main>
    }
  </div>
}
