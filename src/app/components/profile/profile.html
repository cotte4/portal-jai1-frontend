<div class="profile-page">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="loader"></div>
      <span>Cargando perfil...</span>
    </div>
  } @else {
    <!-- Member Card -->
    <div class="member-card">
      <div class="card-header">
        <div class="header-pattern"></div>
        <div class="member-badge">
          <span>üèÜ</span>
          <span>Miembro JAI1</span>
        </div>
        
        <!-- Profile Picture -->
        <div class="profile-picture-container" [class.editing]="isEditing" [class.has-changes]="hasPendingPictureChange">
          <div class="profile-picture" [class.clickable]="isEditing" (click)="isEditing && triggerFileInput()">
            @if (isEditing ? pendingProfilePicture : profilePicture) {
              <img [src]="isEditing ? pendingProfilePicture : profilePicture" alt="Foto de perfil" />
            } @else {
              <div class="avatar-placeholder">
                <span class="avatar-initials">{{ userInitials }}</span>
              </div>
            }
            @if (isEditing) {
              <div class="picture-overlay">
                <span class="camera-icon">üì∑</span>
              </div>
            }
          </div>
          <input
            type="file"
            id="profilePictureInput"
            accept="image/*"
            (change)="onFileSelected($event)"
            hidden
          />
          @if (isEditing && pendingProfilePicture) {
            <button class="btn-remove-picture" (click)="removeProfilePicture(); $event.stopPropagation()">‚úï</button>
          }
          @if (hasPendingPictureChange) {
            <div class="picture-changed-indicator">Cambios pendientes</div>
          }
        </div>
      </div>

      <div class="card-body">
        <h1 class="user-name">{{ userName || 'Usuario' }}</h1>
        <p class="member-since">{{ formatMemberSince() }}</p>
        
        @if (dni) {
          <p class="user-dni">DNI: {{ maskDNI(dni) }}</p>
        }
        
        <div class="verification-badge" [class.verified]="isVerified" [class.loading]="!profileDataLoaded">
          @if (!profileDataLoaded) {
            <span class="badge-icon spinner-small"></span>
            <span>Verificando...</span>
          } @else if (isVerified) {
            <span class="badge-icon">‚úì</span>
            <span>Identidad validada</span>
          } @else {
            <span class="badge-icon">‚è≥</span>
            <span>Complet√° tu perfil</span>
          }
        </div>
      </div>
    </div>

    <!-- Messages -->
    @if (errorMessage) {
      <div class="alert error">
        <span>‚ö†Ô∏è</span>
        <span>{{ errorMessage }}</span>
      </div>
    }
    @if (successMessage) {
      <div class="alert success">
        <span>‚úì</span>
        <span>{{ successMessage }}</span>
      </div>
    }

    <!-- Personal Data Section -->
    <div class="info-section">
      <div class="section-header">
        <h2>Mis datos personales</h2>
        <button class="btn-edit" (click)="toggleEdit()">
          @if (isEditing) {
            <span>Cancelar</span>
          } @else {
            <span>‚úèÔ∏è Editar</span>
          }
        </button>
      </div>

      @if (isEditing) {
        <!-- Edit Mode -->
        <div class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre</label>
              <input type="text" [(ngModel)]="editForm.firstName" placeholder="Tu nombre" />
            </div>
            <div class="form-group">
              <label>Apellido</label>
              <input type="text" [(ngModel)]="editForm.lastName" placeholder="Tu apellido" />
            </div>
          </div>
          
          <div class="form-group">
            <label>Tel√©fono / Celular</label>
            <input type="tel" [(ngModel)]="editForm.phone" placeholder="+54 9 XXX XXX XXXX" />
          </div>

          <div class="form-group">
            <label>Fecha de nacimiento</label>
            <input type="date" [(ngModel)]="editForm.dateOfBirth" />
          </div>

          <button class="btn-save" (click)="saveChanges()" [disabled]="isSaving">
            @if (isSaving) {
              <span class="spinner"></span>
              <span>Guardando...</span>
            } @else {
              <span>Guardar cambios</span>
            }
          </button>
        </div>
      } @else {
        <!-- View Mode -->
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Correo electr√≥nico</span>
            <span class="info-value">{{ userEmail }}</span>
          </div>
        </div>
        
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Celular</span>
            <span class="info-value">{{ userPhone || 'No especificado' }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Address Section -->
    <div class="info-section">
      <div class="section-header">
        <h2>Domicilio actual</h2>
      </div>

      @if (isEditing) {
        <!-- Edit Address -->
        <div class="edit-form">
          <div class="form-group">
            <label>Direcci√≥n</label>
            <input type="text" [(ngModel)]="editForm.street" placeholder="Calle y n√∫mero" />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Ciudad</label>
              <input type="text" [(ngModel)]="editForm.city" placeholder="Ciudad" />
            </div>
            <div class="form-group">
              <label>Estado</label>
              <input type="text" [(ngModel)]="editForm.state" placeholder="Estado" />
            </div>
          </div>

          <div class="form-group">
            <label>C√≥digo postal</label>
            <input type="text" [(ngModel)]="editForm.zip" placeholder="ZIP Code" />
          </div>
        </div>
      } @else {
        <div class="info-card address-card">
          @if (address.street) {
            <div class="address-icon">üìç</div>
            <div class="address-content">
              <span class="address-street">{{ address.street }}</span>
              <span class="address-location">{{ address.city }}, {{ address.state }}, Estados Unidos</span>
              @if (address.zip) {
                <span class="address-zip">ZIP: {{ address.zip }}</span>
              }
            </div>
          } @else {
            <div class="empty-address">
              <span class="empty-icon">üè†</span>
              <span>No has agregado tu domicilio</span>
              <button class="btn-add-address" (click)="toggleEdit()">Agregar direcci√≥n</button>
            </div>
          }
        </div>
      }
    </div>

    <!-- Account Info Section -->
    <div class="info-section">
      <div class="section-header">
        <h2>Mi cuenta</h2>
      </div>

      <div class="info-card">
        <div class="info-row">
          <span class="info-label">Fecha de nacimiento</span>
          <span class="info-value">{{ formatDate(dateOfBirth) }}</span>
        </div>
      </div>

      <div class="info-card">
        <div class="info-row">
          <span class="info-label">Estado de verificaci√≥n</span>
          <span class="info-value status" [class.verified]="isVerified">
            {{ isVerified ? 'Verificado ‚úì' : 'Pendiente' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button class="action-btn" (click)="goBack()">
        <span class="action-icon">üè†</span>
        <span>Ir al Inicio</span>
      </button>
      <button class="action-btn" routerLink="/tax-form">
        <span class="action-icon">üìù</span>
        <span>Mi Declaraci√≥n</span>
      </button>
      <button class="action-btn" routerLink="/documents">
        <span class="action-icon">üìÅ</span>
        <span>Documentos</span>
      </button>
    </div>
  }
</div>
