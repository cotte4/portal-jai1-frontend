<div class="profile-page">
  <!-- Skeleton Loading State -->
  @if (isLoading) {
    <div class="profile-skeleton">
      <!-- Skeleton: Member Card -->
      <div class="member-card skeleton-card">
        <div class="card-header">
          <div class="header-pattern"></div>
          <div class="profile-picture-container">
            <div class="skeleton skeleton-avatar"></div>
          </div>
        </div>
        <div class="card-body" style="padding-top: 60px;">
          <div class="skeleton skeleton-title" style="width: 180px; height: 28px; margin: 0 auto 12px;"></div>
          <div class="skeleton skeleton-text" style="width: 140px; height: 14px; margin: 0 auto 16px;"></div>
          <div class="skeleton skeleton-rect" style="width: 120px; height: 32px; margin: 0 auto; border-radius: 20px;"></div>
        </div>
      </div>

      <!-- Skeleton: Info Sections -->
      <div class="info-section skeleton-card">
        <div class="skeleton-row" style="margin-bottom: 20px;">
          <div class="skeleton skeleton-circle" style="width: 24px; height: 24px;"></div>
          <div class="skeleton skeleton-title" style="width: 160px; height: 20px;"></div>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <div class="skeleton skeleton-text" style="width: 60px; height: 12px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 140px; height: 16px;"></div>
          </div>
          <div class="info-item">
            <div class="skeleton skeleton-text" style="width: 60px; height: 12px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 120px; height: 16px;"></div>
          </div>
          <div class="info-item">
            <div class="skeleton skeleton-text" style="width: 60px; height: 12px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 180px; height: 16px;"></div>
          </div>
          <div class="info-item">
            <div class="skeleton skeleton-text" style="width: 60px; height: 12px; margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 100px; height: 16px;"></div>
          </div>
        </div>
      </div>

      <!-- Skeleton: Another Section -->
      <div class="info-section skeleton-card">
        <div class="skeleton-row" style="margin-bottom: 20px;">
          <div class="skeleton skeleton-circle" style="width: 24px; height: 24px;"></div>
          <div class="skeleton skeleton-title" style="width: 140px; height: 20px;"></div>
        </div>
        <div class="skeleton skeleton-rect" style="width: 100%; height: 60px;"></div>
      </div>
    </div>
  } @else {
    <!-- Member Card -->
    <div class="member-card" #memberCard>
      <div class="card-header">
        <div class="header-pattern"></div>
        <div class="member-badge">
          <span>üèÜ</span>
          <span>Miembro JAI1</span>
        </div>
        
        <!-- Profile Picture -->
        <div class="profile-picture-container" [class.editing]="isEditing" [class.has-changes]="hasPendingPictureChange">
          <div class="profile-picture" [class.clickable]="isEditing" (click)="isEditing && triggerFileInput()">
            @if (isEditing ? pendingProfilePicture : profilePicture) {
              <img [src]="isEditing ? pendingProfilePicture : profilePicture" alt="Foto de perfil" />
            } @else {
              <div class="avatar-placeholder">
                <span class="avatar-initials">{{ userInitials }}</span>
              </div>
            }
            @if (isEditing) {
              <div class="picture-overlay">
                <span class="camera-icon">üì∑</span>
              </div>
            }
          </div>
          <input
            type="file"
            id="profilePictureInput"
            accept="image/*"
            (change)="onFileSelected($event)"
            hidden
          />
          @if (isEditing && pendingProfilePicture) {
            <button class="btn-remove-picture" (click)="removeProfilePicture(); $event.stopPropagation()">‚úï</button>
          }
          @if (hasPendingPictureChange) {
            <div class="picture-changed-indicator">Cambios pendientes</div>
          }
        </div>
      </div>

      <div class="card-body">
        <h1 class="user-name">{{ userName || 'Usuario' }}</h1>
        <p class="member-since">{{ formatMemberSince() }}</p>
        
        @if (dni) {
          <p class="user-ssn">SSN: {{ maskSSN(dni) }}</p>
        }
        
        <div class="verification-badge" [class.verified]="isVerified">
          @if (isVerified) {
            <span class="badge-icon">‚úì</span>
            <span>Identidad validada</span>
          } @else {
            <span class="badge-icon">‚è≥</span>
            <span>Complet√° tu perfil</span>
          }
        </div>
      </div>
    </div>

    <!-- Messages -->
    @if (errorMessage) {
      <div class="alert error">
        <span>‚ö†Ô∏è</span>
        <span>{{ errorMessage }}</span>
      </div>
    }
    @if (successMessage) {
      <div class="alert success">
        <span>‚úì</span>
        <span>{{ successMessage }}</span>
      </div>
    }

    <!-- Personal Data Section -->
    <div class="info-section" #infoSection>
      <div class="section-header">
        <h2>Mis datos personales</h2>
        <button class="btn-edit" (click)="toggleEdit()">
          @if (isEditing) {
            <span>Cancelar</span>
          } @else {
            <span>‚úèÔ∏è Editar</span>
          }
        </button>
      </div>

      @if (isEditing) {
        <!-- Edit Mode -->
        <div class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre</label>
              <input type="text" [(ngModel)]="editForm.firstName" placeholder="Tu nombre" />
            </div>
            <div class="form-group">
              <label>Apellido</label>
              <input type="text" [(ngModel)]="editForm.lastName" placeholder="Tu apellido" />
            </div>
          </div>
          
          <div class="form-group">
            <label>Tel√©fono / Celular</label>
            <input type="tel" [(ngModel)]="editForm.phone" placeholder="+54 9 XXX XXX XXXX" />
          </div>

          <div class="form-group">
            <label>Fecha de nacimiento</label>
            <input type="date" [(ngModel)]="editForm.dateOfBirth" />
          </div>

          <button class="btn-save" (click)="saveChanges()" [disabled]="isSaving">
            @if (isSaving) {
              <span class="spinner"></span>
              <span>Guardando...</span>
            } @else {
              <span>Guardar cambios</span>
            }
          </button>
        </div>
      } @else {
        <!-- View Mode -->
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Correo electr√≥nico</span>
            <span class="info-value">{{ userEmail }}</span>
          </div>
        </div>
        
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Celular</span>
            <span class="info-value">{{ userPhone || 'No especificado' }}</span>
          </div>
        </div>

        @if (userAge) {
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Edad</span>
              <span class="info-value">{{ userAge }} a√±os</span>
            </div>
          </div>
        }
      }
    </div>

    <!-- Address Section -->
    <div class="info-section" #infoSection>
      <div class="section-header">
        <h2>Domicilio actual</h2>
      </div>

      @if (isEditing) {
        <!-- Edit Address -->
        <div class="edit-form">
          <div class="form-group">
            <label>Direcci√≥n</label>
            <input type="text" [(ngModel)]="editForm.street" placeholder="Calle y n√∫mero" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ciudad</label>
              <input type="text" [(ngModel)]="editForm.city" placeholder="Ciudad" />
            </div>
            <div class="form-group">
              <label>Estado</label>
              <input type="text" [(ngModel)]="editForm.state" placeholder="Estado" />
            </div>
          </div>

          <div class="form-group">
            <label>C√≥digo postal</label>
            <input type="text" [(ngModel)]="editForm.zip" placeholder="ZIP Code" />
          </div>
        </div>
      } @else {
        <div class="info-card address-card">
          @if (address.street) {
            <div class="address-icon">üìç</div>
            <div class="address-content">
              <span class="address-street">{{ address.street }}</span>
              <span class="address-location">{{ address.city }}, {{ address.state }}, Estados Unidos</span>
              @if (address.zip) {
                <span class="address-zip">ZIP: {{ address.zip }}</span>
              }
            </div>
          } @else {
            <div class="empty-address">
              <span class="empty-icon">üè†</span>
              <span>No has agregado tu domicilio</span>
              <button class="btn-add-address" (click)="toggleEdit()">Agregar direcci√≥n</button>
            </div>
          }
        </div>
      }
    </div>

    <!-- Sensitive Information Sections (only show if profile is verified/complete) -->
    @if (isVerified) {
      <!-- Tax Information Section -->
      <div class="info-section sensitive-section">
        <div class="section-header">
          <div class="section-title-group">
            <span class="section-icon">üîí</span>
            <h2>Informaci√≥n Fiscal</h2>
          </div>
          <button class="btn-edit" (click)="toggleSensitiveSection('tax')" [disabled]="isSavingSensitive">
            @if (editingSensitiveSection === 'tax') {
              <span>Cancelar</span>
            } @else {
              <span>‚úèÔ∏è Editar</span>
            }
          </button>
        </div>

        @if (editingSensitiveSection === 'tax') {
          <div class="edit-form sensitive-form">
            <div class="form-group">
              <label>N√∫mero de Seguro Social (SSN)</label>
              <input
                type="text"
                [value]="sensitiveForm.ssn"
                (input)="formatSSNInput($event)"
                placeholder="XXX-XX-XXXX"
                maxlength="11"
                autocomplete="off"
              />
              <span class="field-hint">Ingresa tu SSN completo para actualizarlo</span>
            </div>

            <div class="form-actions">
              <button class="btn-cancel" (click)="cancelSensitiveEdit()">Cancelar</button>
              <button class="btn-save-sensitive" (click)="prepareSensitiveSave()" [disabled]="isSavingSensitive">
                @if (isSavingSensitive) {
                  <span class="spinner"></span>
                  <span>Guardando...</span>
                } @else {
                  <span>Guardar SSN</span>
                }
              </button>
            </div>
          </div>
        } @else {
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">SSN</span>
              <span class="info-value masked-value">{{ dni || 'No especificado' }}</span>
            </div>
          </div>
        }
      </div>

      <!-- Bank Information Section -->
      <div class="info-section sensitive-section">
        <div class="section-header">
          <div class="section-title-group">
            <span class="section-icon">üè¶</span>
            <h2>Informaci√≥n Bancaria</h2>
          </div>
          <button class="btn-edit" (click)="toggleSensitiveSection('bank')" [disabled]="isSavingSensitive">
            @if (editingSensitiveSection === 'bank') {
              <span>Cancelar</span>
            } @else {
              <span>‚úèÔ∏è Editar</span>
            }
          </button>
        </div>

        @if (editingSensitiveSection === 'bank') {
          <div class="edit-form sensitive-form">
            <div class="form-group">
              <label>Nombre del Banco</label>
              <input
                type="text"
                [(ngModel)]="sensitiveForm.bankName"
                placeholder="Ej: Bank of America"
              />
            </div>

            <div class="form-group">
              <label>N√∫mero de Ruta (Routing Number)</label>
              <input
                type="text"
                [value]="sensitiveForm.bankRoutingNumber"
                (input)="formatRoutingInput($event)"
                placeholder="9 digitos"
                maxlength="9"
                autocomplete="off"
              />
              <span class="field-hint">Deja vacio para mantener el actual</span>
            </div>

            <div class="form-group">
              <label>N√∫mero de Cuenta</label>
              <input
                type="text"
                [value]="sensitiveForm.bankAccountNumber"
                (input)="formatAccountInput($event)"
                placeholder="Tu n√∫mero de cuenta"
                maxlength="17"
                autocomplete="off"
              />
              <span class="field-hint">Deja vacio para mantener el actual</span>
            </div>

            <div class="form-actions">
              <button class="btn-cancel" (click)="cancelSensitiveEdit()">Cancelar</button>
              <button class="btn-save-sensitive" (click)="prepareSensitiveSave()" [disabled]="isSavingSensitive">
                @if (isSavingSensitive) {
                  <span class="spinner"></span>
                  <span>Guardando...</span>
                } @else {
                  <span>Guardar Datos Bancarios</span>
                }
              </button>
            </div>
          </div>
        } @else {
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Banco</span>
              <span class="info-value">{{ bankInfo.name || 'No especificado' }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">N√∫mero de Ruta</span>
              <span class="info-value masked-value">{{ bankInfo.routingNumber || 'No especificado' }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">N√∫mero de Cuenta</span>
              <span class="info-value masked-value">{{ bankInfo.accountNumber || 'No especificado' }}</span>
            </div>
          </div>
        }
      </div>

      <!-- TurboTax Credentials Section -->
      <div class="info-section sensitive-section">
        <div class="section-header">
          <div class="section-title-group">
            <span class="section-icon">üìä</span>
            <h2>Credenciales TurboTax</h2>
          </div>
          <button class="btn-edit" (click)="toggleSensitiveSection('turbotax')" [disabled]="isSavingSensitive">
            @if (editingSensitiveSection === 'turbotax') {
              <span>Cancelar</span>
            } @else {
              <span>‚úèÔ∏è Editar</span>
            }
          </button>
        </div>

        @if (editingSensitiveSection === 'turbotax') {
          <div class="edit-form sensitive-form">
            <div class="form-group">
              <label>Email de TurboTax</label>
              <input
                type="email"
                [(ngModel)]="sensitiveForm.turbotaxEmail"
                placeholder="tu@email.com"
                autocomplete="off"
              />
              <span class="field-hint">Deja vacio para mantener el actual</span>
            </div>

            <div class="form-group">
              <label>Contrase√±a de TurboTax</label>
              <input
                type="password"
                [(ngModel)]="sensitiveForm.turbotaxPassword"
                placeholder="Nueva contrase√±a"
                autocomplete="new-password"
              />
              <span class="field-hint">Deja vacio para mantener la actual</span>
            </div>

            <div class="form-actions">
              <button class="btn-cancel" (click)="cancelSensitiveEdit()">Cancelar</button>
              <button class="btn-save-sensitive" (click)="prepareSensitiveSave()" [disabled]="isSavingSensitive">
                @if (isSavingSensitive) {
                  <span class="spinner"></span>
                  <span>Guardando...</span>
                } @else {
                  <span>Guardar Credenciales</span>
                }
              </button>
            </div>
          </div>
        } @else {
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Email TurboTax</span>
              <span class="info-value masked-value">{{ turbotaxEmail || 'No especificado' }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Contrase√±a TurboTax</span>
              <span class="info-value masked-value">{{ turbotaxPassword || 'No especificada' }}</span>
            </div>
          </div>
        }
      </div>
    }

    <!-- Confirmation Dialog -->
    @if (showConfirmDialog) {
      <div class="confirm-overlay" (click)="cancelConfirmDialog()">
        <div class="confirm-dialog" (click)="$event.stopPropagation()">
          <div class="confirm-icon">‚ö†Ô∏è</div>
          <h3>Confirmar cambios</h3>
          <p>Estas a punto de actualizar informaci√≥n sensible de tu perfil. Esta accion quedara registrada por seguridad.</p>
          <p class="confirm-warning">¬øEstas seguro de que deseas continuar?</p>
          <div class="confirm-actions">
            <button class="btn-confirm-cancel" (click)="cancelConfirmDialog()">Cancelar</button>
            <button class="btn-confirm-save" (click)="confirmSensitiveSave()" [disabled]="isSavingSensitive">
              @if (isSavingSensitive) {
                <span class="spinner"></span>
              } @else {
                <span>Confirmar</span>
              }
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button class="action-btn" (click)="goBack()">
        <span class="action-icon">üè†</span>
        <span>Ir al Inicio</span>
      </button>
      <button class="action-btn" routerLink="/tax-form">
        <span class="action-icon">üìù</span>
        <span>Mi Declaraci√≥n</span>
      </button>
      <button class="action-btn" routerLink="/documents">
        <span class="action-icon">üìÅ</span>
        <span>Documentos</span>
      </button>
    </div>
  }
</div>
