<div class="profile-page">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="loader"></div>
      <span>Cargando perfil...</span>
    </div>
  } @else {
    <!-- Member Card -->
    <div class="member-card">
      <div class="card-header">
        <div class="header-pattern"></div>
        <div class="member-badge">
          <span>ğŸ†</span>
          <span>Miembro JAI1</span>
        </div>
        
        <!-- Profile Picture -->
        <div class="profile-picture-container" [class.editing]="isEditing" [class.has-changes]="hasPendingPictureChange">
          <div class="profile-picture" [class.clickable]="isEditing" (click)="isEditing && triggerFileInput()">
            @if (isEditing ? pendingProfilePicture : profilePicture) {
              <img [src]="isEditing ? pendingProfilePicture : profilePicture" alt="Foto de perfil" />
            } @else {
              <div class="avatar-placeholder">
                <span class="avatar-initials">{{ userInitials }}</span>
              </div>
            }
            @if (isEditing) {
              <div class="picture-overlay">
                <span class="camera-icon">ğŸ“·</span>
              </div>
            }
          </div>
          <input
            type="file"
            id="profilePictureInput"
            accept="image/*"
            (change)="onFileSelected($event)"
            hidden
          />
          @if (isEditing && pendingProfilePicture) {
            <button class="btn-remove-picture" (click)="removeProfilePicture(); $event.stopPropagation()">âœ•</button>
          }
          @if (hasPendingPictureChange) {
            <div class="picture-changed-indicator">Cambios pendientes</div>
          }
        </div>
      </div>

      <div class="card-body">
        <h1 class="user-name">{{ userName || 'Usuario' }}</h1>
        <p class="member-since">{{ formatMemberSince() }}</p>
        
        @if (dni) {
          <p class="user-dni">DNI: {{ maskDNI(dni) }}</p>
        }
        
        <div class="verification-badge" [class.verified]="isVerified">
          @if (isVerified) {
            <span class="badge-icon">âœ“</span>
            <span>Identidad validada</span>
          } @else {
            <span class="badge-icon">â³</span>
            <span>CompletÃ¡ tu perfil</span>
          }
        </div>
      </div>
    </div>

    <!-- Messages -->
    @if (errorMessage) {
      <div class="alert error">
        <span>âš ï¸</span>
        <span>{{ errorMessage }}</span>
      </div>
    }
    @if (successMessage) {
      <div class="alert success">
        <span>âœ“</span>
        <span>{{ successMessage }}</span>
      </div>
    }

    <!-- Personal Data Section -->
    <div class="info-section">
      <div class="section-header">
        <h2>Mis datos personales</h2>
        <button class="btn-edit" (click)="toggleEdit()">
          @if (isEditing) {
            <span>Cancelar</span>
          } @else {
            <span>âœï¸ Editar</span>
          }
        </button>
      </div>

      @if (isEditing) {
        <!-- Edit Mode -->
        <div class="edit-form">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre</label>
              <input type="text" [(ngModel)]="editForm.firstName" placeholder="Tu nombre" />
            </div>
            <div class="form-group">
              <label>Apellido</label>
              <input type="text" [(ngModel)]="editForm.lastName" placeholder="Tu apellido" />
            </div>
          </div>
          
          <div class="form-group">
            <label>TelÃ©fono / Celular</label>
            <input type="tel" [(ngModel)]="editForm.phone" placeholder="+54 9 XXX XXX XXXX" />
          </div>

          <div class="form-group">
            <label>Fecha de nacimiento</label>
            <input type="date" [(ngModel)]="editForm.dateOfBirth" />
          </div>

          <button class="btn-save" (click)="saveChanges()" [disabled]="isSaving">
            @if (isSaving) {
              <span class="spinner"></span>
              <span>Guardando...</span>
            } @else {
              <span>Guardar cambios</span>
            }
          </button>
        </div>
      } @else {
        <!-- View Mode -->
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Correo electrÃ³nico</span>
            <span class="info-value">{{ userEmail }}</span>
          </div>
        </div>
        
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Celular</span>
            <span class="info-value">{{ userPhone || 'No especificado' }}</span>
          </div>
        </div>

        @if (userAge) {
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">Edad</span>
              <span class="info-value">{{ userAge }} aÃ±os</span>
            </div>
          </div>
        }
      }
    </div>

    <!-- Address Section -->
    <div class="info-section">
      <div class="section-header">
        <h2>Domicilio actual</h2>
      </div>

      @if (isEditing) {
        <!-- Edit Address -->
        <div class="edit-form">
          <div class="form-group">
            <label>DirecciÃ³n</label>
            <input type="text" [(ngModel)]="editForm.street" placeholder="Calle y nÃºmero" />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Ciudad</label>
              <input type="text" [(ngModel)]="editForm.city" placeholder="Ciudad" />
            </div>
            <div class="form-group">
              <label>Estado</label>
              <input type="text" [(ngModel)]="editForm.state" placeholder="Estado" />
            </div>
          </div>

          <div class="form-group">
            <label>CÃ³digo postal</label>
            <input type="text" [(ngModel)]="editForm.zip" placeholder="ZIP Code" />
          </div>
        </div>
      } @else {
        <div class="info-card address-card">
          @if (address.street) {
            <div class="address-icon">ğŸ“</div>
            <div class="address-content">
              <span class="address-street">{{ address.street }}</span>
              <span class="address-location">{{ address.city }}, {{ address.state }}, Estados Unidos</span>
              @if (address.zip) {
                <span class="address-zip">ZIP: {{ address.zip }}</span>
              }
            </div>
          } @else {
            <div class="empty-address">
              <span class="empty-icon">ğŸ </span>
              <span>No has agregado tu domicilio</span>
              <button class="btn-add-address" (click)="toggleEdit()">Agregar direcciÃ³n</button>
            </div>
          }
        </div>
      }
    </div>

    <!-- Security Section - Change Password -->
    <div class="info-section">
      <div class="section-header">
        <h2>Seguridad</h2>
        <button class="btn-edit" (click)="toggleChangePassword()">
          @if (isChangingPassword) {
            <span>Cancelar</span>
          } @else {
            <span>ğŸ”’ Cambiar contraseÃ±a</span>
          }
        </button>
      </div>

      @if (isChangingPassword) {
        <div class="edit-form">
          @if (passwordError) {
            <div class="form-error">
              <span>âš ï¸ {{ passwordError }}</span>
            </div>
          }

          <div class="form-group">
            <label>ContraseÃ±a actual</label>
            <div class="password-input-wrapper">
              <input
                [type]="showCurrentPassword ? 'text' : 'password'"
                [(ngModel)]="passwordForm.currentPassword"
                placeholder="Tu contraseÃ±a actual"
                autocomplete="current-password"
              />
              <button type="button" class="btn-toggle-password" (click)="toggleCurrentPasswordVisibility()">
                {{ showCurrentPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸' }}
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Nueva contraseÃ±a</label>
            <div class="password-input-wrapper">
              <input
                [type]="showNewPassword ? 'text' : 'password'"
                [(ngModel)]="passwordForm.newPassword"
                placeholder="MÃ­nimo 8 caracteres"
                autocomplete="new-password"
              />
              <button type="button" class="btn-toggle-password" (click)="toggleNewPasswordVisibility()">
                {{ showNewPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸' }}
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Confirmar nueva contraseÃ±a</label>
            <div class="password-input-wrapper">
              <input
                [type]="showConfirmPassword ? 'text' : 'password'"
                [(ngModel)]="passwordForm.confirmPassword"
                placeholder="Repite la nueva contraseÃ±a"
                autocomplete="new-password"
              />
              <button type="button" class="btn-toggle-password" (click)="toggleConfirmPasswordVisibility()">
                {{ showConfirmPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸' }}
              </button>
            </div>
          </div>

          <button class="btn-save" (click)="changePassword()" [disabled]="isPasswordSaving">
            @if (isPasswordSaving) {
              <span class="spinner"></span>
              <span>Guardando...</span>
            } @else {
              <span>Cambiar contraseÃ±a</span>
            }
          </button>

          <p class="security-note">
            Al cambiar tu contraseÃ±a, se cerrarÃ¡ tu sesiÃ³n en todos los dispositivos.
          </p>
        </div>
      } @else {
        <div class="info-card">
          <div class="info-row">
            <span class="info-label">ContraseÃ±a</span>
            <span class="info-value">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
          </div>
        </div>
      }
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button class="action-btn" (click)="goBack()">
        <span class="action-icon">ğŸ </span>
        <span>Ir al Inicio</span>
      </button>
      <button class="action-btn" routerLink="/tax-form">
        <span class="action-icon">ğŸ“</span>
        <span>Mi DeclaraciÃ³n</span>
      </button>
      <button class="action-btn" routerLink="/documents">
        <span class="action-icon">ğŸ“</span>
        <span>Documentos</span>
      </button>
    </div>
  }
</div>
