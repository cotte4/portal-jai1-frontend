<!-- Skeleton Loading State -->
@if (!hasLoaded) {
  <div class="dashboard-content skeleton-state">
    <!-- Skeleton: Refund Card -->
    <div class="refund-section">
      <div class="refund-card skeleton-card">
        <div class="skeleton-row">
          <div class="skeleton skeleton-circle" style="width: 32px; height: 32px;"></div>
          <div class="skeleton skeleton-text" style="width: 140px; height: 16px;"></div>
        </div>
        <div class="skeleton skeleton-title" style="width: 180px; height: 48px; margin-top: 16px;"></div>
        <div class="skeleton skeleton-text" style="width: 160px; height: 14px; margin-top: 12px;"></div>
      </div>
    </div>

    <!-- Skeleton: Progress Section -->
    <div class="progress-section skeleton-card">
      <div class="skeleton-row" style="justify-content: space-between;">
        <div class="skeleton skeleton-text" style="width: 100px; height: 16px;"></div>
        <div class="skeleton skeleton-text" style="width: 120px; height: 14px;"></div>
      </div>
      <div class="skeleton skeleton-rect" style="width: 100%; height: 8px; margin-top: 16px; border-radius: 4px;"></div>
    </div>

    <!-- Skeleton: Bento Grid -->
    <div class="bento-grid">
      <div class="bento-card skeleton-card">
        <div class="skeleton skeleton-circle" style="width: 48px; height: 48px; margin-bottom: 16px;"></div>
        <div class="skeleton skeleton-title" style="width: 80%; height: 20px; margin-bottom: 12px;"></div>
        <div class="skeleton skeleton-text" style="width: 100%; height: 14px; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-text" style="width: 70%; height: 14px; margin-bottom: 20px;"></div>
        <div class="skeleton skeleton-rect" style="width: 100%; height: 44px;"></div>
      </div>
      <div class="bento-card skeleton-card">
        <div class="skeleton skeleton-circle" style="width: 48px; height: 48px; margin-bottom: 16px;"></div>
        <div class="skeleton skeleton-title" style="width: 80%; height: 20px; margin-bottom: 12px;"></div>
        <div class="skeleton skeleton-text" style="width: 100%; height: 14px; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-text" style="width: 70%; height: 14px; margin-bottom: 20px;"></div>
        <div class="skeleton skeleton-rect" style="width: 100%; height: 44px;"></div>
      </div>
      <div class="bento-card skeleton-card">
        <div class="skeleton skeleton-circle" style="width: 48px; height: 48px; margin-bottom: 16px;"></div>
        <div class="skeleton skeleton-title" style="width: 80%; height: 20px; margin-bottom: 12px;"></div>
        <div class="skeleton skeleton-text" style="width: 100%; height: 14px; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-text" style="width: 70%; height: 14px; margin-bottom: 20px;"></div>
        <div class="skeleton skeleton-rect" style="width: 100%; height: 44px;"></div>
      </div>
    </div>
  </div>
}

<!-- Dashboard Content -->
@if (hasLoaded) {
<div class="dashboard-content">
  <!-- Problem Alert Banner -->
  @if (hasProblem) {
    <div class="problem-alert-banner" (click)="navigateTo('/messages')">
      <div class="problem-alert-icon">⚠️</div>
      <div class="problem-alert-content">
        <span class="problem-alert-title">Necesitamos tu ayuda</span>
        <span class="problem-alert-text">Hay un inconveniente con tu trámite. Por favor contacta a soporte para resolverlo.</span>
      </div>
      <button class="problem-alert-btn">Contactar Soporte →</button>
    </div>
  }

  <!-- Refund Card - Row 1 (Top priority) -->
  <div class="refund-section" #welcomeSection>
    <div class="refund-card">
      @if (actualRefund) {
        <!-- Highest priority: Show actual/final refund from IRS -->
        <div class="refund-badge">
          <svg class="refund-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <span>Reembolso Final</span>
        </div>
        <div class="refund-amount" #refundValue>{{ actualRefundDisplay }}</div>
        <div class="refund-calculated">
          <svg class="check-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Confirmado por el IRS
        </div>
      } @else if (hasCalculatorResult) {
        <!-- Second priority: Show estimated refund from calculator -->
        <div class="refund-badge">
          <svg class="refund-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>Reembolso Estimado</span>
        </div>
        <div class="refund-amount" #refundValue>{{ estimatedRefundDisplay }}</div>
        <div class="refund-calculated">
          <svg class="check-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Calculado con tu W2
        </div>
      } @else {
        <!-- Fallback: Prompt user to upload W2 -->
        <div class="refund-badge">
          <svg class="refund-badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>Reembolso Estimado</span>
        </div>
        <div class="refund-not-calculated">
          <svg class="doc-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          <span>Sube tu W2 para calcular</span>
        </div>
        <button class="btn-calculate-cta" (click)="navigateTo('/tax-calculator')">
          <span>Calcular mi reembolso</span>
          <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </button>
      }
    </div>
  </div>

  <!-- Progress Bar - Row 2 -->
  @if (!allStepsComplete) {
    <div class="progress-section">
      <div class="progress-header">
        <span class="progress-title">Tu progreso</span>
        <span class="progress-percent">{{ stepsCompletedCount }}/3 completados</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-track">
          <div class="progress-bar-fill" [style.width.%]="(stepsCompletedCount / 3) * 100"></div>
        </div>
        <div class="progress-steps-indicators">
          <div class="progress-step-dot" [class.completed]="isStep1Complete" [class.active]="!isStep1Complete">
            @if (isStep1Complete) { <span class="dot-check">✓</span> }
          </div>
          <div class="progress-step-dot" [class.completed]="isStep2Complete" [class.active]="isStep1Complete && !isStep2Complete">
            @if (isStep2Complete) { <span class="dot-check">✓</span> }
          </div>
          <div class="progress-step-dot" [class.completed]="isStep3Complete" [class.active]="isStep1Complete && isStep2Complete && !isStep3Complete">
            @if (isStep3Complete) { <span class="dot-check">✓</span> }
          </div>
        </div>
      </div>
    </div>
  } @else {
    <!-- All Steps Complete - Success State -->
    <div class="progress-section complete">
      <div class="progress-complete-row">
        <div class="progress-complete-check">✓</div>
        <div class="progress-complete-text">
          <span class="progress-complete-title">Preparación completa</span>
          <span class="progress-complete-subtitle">Todos los pasos completados correctamente</span>
        </div>
        <div class="progress-complete-pill">100%</div>
      </div>
    </div>
  }

  <!-- Steps Section - Row 3 (only show if not all steps complete) -->
  @if (!allStepsComplete) {
    <div class="steps-list">
      <!-- Step 1: Completá tu declaración -->
      <div class="step-card" #bentoCard
           [class.completed]="isStep1Complete"
           [class.attention]="!isStep1Complete && !isStep2Complete && !isStep3Complete">
        @if (isStep1Complete) {
          <div class="step-completed-row">
            <div class="step-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>
            <span class="step-completed-text">Declaración completada</span>
          </div>
        } @else {
          <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </div>
          </div>
          <div class="step-body">
            <h3 class="step-title">Completá tu declaración</h3>
            <p class="step-desc">Llená el formulario con tus datos personales y tributarios para iniciar tu trámite</p>
          </div>
          <button class="step-btn" (click)="navigateTo('/tax-form')">
            Completar
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        }
      </div>

      <!-- Step 2: Subí tu documento W2 -->
      <div class="step-card" #bentoCard
           [class.completed]="isStep2Complete"
           [class.attention]="isStep1Complete && !isStep2Complete && !isStep3Complete">
        @if (isStep2Complete) {
          <div class="step-completed-row">
            <div class="step-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>
            <span class="step-completed-text">Documento W2 subido</span>
          </div>
        } @else {
          <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
            </div>
          </div>
          <div class="step-body">
            <h3 class="step-title">Subí tu documento W2</h3>
            <p class="step-desc">Cargá tu formulario W2 que te dio tu empleador para calcular tu reembolso</p>
          </div>
          <button class="step-btn" (click)="navigateTo('/documents')">
            Subir W2
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        }
      </div>

      <!-- Step 3: Subí tu comprobante de pago -->
      <div class="step-card" #bentoCard
           [class.completed]="isStep3Complete"
           [class.attention]="isStep1Complete && isStep2Complete && !isStep3Complete">
        @if (isStep3Complete) {
          <div class="step-completed-row">
            <div class="step-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>
            <span class="step-completed-text">Comprobante subido</span>
          </div>
        } @else {
          <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
              </svg>
            </div>
          </div>
          <div class="step-body">
            <h3 class="step-title">Subí tu comprobante de pago</h3>
            <p class="step-desc">Adjuntá el comprobante del pago inicial para continuar con el proceso</p>
          </div>
          <button class="step-btn" (click)="navigateTo('/documents')">
            Subir comprobante
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        }
      </div>
    </div>
  }

  <!-- IRS Tracking Card - Shows current step from seguimiento system -->
  @if (showIRSProgress) {
    <div class="irs-tracking-card" (click)="navigateTo('/tax-tracking')"
         [class.completed]="isTrackingComplete"
         [class.rejected]="currentStepInfo.status === 'rejected'">
      <div class="tracking-card-content">
        <div class="tracking-card-left">
          <div class="tracking-step-icon"
               [class.active]="currentStepInfo.status === 'active'"
               [class.completed]="currentStepInfo.status === 'completed'"
               [class.rejected]="currentStepInfo.status === 'rejected'">
            <span>{{ currentStepInfo.icon }}</span>
          </div>
          <div class="tracking-step-info">
            <div class="tracking-step-label">
              <span class="step-counter">Paso {{ currentStepInfo.stepNumber }} de {{ currentStepInfo.totalSteps }}</span>
              @if (currentStepInfo.track === 'federal') {
                <span class="track-badge federal">Federal</span>
              } @else if (currentStepInfo.track === 'estatal') {
                <span class="track-badge estatal">Estatal</span>
              } @else if (currentStepInfo.track === 'both') {
                <span class="track-badge both">Federal + Estatal</span>
              }
            </div>
            <h3 class="tracking-step-title">{{ currentStepInfo.title }}</h3>
            <p class="tracking-step-desc">{{ currentStepInfo.description }}</p>
          </div>
        </div>
        <div class="tracking-card-right">
          <div class="tracking-progress-ring">
            <svg viewBox="0 0 36 36" class="circular-progress">
              <path class="circle-bg"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
              />
              <path class="circle-progress"
                [class.rejected]="currentStepInfo.status === 'rejected'"
                [attr.stroke-dasharray]="overallProgressPercent + ', 100'"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
              />
            </svg>
            <span class="progress-text">{{ overallProgressPercent }}%</span>
          </div>
          <span class="view-details">Ver detalles <span class="arrow">-></span></span>
        </div>
      </div>
    </div>
  }

  <!-- Help Footer -->
  <div class="help-footer">
    <div class="help-icon-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
    </div>
    <div class="help-text">
      <span class="help-title">¿Necesitas ayuda?</span>
      <span class="help-desc">Nuestro equipo está listo para asistirte</span>
    </div>
    <button class="btn-help" (click)="navigateTo('/messages')">Contactar soporte</button>
  </div>
</div>
}
