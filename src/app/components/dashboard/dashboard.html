<!-- Loading Screen -->
@if (!hasLoaded) {
  <div class="dashboard-loading">
    <div class="loading-spinner"></div>
    <p>Cargando tu dashboard...</p>
  </div>
}

<!-- Dashboard Content -->
@if (hasLoaded) {
<div class="dashboard-content">
  <!-- Welcome Section -->
  <div class="welcome-section">
    <div class="welcome-content">
      <h1 class="welcome-title">Bienvenido a tu portal de taxes</h1>
      <p class="welcome-subtitle">Segu√≠ estos pasos para completar tu declaraci√≥n y recibir tu reembolso</p>
    </div>
    <div class="welcome-refund">
      @if (hasCalculatorResult) {
        <span class="refund-label-small">Reembolso estimado</span>
        <span class="refund-value">{{ estimatedRefundDisplay }}</span>
      } @else {
        <button class="btn-estimate" (click)="navigateTo('/tax-calculator')">
          Calcular reembolso ‚Üí
        </button>
      }
    </div>
  </div>

  <!-- Steps Section -->
  <div class="steps-card">
    <div class="steps-header">
      <div class="steps-title-section">
        <h2 class="steps-title">Pasos para enviar tu declaraci√≥n</h2>
        <p class="steps-subtitle">Complet√° cada paso en orden para procesar tu declaraci√≥n</p>
      </div>
      <div class="steps-progress">
        <div class="progress-circle">
          <svg viewBox="0 0 36 36" class="circular-progress">
            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
            <path class="circle-fill" [style.stroke-dasharray]="userProgressPercent + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
          </svg>
          <span class="progress-percent">{{ userProgressPercent }}%</span>
        </div>
      </div>
    </div>

    <div class="progress-bar-horizontal">
      <div class="progress-fill-horizontal" [style.width.%]="userProgressPercent"></div>
    </div>

    <div class="steps-list">
      <!-- Paso 1: Completar declaraci√≥n -->
      <div class="step-item" [class.done]="isProfileComplete" [class.active]="!isProfileComplete">
        <div class="step-number-container">
          <div class="step-number">
            @if (isProfileComplete) {
              <span class="step-check-icon">‚úì</span>
            } @else {
              <span>1</span>
            }
          </div>
          <div class="step-connector" [class.done]="isProfileComplete"></div>
        </div>
        <div class="step-content">
          <div class="step-info">
            <h3 class="step-name">Paso 1: Complet√° tu declaraci√≥n</h3>
            <p class="step-description">Ingres√° tu informaci√≥n personal y datos fiscales</p>
          </div>
          <div class="step-action">
            @if (isProfileComplete) {
              <span class="step-status done">Completado</span>
            } @else {
              <button class="btn-step-action primary" (click)="navigateTo('/tax-form')">
                Completar declaraci√≥n
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Paso 2: Enviar formulario -->
      <div class="step-item" [class.done]="isFormSent" [class.active]="isProfileComplete && !isFormSent" [class.locked]="!isProfileComplete">
        <div class="step-number-container">
          <div class="step-number">
            @if (isFormSent) {
              <span class="step-check-icon">‚úì</span>
            } @else {
              <span>2</span>
            }
          </div>
          <div class="step-connector" [class.done]="isFormSent"></div>
        </div>
        <div class="step-content">
          <div class="step-info">
            <h3 class="step-name">Paso 2: Envi√° tu formulario</h3>
            <p class="step-description">Revis√° y envi√° tu declaraci√≥n para procesamiento</p>
          </div>
          <div class="step-action">
            @if (isFormSent) {
              <span class="step-status done">Enviado</span>
            } @else if (isProfileComplete) {
              <button class="btn-step-action primary" (click)="navigateTo('/tax-form')">
                Enviar formulario
              </button>
            } @else {
              <span class="step-status locked">Complet√° el paso anterior</span>
            }
          </div>
        </div>
      </div>

      <!-- Paso 3: Subir W2 -->
      <div class="step-item" [class.done]="hasW2Document" [class.active]="!hasW2Document">
        <div class="step-number-container">
          <div class="step-number">
            @if (hasW2Document) {
              <span class="step-check-icon">‚úì</span>
            } @else {
              <span>3</span>
            }
          </div>
          <div class="step-connector" [class.done]="hasW2Document"></div>
        </div>
        <div class="step-content">
          <div class="step-info">
            <h3 class="step-name">Paso 3: Sub√≠ tu documento W2</h3>
            <p class="step-description">Carg√° una foto o PDF de tu formulario W2</p>
          </div>
          <div class="step-action">
            @if (hasW2Document) {
              <span class="step-status done">Documento cargado</span>
            } @else {
              <button class="btn-step-action primary" (click)="navigateTo('/documents')">
                Subir documento
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Paso 4: Comprobante de pago -->
      <div class="step-item" [class.done]="hasPaymentProof" [class.active]="!hasPaymentProof" [class.last]="true">
        <div class="step-number-container">
          <div class="step-number">
            @if (hasPaymentProof) {
              <span class="step-check-icon">‚úì</span>
            } @else {
              <span>4</span>
            }
          </div>
        </div>
        <div class="step-content">
          <div class="step-info">
            <h3 class="step-name">Paso 4: Sub√≠ tu comprobante de pago</h3>
            <p class="step-description">Adjunt√° el comprobante del pago del servicio</p>
          </div>
          <div class="step-action">
            @if (hasPaymentProof) {
              <span class="step-status done">Comprobante cargado</span>
            } @else {
              <button class="btn-step-action primary" (click)="navigateTo('/documents')">
                Subir comprobante
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- IRS Progress Section -->
  @if (showIRSProgress) {
    <div class="irs-section">
      <div class="irs-header">
        <div class="irs-title">
          <span class="irs-icon">üèõÔ∏è</span>
          <div>
            <h3>Estado con el IRS</h3>
            <p>Seguimiento de tu declaraci√≥n</p>
          </div>
        </div>
        <div class="irs-badge" [class.complete]="isRefundDeposited">
          {{ isRefundDeposited ? '‚úì Depositado' : irsProgressPercent + '%' }}
        </div>
      </div>

      <div class="irs-progress-bar">
        <div class="irs-progress-fill" [style.width.%]="irsProgressPercent"></div>
      </div>

      <div class="irs-steps">
        <div class="irs-step" [class.done]="isSentToIRS" [class.active]="!isSentToIRS && userProgressComplete">
          <div class="step-indicator">
            @if (isSentToIRS) {
              <span class="step-check">‚úì</span>
            } @else {
              <span class="step-number">1</span>
            }
          </div>
          <div class="step-info">
            <span class="step-title">Enviado al IRS</span>
            <span class="step-desc">{{ isSentToIRS ? 'Tu declaraci√≥n fue enviada' : 'Pendiente de env√≠o' }}</span>
          </div>
        </div>

        <div class="irs-step" [class.done]="isAcceptedByIRS">
          <div class="step-indicator">
            @if (isAcceptedByIRS) {
              <span class="step-check">‚úì</span>
            } @else {
              <span class="step-number">2</span>
            }
          </div>
          <div class="step-info">
            <span class="step-title">Aceptado</span>
            <span class="step-desc">{{ isAcceptedByIRS ? 'Declaraci√≥n aprobada' : 'En revisi√≥n' }}</span>
          </div>
        </div>

        <div class="irs-step" [class.done]="estimatedReturnDate">
          <div class="step-indicator">
            @if (estimatedReturnDate) {
              <span class="step-check">‚úì</span>
            } @else {
              <span class="step-number">3</span>
            }
          </div>
          <div class="step-info">
            <span class="step-title">Fecha estimada</span>
            <span class="step-desc">{{ estimatedReturnDate || 'Por confirmar' }}</span>
          </div>
        </div>

        <div class="irs-step" [class.done]="isRefundDeposited">
          <div class="step-indicator">
            @if (isRefundDeposited) {
              <span class="step-check">‚úì</span>
            } @else {
              <span class="step-number">4</span>
            }
          </div>
          <div class="step-info">
            <span class="step-title">Depositado</span>
            <span class="step-desc">{{ isRefundDeposited ? '¬°Dinero en tu cuenta!' : 'Esperando dep√≥sito' }}</span>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Quick Actions -->
  <div class="actions-section">
    <h2 class="section-title">Acciones r√°pidas</h2>
    
    <div class="action-cards-grid">
      <!-- Calculator Card -->
      <div class="action-card" (click)="navigateTo('/tax-calculator')" appHoverScale="card">
        <div class="card-top">
          <div class="card-icon purple">üßÆ</div>
          <span class="card-badge new">NUEVO</span>
        </div>
        <h3 class="card-title">Calculadora</h3>
        <p class="card-desc">Calcula tu reembolso estimado con tu W2</p>
        <span class="card-action">Calcular ‚Üí</span>
      </div>

      <!-- Tax Form Card -->
      <div class="action-card" (click)="navigateTo('/tax-form')" appHoverScale="card">
        <div class="card-top">
          <div class="card-icon blue">üìã</div>
          @if (!isFormSent) {
            <span class="card-badge important">IMPORTANTE</span>
          }
        </div>
        <h3 class="card-title">Mi Declaraci√≥n</h3>
        <p class="card-desc">Complet√° tu informaci√≥n personal y tributaria</p>
        <span class="card-action">{{ isFormSent ? 'Ver formulario' : 'Completar' }} ‚Üí</span>
      </div>

      <!-- Upload Documents Card -->
      <div class="action-card" (click)="navigateTo('/documents')" appHoverScale="card">
        <div class="card-top">
          <div class="card-icon orange">üìÅ</div>
        </div>
        <h3 class="card-title">Documentos</h3>
        <p class="card-desc">Carg√° tus documentos fiscales (W-2, recibos)</p>
        <span class="card-action">{{ hasW2Document ? 'Ver documentos' : 'Subir archivos' }} ‚Üí</span>
      </div>

      <!-- Chatbot Card -->
      <div class="action-card" (click)="navigateTo('/chatbot')" appHoverScale="card">
        <div class="card-top">
          <div class="card-icon green">ü§ñ</div>
        </div>
        <h3 class="card-title">Asistente Virtual</h3>
        <p class="card-desc">Resolv√© tus dudas con nuestro chatbot</p>
        <span class="card-action">Iniciar chat ‚Üí</span>
      </div>
    </div>
  </div>

  <!-- Help Footer -->
  <div class="help-footer">
    <div class="help-icon">üí¨</div>
    <div class="help-text">
      <span class="help-title">¬øNecesitas ayuda?</span>
      <span class="help-desc">Nuestro equipo est√° listo para asistirte</span>
    </div>
    <button class="btn-help" (click)="navigateTo('/messages')" appHoverScale>Contactar soporte</button>
  </div>
</div>
}
