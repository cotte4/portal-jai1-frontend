<!-- Loading Screen -->
@if (!hasLoaded) {
  <div class="dashboard-loading">
    <div class="loading-spinner"></div>
    <p>Cargando tu dashboard...</p>
  </div>
}

<!-- Dashboard Content -->
@if (hasLoaded) {
<div class="dashboard-content">
  <!-- Problem Alert Banner -->
  @if (hasProblem) {
    <div class="problem-alert-banner" (click)="navigateTo('/messages')">
      <div class="problem-alert-icon">‚ö†Ô∏è</div>
      <div class="problem-alert-content">
        <span class="problem-alert-title">Necesitamos tu ayuda</span>
        <span class="problem-alert-text">Hay un inconveniente con tu tr√°mite. Por favor contacta a soporte para resolverlo.</span>
      </div>
      <button class="problem-alert-btn">Contactar Soporte ‚Üí</button>
    </div>
  }

  <!-- Top Section: Two Cards Side by Side -->
  <div class="top-section">
    <!-- Left Card: Reembolso Estimado -->
    <div class="refund-card">
      <div class="refund-header">
        <span class="refund-icon">üí∞</span>
        <span class="refund-label">Reembolso Estimado</span>
      </div>
      
      @if (hasCalculatorResult) {
        <div class="refund-amount">{{ estimatedRefundDisplay }}</div>
        <div class="refund-calculated">
          <span class="check-icon">‚úì</span>
          Calculado con tu W2
        </div>
        <button class="btn-recalculate" (click)="navigateTo('/tax-calculator')">
          Recalcular ‚Üí
        </button>
      } @else {
        <div class="refund-not-calculated">
          <span class="question-icon">üìÑ</span>
          <span>Sube tu W2 para calcular</span>
        </div>
        <button class="btn-calculate-cta" (click)="navigateTo('/tax-calculator')">
          <span>Calcular mi reembolso</span>
          <span class="arrow">‚Üí</span>
        </button>
      }
    </div>

    <!-- Right Card: User Progress -->
    <div class="progress-card" [class.compact]="userProgressComplete">
      @if (userProgressComplete) {
        <!-- Compact Completed State -->
        <div class="progress-complete">
          <div class="progress-complete-icon">
            <span class="complete-check">‚úì</span>
          </div>
          <div class="progress-complete-content">
            <span class="progress-complete-title">Preparacion completa</span>
            <span class="progress-complete-subtitle">Todos los pasos completados</span>
          </div>
          <div class="progress-complete-badge">100%</div>
        </div>
      } @else {
        <!-- Expanded Progress State -->
        <div class="progress-header">
          <div class="progress-title">
            <span class="progress-icon">üìã</span>
            <span>Tu Progreso</span>
          </div>
          <div class="progress-badge">
            {{ userProgressPercent }}%
          </div>
        </div>

        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="userProgressPercent"></div>
          </div>
        </div>

        <div class="checklist">
          <div class="checklist-item" [class.done]="isProfileComplete">
            <span class="item-check">{{ isProfileComplete ? '‚úì' : '‚óã' }}</span>
            <span class="item-text">Datos de perfil</span>
            @if (!isProfileComplete) {
              <button class="item-action" (click)="navigateTo('/tax-form')">Completar</button>
            }
          </div>
          <div class="checklist-item" [class.done]="isFormSent">
            <span class="item-check">{{ isFormSent ? '‚úì' : '‚óã' }}</span>
            <span class="item-text">Formulario enviado</span>
            @if (!isFormSent && isProfileComplete) {
              <button class="item-action" (click)="navigateTo('/tax-form')">Enviar</button>
            }
          </div>
          <div class="checklist-item" [class.done]="hasW2Document">
            <span class="item-check">{{ hasW2Document ? '‚úì' : '‚óã' }}</span>
            <span class="item-text">Documento W2</span>
            @if (!hasW2Document) {
              <button class="item-action" (click)="navigateTo('/documents')">Subir</button>
            }
          </div>
          <div class="checklist-item" [class.done]="hasPaymentProof">
            <span class="item-check">{{ hasPaymentProof ? '‚úì' : '‚óã' }}</span>
            <span class="item-text">Comprobante de pago</span>
            @if (!hasPaymentProof) {
              <button class="item-action" (click)="navigateTo('/documents')">Subir</button>
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- IRS Tracking Card - Shows current step from seguimiento system -->
  @if (showIRSProgress) {
    <div class="irs-tracking-card" (click)="navigateTo('/tax-tracking')"
         [class.completed]="isTrackingComplete"
         [class.rejected]="currentStepInfo.status === 'rejected'">
      <div class="tracking-card-content">
        <div class="tracking-card-left">
          <div class="tracking-step-icon"
               [class.active]="currentStepInfo.status === 'active'"
               [class.completed]="currentStepInfo.status === 'completed'"
               [class.rejected]="currentStepInfo.status === 'rejected'">
            <span>{{ currentStepInfo.icon }}</span>
          </div>
          <div class="tracking-step-info">
            <div class="tracking-step-label">
              <span class="step-counter">Paso {{ currentStepInfo.stepNumber }} de {{ currentStepInfo.totalSteps }}</span>
              @if (currentStepInfo.track === 'federal') {
                <span class="track-badge federal">Federal</span>
              } @else if (currentStepInfo.track === 'estatal') {
                <span class="track-badge estatal">Estatal</span>
              } @else if (currentStepInfo.track === 'both') {
                <span class="track-badge both">Federal + Estatal</span>
              }
            </div>
            <h3 class="tracking-step-title">{{ currentStepInfo.title }}</h3>
            <p class="tracking-step-desc">{{ currentStepInfo.description }}</p>
          </div>
        </div>
        <div class="tracking-card-right">
          <div class="tracking-progress-ring">
            <svg viewBox="0 0 36 36" class="circular-progress">
              <path class="circle-bg"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
              />
              <path class="circle-progress"
                [class.rejected]="currentStepInfo.status === 'rejected'"
                [attr.stroke-dasharray]="overallProgressPercent + ', 100'"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
              />
            </svg>
            <span class="progress-text">{{ overallProgressPercent }}%</span>
          </div>
          <span class="view-details">Ver detalles <span class="arrow">-></span></span>
        </div>
      </div>
    </div>
  }

  <!-- Quick Actions -->
  <div class="actions-section">
    <h2 class="section-title">Acciones r√°pidas</h2>
    
    <div class="action-cards-grid">
      <!-- Calculator Card -->
      <div class="action-card" (click)="navigateTo('/tax-calculator')">
        <div class="card-top">
          <div class="card-icon purple">üßÆ</div>
          <span class="card-badge new">NUEVO</span>
        </div>
        <h3 class="card-title">Calculadora</h3>
        <p class="card-desc">Calcula tu reembolso estimado con tu W2</p>
        <span class="card-action">Calcular ‚Üí</span>
      </div>

      <!-- Tax Form Card -->
      <div class="action-card" (click)="navigateTo('/tax-form')">
        <div class="card-top">
          <div class="card-icon blue">üìã</div>
          @if (!isFormSent) {
            <span class="card-badge important">IMPORTANTE</span>
          }
        </div>
        <h3 class="card-title">Mi Declaraci√≥n</h3>
        <p class="card-desc">Complet√° tu informaci√≥n personal y tributaria</p>
        <span class="card-action">{{ isFormSent ? 'Ver formulario' : 'Completar' }} ‚Üí</span>
      </div>

      <!-- Upload Documents Card -->
      <div class="action-card" (click)="navigateTo('/documents')">
        <div class="card-top">
          <div class="card-icon orange">üìÅ</div>
        </div>
        <h3 class="card-title">Documentos</h3>
        <p class="card-desc">Carg√° tus documentos fiscales (W-2, recibos)</p>
        <span class="card-action">{{ hasW2Document ? 'Ver documentos' : 'Subir archivos' }} ‚Üí</span>
      </div>

      <!-- Chatbot Card -->
      <div class="action-card" (click)="navigateTo('/chatbot')">
        <div class="card-top">
          <div class="card-icon green">ü§ñ</div>
        </div>
        <h3 class="card-title">Asistente Virtual</h3>
        <p class="card-desc">Resolv√© tus dudas con nuestro chatbot</p>
        <span class="card-action">Iniciar chat ‚Üí</span>
      </div>
    </div>
  </div>

  <!-- Help Footer -->
  <div class="help-footer">
    <div class="help-icon">üí¨</div>
    <div class="help-text">
      <span class="help-title">¬øNecesitas ayuda?</span>
      <span class="help-desc">Nuestro equipo est√° listo para asistirte</span>
    </div>
    <button class="btn-help" (click)="navigateTo('/messages')">Contactar soporte</button>
  </div>
</div>
}
