<div class="client-detail-container" [class.dark-mode]="darkMode">
  <!-- Header -->
  <header class="detail-header">
    <div class="header-content">
      <button class="btn-back-styled" (click)="goBack()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>Volver al Dashboard</span>
      </button>
      <div class="header-right">
        <button class="btn-dark-mode" (click)="toggleDarkMode()" [title]="darkMode ? 'Modo Claro' : 'Modo Oscuro'">
          <span *ngIf="!darkMode">üåô</span>
          <span *ngIf="darkMode">‚òÄÔ∏è</span>
        </button>
        <div class="logo">JAI1</div>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando datos del cliente...</p>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- Success Message -->
  <div class="success-message" *ngIf="successMessage">
    {{ successMessage }}
  </div>

  <!-- Main Content -->
  <main class="detail-main" *ngIf="client && !isLoading">
    <!-- Client Info Header -->
    <div class="client-header">
      <div class="client-avatar-large">
        {{ client.user.firstName.charAt(0) || '?' }}{{ client.user.lastName.charAt(0) || '?' }}
      </div>
      <div class="client-info">
        <h1>{{ client.user.firstName || 'Sin nombre' }} {{ client.user.lastName || '' }}</h1>
        <div class="client-meta">
          <span class="meta-item">
            <span class="meta-icon">üìß</span>
            {{ client.user.email || 'Sin email' }}
          </span>
          <span class="meta-item" *ngIf="client.user.phone">
            <span class="meta-icon">üì±</span>
            {{ client.user.phone }}
          </span>
          <span class="meta-item">
            <span class="meta-icon">üìÖ</span>
            Registrado: {{ client.user.createdAt | date:'dd/MM/yyyy' }}
          </span>
        </div>
        <!-- Quick Access Buttons -->
        <div class="client-quick-actions">
          <button class="btn-quick-access" (click)="openProfileModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <span>Datos del Cliente</span>
          </button>
          <button class="btn-quick-access" (click)="openDocumentsModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            <span>Documentos</span>
            <span class="quick-access-badge" *ngIf="client.documents && client.documents.length > 0">{{ client.documents.length }}</span>
          </button>
          <button class="btn-quick-access btn-problem-quick" [class.has-problem]="hasProblem" (click)="openProblemModal()" *ngIf="client.taxCases && client.taxCases.length > 0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <span>{{ hasProblem ? 'Ver Problema' : 'Marcar Problema' }}</span>
            <span class="quick-access-badge problem-badge" *ngIf="hasProblem">!</span>
          </button>
          <button class="btn-quick-access btn-notify-quick" (click)="openNotifyModal()" *ngIf="client.taxCases && client.taxCases.length > 0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <span>Enviar Notificacion</span>
          </button>
        </div>
      </div>
      <!-- Status display - use Status Section below for changes -->
      <div class="status-control">
        <span class="phase-badge" *ngIf="!taxesFiled">Pre-Presentacion</span>
        <span class="phase-badge filed" *ngIf="taxesFiled">Taxes Presentados</span>
        <span class="status-info" *ngIf="selectedFederalStatusNew">Fed: {{ getFederalStatusNewLabel(selectedFederalStatusNew) }}</span>
        <span class="status-info" *ngIf="selectedStateStatusNew">Est: {{ getStateStatusNewLabel(selectedStateStatusNew) }}</span>
      </div>
    </div>

    <!-- Status Banners Section (Problem + Alarms) -->
    <section class="status-banners-section" *ngIf="(hasProblem || taxCaseAlarms.length > 0) && client.taxCases && client.taxCases.length > 0">
      <div class="problem-banner" *ngIf="hasProblem">
        <span class="problem-icon">!</span>
        <div class="problem-info">
          <strong>{{ getProblemTypeLabel(selectedProblemType) }}</strong>
          <p *ngIf="problemDescription">{{ problemDescription }}</p>
        </div>
        <button class="btn-resolve" (click)="resolveProblem()" [disabled]="isSaving">
          {{ isSaving ? 'Resolviendo...' : 'Resolver' }}
        </button>
      </div>
      <!-- Alarms Banner -->
      <div class="alarms-banner" *ngIf="taxCaseAlarms.length > 0">
        <div class="alarms-header">
          <span class="alarm-icon" [class.critical]="hasCriticalAlarm">‚ö†Ô∏è</span>
          <strong>{{ taxCaseAlarms.length }} Alerta{{ taxCaseAlarms.length > 1 ? 's' : '' }}</strong>
        </div>
        <div class="alarms-list">
          <div class="alarm-item" *ngFor="let alarm of taxCaseAlarms; trackBy: trackByIndex"
               [class]="getAlarmLevelClass(alarm.level)">
            <span class="alarm-track">{{ alarm.track === 'federal' ? 'ü¶Ö Fed' : 'üóΩ Est' }}</span>
            <span class="alarm-message">{{ alarm.message }}</span>
            <span class="alarm-days">{{ alarm.daysSinceStatusChange }} d√≠as</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Phase-Based Status Section -->
    <section class="phase-status-section" *ngIf="client.taxCases && client.taxCases.length > 0">
      <div class="section-header">
        <div class="section-title">
          <span class="section-icon">üìä</span>
          <h2>Estado del Caso</h2>
        </div>
        <div class="phase-indicator" [class.filed]="taxesFiled">
          <span class="phase-badge" *ngIf="!taxesFiled">Pre-Presentacion</span>
          <span class="phase-badge filed" *ngIf="taxesFiled">Taxes Presentados</span>
        </div>
      </div>

      <!-- Pre-Filing Phase UI -->
      <div class="pre-filing-section" *ngIf="!taxesFiled">
        <!-- 4-Step Progress Indicator -->
        <div class="steps-progress-card">
          <div class="steps-progress-header">
            <span class="steps-icon">üìã</span>
            <h3>Progreso del Cliente</h3>
            <span class="steps-count">{{ completedStepsCount }}/4 completados</span>
            <!-- Visual Review Button - Only shows when all 4 steps complete -->
            <button class="btn-visual-review" *ngIf="allStepsComplete" (click)="startVisualReview()">
              <span class="btn-review-icon">üéØ</span>
              <span>REVISION VISUAL</span>
            </button>
          </div>
          <div class="steps-progress-body">
            <div class="steps-container">
              <!-- Step 1: Formulario -->
              <div class="step-item" [class.completed]="isStep1Complete">
                <div class="step-circle" [class.completed]="isStep1Complete">
                  <svg *ngIf="isStep1Complete" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span *ngIf="!isStep1Complete">1</span>
                </div>
                <span class="step-label">Formulario</span>
              </div>
              <div class="step-connector" [class.completed]="isStep1Complete"></div>

              <!-- Step 2: W2 -->
              <div class="step-item" [class.completed]="isStep2Complete">
                <div class="step-circle" [class.completed]="isStep2Complete">
                  <svg *ngIf="isStep2Complete" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span *ngIf="!isStep2Complete">2</span>
                </div>
                <span class="step-label">W2</span>
              </div>
              <div class="step-connector" [class.completed]="isStep2Complete"></div>

              <!-- Step 3: Comprobante -->
              <div class="step-item" [class.completed]="isStep3Complete">
                <div class="step-circle" [class.completed]="isStep3Complete">
                  <svg *ngIf="isStep3Complete" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span *ngIf="!isStep3Complete">3</span>
                </div>
                <span class="step-label">Comprobante</span>
              </div>
              <div class="step-connector" [class.completed]="isStep3Complete"></div>

              <!-- Step 4: Consentimiento -->
              <div class="step-item" [class.completed]="isStep4Complete">
                <div class="step-circle" [class.completed]="isStep4Complete">
                  <svg *ngIf="isStep4Complete" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span *ngIf="!isStep4Complete">4</span>
                </div>
                <span class="step-label">Consentimiento</span>
              </div>
            </div>
          </div>
        </div>

        <div class="pre-filing-card">
          <div class="pre-filing-header">
            <span class="pre-filing-icon">üìù</span>
            <h3>Estado del Caso</h3>
            <span class="status-badge-large" [class]="'status-' + selectedCaseStatus">
              {{ getCaseStatusLabel(selectedCaseStatus) }}
            </span>
          </div>
          <div class="pre-filing-body">
            <div class="pre-filing-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedCaseStatus">
                <option *ngFor="let status of filteredCaseStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getCaseStatusLabel(status) }}
                </option>
              </select>
            </div>
            <button class="btn-update-prefiling" (click)="updateCaseStatus()" [disabled]="isSavingPreFiling || !selectedCaseStatus">
              {{ isSavingPreFiling ? 'Guardando...' : 'Actualizar Estado' }}
            </button>
          </div>
        </div>

        <div class="mark-filed-card">
          <div class="mark-filed-header">
            <span class="mark-filed-icon">‚úÖ</span>
            <h3>Marcar como Presentado</h3>
          </div>
          <div class="mark-filed-body">
            <p class="mark-filed-description">
              Cuando los taxes hayan sido presentados al IRS, marque esta casilla e ingrese la fecha.
            </p>
            <div class="mark-filed-field">
              <label>Fecha de Presentacion</label>
              <input type="date" [(ngModel)]="taxesFiledAt">
            </div>
            <button class="btn-mark-filed" (click)="markTaxesAsFiled()" [disabled]="isMarkingFiled || !taxesFiledAt">
              {{ isMarkingFiled ? 'Procesando...' : 'Marcar Taxes como Presentados' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Filed Date Display (when already filed) -->
      <div class="filed-info" *ngIf="taxesFiled && taxesFiledAt">
        <span class="filed-icon">üìÖ</span>
        <span class="filed-text">Presentado el {{ taxesFiledAt | date:'dd/MM/yyyy' }}</span>
      </div>
    </section>

    <!-- Federal/State Tracking Section (only show when taxesFiled) -->
    <section class="federal-state-section" *ngIf="client.taxCases && client.taxCases.length > 0 && taxesFiled">
      <div class="section-header">
        <div class="section-title">
          <span class="section-icon">üèõÔ∏è</span>
          <h2>Seguimiento Federal / Estatal</h2>
        </div>
      </div>

      <div class="federal-state-grid">
        <!-- Case Status -->
        <div class="track-card case-status-card" style="grid-column: span 2;">
          <div class="track-header">
            <span class="track-icon">üìä</span>
            <h3>Estado del Caso</h3>
            <span class="track-status" [class]="'status-' + (selectedCaseStatus || 'pending')">
              {{ getCaseStatusLabel(selectedCaseStatus) }}
            </span>
          </div>
          <div class="track-body">
            <div class="track-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedCaseStatus">
                <option [ngValue]="null">Sin estado</option>
                <option *ngFor="let status of filteredCaseStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getCaseStatusLabel(status) }}
                </option>
              </select>
            </div>
            <button class="btn-track-update" (click)="updateCaseStatus()" [disabled]="isSavingPreFiling || !selectedCaseStatus">
              {{ isSavingPreFiling ? 'Guardando...' : 'Actualizar Estado' }}
            </button>
          </div>
        </div>

        <!-- Federal Track -->
        <div class="track-card federal-track">
          <div class="track-header">
            <span class="track-icon">ü¶Ö</span>
            <h3>Federal</h3>
            <span class="track-status" [class]="'status-' + (selectedFederalStatusNew || 'pending')">
              {{ getFederalStatusNewLabel(selectedFederalStatusNew) }}
            </span>
          </div>
          <div class="track-body">
            <div class="track-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedFederalStatusNew">
                <option [ngValue]="null">Sin estado</option>
                <option *ngFor="let status of filteredFederalStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getFederalStatusNewLabel(status) }}
                </option>
              </select>
            </div>
            <div class="track-field">
              <label>Fecha Estimada</label>
              <input type="date" [(ngModel)]="federalEstimatedDate">
            </div>
            <div class="track-field">
              <label>Monto Real ($)</label>
              <input type="number" [(ngModel)]="federalActualRefund" placeholder="0.00" step="0.01">
            </div>
            <div class="track-field">
              <label>Fecha Deposito</label>
              <input type="date" [(ngModel)]="federalDepositDate">
            </div>
            <div class="track-field full-width">
              <label>Comentario</label>
              <input type="text" [(ngModel)]="federalComment" placeholder="Agregar comentario...">
            </div>
            <button class="btn-track-update" (click)="updateFederalStatusNew()" [disabled]="isSavingFederal">
              {{ isSavingFederal ? 'Guardando...' : 'Actualizar Federal' }}
            </button>
          </div>
        </div>

        <!-- State Track -->
        <div class="track-card state-track">
          <div class="track-header">
            <span class="track-icon">üóΩ</span>
            <h3>Estatal</h3>
            <span class="track-status" [class]="'status-' + (selectedStateStatusNew || 'pending')">
              {{ getStateStatusNewLabel(selectedStateStatusNew) }}
            </span>
          </div>
          <div class="track-body">
            <div class="track-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedStateStatusNew">
                <option [ngValue]="null">Sin estado</option>
                <option *ngFor="let status of filteredStateStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getStateStatusNewLabel(status) }}
                </option>
              </select>
            </div>
            <div class="track-field">
              <label>Fecha Estimada</label>
              <input type="date" [(ngModel)]="stateEstimatedDate">
            </div>
            <div class="track-field">
              <label>Monto Real ($)</label>
              <input type="number" [(ngModel)]="stateActualRefund" placeholder="0.00" step="0.01">
            </div>
            <div class="track-field">
              <label>Fecha Deposito</label>
              <input type="date" [(ngModel)]="stateDepositDate">
            </div>
            <div class="track-field full-width">
              <label>Comentario</label>
              <input type="text" [(ngModel)]="stateComment" placeholder="Agregar comentario...">
            </div>
            <button class="btn-track-update" (click)="updateStateStatusNew()" [disabled]="isSavingState">
              {{ isSavingState ? 'Guardando...' : 'Actualizar Estatal' }}
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-action btn-paid" (click)="markPaid()" [disabled]="isMarkingPaid" *ngIf="client.taxCases && client.taxCases.length > 0 && !client.taxCases[0].paymentReceived">
        @if (isMarkingPaid) {
          <span class="spinner"></span>
          <span>Procesando...</span>
        } @else {
          Marcar Pago Recibido
        }
      </button>
      <button class="btn-action btn-delete" (click)="deleteClient()" [disabled]="isDeleting">
        @if (isDeleting) {
          <span class="spinner"></span>
          <span>Eliminando...</span>
        } @else {
          Eliminar Cliente
        }
      </button>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Profile Section -->
        <section class="detail-section" id="profile-section">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üìã</span>
              <h2>Perfil del Cliente</h2>
            </div>
          </div>

          <div class="form-preview" *ngIf="client.profile">
            <!-- Personal Info -->
            <div class="form-group-preview">
              <h3>Informacion Personal</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Nombre Completo</span>
                  <span class="info-value">{{ client.user.firstName || '' }} {{ client.user.lastName || '' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">SSN</span>
                  <span class="info-value">{{ client.profile.ssn || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Fecha de Nacimiento</span>
                  <span class="info-value">{{ client.profile.dateOfBirth ? (client.profile.dateOfBirth | date:'dd/MM/yyyy') : 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Telefono</span>
                  <span class="info-value">{{ client.user.phone || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="form-group-preview" *ngIf="client.profile.address">
              <h3>Direccion</h3>
              <div class="info-grid">
                <div class="info-item full-width">
                  <span class="info-label">Direccion</span>
                  <span class="info-value">{{ client.profile.address.street || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Ciudad</span>
                  <span class="info-value">{{ client.profile.address.city || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Estado</span>
                  <span class="info-value">{{ client.profile.address.state || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Codigo Postal</span>
                  <span class="info-value">{{ client.profile.address.zip || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Employment -->
            <div class="form-group-preview">
              <h3>Informacion de Empleo</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Estado donde trabajo</span>
                  <span class="info-value">{{ client.profile.workState || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Empleador</span>
                  <span class="info-value">{{ client.profile.employerName || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Bank Info -->
            <div class="form-group-preview" *ngIf="client.profile.bank">
              <h3>Informacion Bancaria</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Banco</span>
                  <span class="info-value">{{ client.profile.bank.name || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Routing Number</span>
                  <span class="info-value">{{ client.profile.bank.routingNumber || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Account Number</span>
                  <span class="info-value">{{ client.profile.bank.accountNumber || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Client Accounts (Credentials) -->
            <div class="form-group-preview accounts-section">
              <h3>
                <span class="section-icon-small">üîê</span>
                Cuentas del Cliente
              </h3>
              <div class="accounts-grid">
                <!-- TurboTax -->
                <div class="account-card turbotax-card">
                  <div class="account-header">
                    <span class="account-icon">üìä</span>
                    <span class="account-name">TurboTax</span>
                  </div>
                  <div class="account-credentials" *ngIf="client.profile.turbotaxEmail || client.profile.turbotaxPassword">
                    <div class="credential-row">
                      <span class="credential-label">Email</span>
                      <span class="credential-value" [class.masked]="!showTurbotaxCredentials">
                        {{ showTurbotaxCredentials ? (client.profile.turbotaxEmail || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <div class="credential-row">
                      <span class="credential-label">Password</span>
                      <span class="credential-value" [class.masked]="!showTurbotaxCredentials">
                        {{ showTurbotaxCredentials ? (client.profile.turbotaxPassword || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <button class="btn-show-credentials" (click)="toggleTurbotaxCredentials()">
                      {{ showTurbotaxCredentials ? 'Ocultar' : 'Mostrar' }}
                    </button>
                  </div>
                  <div class="account-empty" *ngIf="!client.profile.turbotaxEmail && !client.profile.turbotaxPassword">
                    <span class="empty-text">No configurado</span>
                  </div>
                </div>

                <!-- IRS -->
                <div class="account-card irs-card">
                  <div class="account-header">
                    <span class="account-icon">üèõÔ∏è</span>
                    <span class="account-name">IRS</span>
                  </div>
                  <div class="account-credentials" *ngIf="client.profile.irsUsername || client.profile.irsPassword">
                    <div class="credential-row">
                      <span class="credential-label">Usuario</span>
                      <span class="credential-value" [class.masked]="!showIrsCredentials">
                        {{ showIrsCredentials ? (client.profile.irsUsername || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <div class="credential-row">
                      <span class="credential-label">Password</span>
                      <span class="credential-value" [class.masked]="!showIrsCredentials">
                        {{ showIrsCredentials ? (client.profile.irsPassword || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <button class="btn-show-credentials" (click)="toggleIrsCredentials()">
                      {{ showIrsCredentials ? 'Ocultar' : 'Mostrar' }}
                    </button>
                  </div>
                  <div class="account-empty" *ngIf="!client.profile.irsUsername && !client.profile.irsPassword">
                    <span class="empty-text">No configurado</span>
                  </div>
                </div>

                <!-- State -->
                <div class="account-card state-card">
                  <div class="account-header">
                    <span class="account-icon">üóΩ</span>
                    <span class="account-name">Estado</span>
                  </div>
                  <div class="account-credentials" *ngIf="client.profile.stateUsername || client.profile.statePassword">
                    <div class="credential-row">
                      <span class="credential-label">Usuario</span>
                      <span class="credential-value" [class.masked]="!showStateCredentials">
                        {{ showStateCredentials ? (client.profile.stateUsername || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <div class="credential-row">
                      <span class="credential-label">Password</span>
                      <span class="credential-value" [class.masked]="!showStateCredentials">
                        {{ showStateCredentials ? (client.profile.statePassword || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <button class="btn-show-credentials" (click)="toggleStateCredentials()">
                      {{ showStateCredentials ? 'Ocultar' : 'Mostrar' }}
                    </button>
                  </div>
                  <div class="account-empty" *ngIf="!client.profile.stateUsername && !client.profile.statePassword">
                    <span class="empty-text">No configurado</span>
                  </div>
                </div>
              </div>
              <button class="btn-edit-credentials" (click)="openCredentialsModal()">
                Editar Credenciales
              </button>
            </div>

            <!-- Tax Case Info -->
            <div class="form-group-preview" *ngIf="client.taxCases && client.taxCases.length > 0">
              <h3>Caso Fiscal</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Ano Fiscal</span>
                  <span class="info-value">{{ client.taxCases[0]?.taxYear || 'No disponible' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Reembolso Estimado</span>
                  <span class="info-value">
                    {{ client.taxCases[0]?.estimatedRefund ? ('$' + client.taxCases[0].estimatedRefund) : 'Pendiente' }}
                    <button
                      *ngIf="client.taxCases[0]?.estimatedRefund"
                      class="btn-reset-estimate"
                      (click)="resetW2Estimate()"
                      [disabled]="isResettingEstimate"
                      title="Permite al cliente recalcular su W2">
                      {{ isResettingEstimate ? 'Reseteando...' : 'Reset' }}
                    </button>
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">Pago Recibido</span>
                  <span class="info-value">{{ client.taxCases[0]?.paymentReceived ? 'Si' : 'No' }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="empty-form" *ngIf="!client.profile">
            <span class="empty-icon">üìã</span>
            <p>El cliente aun no ha completado su perfil</p>
          </div>
        </section>

        <!-- Documents Section -->
        <section class="detail-section" id="documents-section">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üìÅ</span>
              <h2>Documentos ({{ client.documents.length || 0 }})</h2>
            </div>
          </div>

          <!-- Document Type Tabs -->
          <div class="document-tabs" *ngIf="client.documents && client.documents.length > 0">
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'all'"
                    (click)="selectDocumentTab('all')">
              Todos <span class="tab-count">{{ getDocumentCountByType('all') }}</span>
            </button>
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'w2'"
                    (click)="selectDocumentTab('w2')">
              W2 <span class="tab-count">{{ getDocumentCountByType('w2') }}</span>
            </button>
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'payment_proof'"
                    (click)="selectDocumentTab('payment_proof')">
              Comprobantes <span class="tab-count">{{ getDocumentCountByType('payment_proof') }}</span>
            </button>
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'other'"
                    (click)="selectDocumentTab('other')">
              Otros <span class="tab-count">{{ getDocumentCountByType('other') }}</span>
            </button>
          </div>

          <div class="documents-list" *ngIf="filteredDocuments.length > 0">
            <div class="document-card" *ngFor="let doc of filteredDocuments; trackBy: trackById">
              <div class="doc-icon">{{ getFileIcon(doc.mimeType) }}</div>
              <div class="doc-info">
                <div class="doc-name">{{ doc.fileName }}</div>
                <div class="doc-meta">
                  {{ formatFileSize(doc.fileSize) }} | {{ doc.uploadedAt | date:'dd/MM/yyyy HH:mm' }}
                  <span *ngIf="doc.isReviewed" class="reviewed-badge">Revisado</span>
                </div>
              </div>
              <button class="btn-doc-download" (click)="downloadDocument(doc)">
                Descargar
              </button>
            </div>
          </div>

          <div class="empty-docs" *ngIf="!client.documents || client.documents.length === 0">
            <span class="empty-icon">üìÅ</span>
            <p>No hay documentos subidos todavia</p>
          </div>

          <div class="empty-docs" *ngIf="client.documents && client.documents.length > 0 && filteredDocuments.length === 0">
            <span class="empty-icon">üìÅ</span>
            <p>No hay documentos de este tipo</p>
          </div>
        </section>

        <!-- Status History -->
        <section class="detail-section" *ngIf="client.statusHistory && client.statusHistory.length > 0">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üìú</span>
              <h2>Historial de Estados ({{ client.statusHistory.length }})</h2>
            </div>
          </div>

          <div class="status-history-timeline">
            <div class="history-item" *ngFor="let history of client.statusHistory; let i = index; trackBy: trackById">
              <div class="history-marker">
                <div class="marker-dot" [class.first]="i === 0"></div>
                <div class="marker-line" *ngIf="i < client.statusHistory.length - 1"></div>
              </div>
              <div class="history-content">
                <div class="history-header">
                  <span class="history-date">
                    <span class="date-icon">üìÖ</span>
                    {{ history.createdAt | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                  <span class="history-admin" *ngIf="history.changedBy">
                    <span class="admin-icon">üë§</span>
                    {{ history.changedBy.firstName || '' }} {{ history.changedBy.lastName || '' }}
                  </span>
                </div>
                <div class="history-change">
                  <span class="status-badge-history old">{{ getHistoryStatusLabel(history.previousStatus) }}</span>
                  <span class="arrow-icon">‚Üí</span>
                  <span class="status-badge-history new">{{ getHistoryStatusLabel(history.newStatus) }}</span>
                </div>
                <div class="history-comment" *ngIf="history.comment">
                  <span class="comment-icon">üí¨</span>
                  <span class="comment-text">"{{ history.comment }}"</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Right Column - Tickets -->
      <div class="right-column">
        <section class="messages-section">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üí¨</span>
              <h2>Tickets de Soporte</h2>
            </div>
            <button class="btn-refresh-tickets" (click)="loadTickets()" [disabled]="isLoadingTickets" title="Recargar tickets">
              <span [class.spinning]="isLoadingTickets">‚Üª</span>
            </button>
          </div>

          <!-- Error Message (visible always when there's an error) -->
          <div class="ticket-error-message" *ngIf="ticketErrorMessage">
            <span class="error-icon">!</span>
            {{ ticketErrorMessage }}
            <button class="btn-retry" (click)="loadTickets()">Reintentar</button>
          </div>

          <!-- Loading State -->
          <div class="tickets-loading" *ngIf="isLoadingTickets">
            <div class="spinner-small"></div>
            <p>Cargando tickets...</p>
          </div>

          <!-- Tickets List (only when loaded and has tickets) -->
          <div class="tickets-list" *ngIf="!isLoadingTickets && tickets.length > 0">
            <div class="ticket-card"
                 *ngFor="let ticket of tickets; trackBy: trackById"
                 [class.selected]="selectedTicketId === ticket.id"
                 (click)="selectTicket(ticket.id)">
              <div class="ticket-subject">{{ ticket.subject }}</div>
              <div class="ticket-meta">
                <span class="ticket-status" [class]="'status-' + ticket.status">{{ getTicketStatusLabel(ticket.status) }}</span>
                <span class="ticket-date">{{ ticket.createdAt | date:'dd/MM HH:mm' }}</span>
              </div>
            </div>
          </div>

          <!-- Loading Selected Ticket -->
          <div class="tickets-loading" *ngIf="isLoadingSelectedTicket">
            <div class="spinner-small"></div>
            <p>Cargando conversacion...</p>
          </div>

          <!-- Selected Ticket Conversation -->
          <div class="messages-container" *ngIf="selectedTicket && !isLoadingSelectedTicket">
            <div class="conversation-header-mini">
              <span class="ticket-subject-display">{{ selectedTicket.subject }}</span>
              <span class="ticket-status-mini" [class]="'status-' + selectedTicket.status">{{ getTicketStatusLabel(selectedTicket.status) }}</span>
            </div>

            <div class="messages-list">
              <div class="message-item"
                   *ngFor="let msg of selectedTicket.messages; trackBy: trackById"
                   [class.admin-message]="msg.sender?.role === 'admin'"
                   [class.client-message]="msg.sender?.role !== 'admin'">
                <div class="message-header">
                  <span class="sender-name">{{ msg.sender?.role === 'admin' ? 'Soporte JAI1' : (msg.sender?.firstName || 'Cliente') }}</span>
                  <span class="message-date">{{ msg.createdAt | date:'dd/MM HH:mm' }}</span>
                </div>
                <div class="message-text">{{ msg.message }}</div>
              </div>

              <!-- Empty messages state -->
              <div class="empty-conversation" *ngIf="!selectedTicket.messages || selectedTicket.messages.length === 0">
                <p>No hay mensajes en este ticket</p>
              </div>
            </div>

            <!-- Success Message -->
            <div class="ticket-success-message" *ngIf="ticketSuccessMessage">
              {{ ticketSuccessMessage }}
            </div>

            <div class="message-input">
              <textarea
                [(ngModel)]="newMessage"
                placeholder="Escribe tu respuesta..."
                rows="3"
                [disabled]="isSendingMessage"
                (keydown.enter)="sendMessage(); $event.preventDefault()"
              ></textarea>
              <button class="btn-send" (click)="sendMessage()" [disabled]="!newMessage.trim() || isSendingMessage">
                <span>{{ isSendingMessage ? 'Enviando...' : 'Enviar' }}</span>
                <span class="send-icon" *ngIf="!isSendingMessage">-></span>
              </button>
            </div>
          </div>

          <!-- Empty State (only when loaded and no tickets) -->
          <div class="empty-messages" *ngIf="!isLoadingTickets && tickets.length === 0 && !ticketErrorMessage">
            <span class="empty-icon">üí¨</span>
            <p>No hay tickets de soporte</p>
            <span class="empty-hint">El cliente no ha creado ningun ticket</span>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Problem Modal -->
  <div class="modal-overlay" *ngIf="showProblemModal" (click)="closeProblemModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ hasProblem ? 'Problema Actual' : 'Marcar Problema' }}</h3>
        <button class="modal-close" (click)="closeProblemModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" *ngIf="!hasProblem">
          <label>Tipo de Problema</label>
          <select [(ngModel)]="selectedProblemType">
            <option [ngValue]="null" disabled>Seleccione un tipo...</option>
            <option *ngFor="let type of problemTypeOptions; trackBy: trackByIndex" [ngValue]="type">
              {{ getProblemTypeLabel(type) }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Descripcion</label>
          <textarea
            [(ngModel)]="problemDescription"
            placeholder="Describa el problema..."
            rows="4"
            [readonly]="hasProblem"
          ></textarea>
        </div>
        <div class="current-problem-info" *ngIf="hasProblem">
          <div class="info-row">
            <span class="info-label">Tipo:</span>
            <span class="info-value">{{ getProblemTypeLabel(selectedProblemType) }}</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeProblemModal()">Cancelar</button>
        <button
          *ngIf="!hasProblem"
          class="btn-save"
          (click)="saveProblem()"
          [disabled]="isSaving || !selectedProblemType"
        >
          {{ isSaving ? 'Guardando...' : 'Guardar Problema' }}
        </button>
        <button
          *ngIf="hasProblem"
          class="btn-resolve-modal"
          (click)="resolveProblem()"
          [disabled]="isSaving"
        >
          {{ isSaving ? 'Resolviendo...' : 'Marcar como Resuelto' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Modal -->
  <div class="modal-overlay" *ngIf="showNotifyModal" (click)="closeNotifyModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Enviar Notificacion al Cliente</h3>
        <button class="modal-close" (click)="closeNotifyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Titulo</label>
          <input
            type="text"
            [(ngModel)]="notifyTitle"
            placeholder="Titulo de la notificacion..."
          />
        </div>
        <div class="form-group">
          <label>Mensaje</label>
          <textarea
            [(ngModel)]="notifyMessage"
            placeholder="Escriba el mensaje..."
            rows="4"
          ></textarea>
        </div>
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="notifySendEmail" />
            <span>Enviar tambien por email</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeNotifyModal()">Cancelar</button>
        <button
          class="btn-save"
          (click)="sendNotification()"
          [disabled]="isSaving || !notifyTitle.trim() || !notifyMessage.trim()"
        >
          {{ isSaving ? 'Enviando...' : 'Enviar Notificacion' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Status Update Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showStatusConfirmModal" (click)="closeStatusConfirmModal()">
    <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmar Cambio de Estado</h3>
        <button class="modal-close" (click)="closeStatusConfirmModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="confirm-question">Use los controles de estado Federal/Estatal en la seccion "Estado del Caso" para actualizar el estado.</p>

        <div class="status-change-preview">
          <p>Este modal ya no se utiliza. Los estados se actualizan directamente desde los controles Federal y Estatal.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeStatusConfirmModal()">Cancelar</button>
        <button
          class="btn-save"
          (click)="confirmStatusUpdate()"
          [disabled]="isSaving"
        >
          {{ isSaving ? 'Actualizando...' : 'Confirmar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Credentials Edit Modal -->
  <div class="modal-overlay" *ngIf="showCredentialsModal" (click)="closeCredentialsModal()">
    <div class="modal-content modal-credentials" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar Credenciales del Cliente</h3>
        <button class="modal-close" (click)="closeCredentialsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- TurboTax -->
        <div class="credentials-group">
          <h4><span class="group-icon">üìä</span> TurboTax</h4>
          <div class="form-group">
            <label>Email</label>
            <input type="text" [(ngModel)]="editTurbotaxEmail" placeholder="Email de TurboTax">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="text" [(ngModel)]="editTurbotaxPassword" placeholder="Password de TurboTax">
          </div>
        </div>

        <!-- IRS -->
        <div class="credentials-group">
          <h4><span class="group-icon">üèõÔ∏è</span> IRS</h4>
          <div class="form-group">
            <label>Usuario</label>
            <input type="text" [(ngModel)]="editIrsUsername" placeholder="Usuario del IRS">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="text" [(ngModel)]="editIrsPassword" placeholder="Password del IRS">
          </div>
        </div>

        <!-- State -->
        <div class="credentials-group">
          <h4><span class="group-icon">üóΩ</span> Estado</h4>
          <div class="form-group">
            <label>Usuario</label>
            <input type="text" [(ngModel)]="editStateUsername" placeholder="Usuario del Estado">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="text" [(ngModel)]="editStatePassword" placeholder="Password del Estado">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeCredentialsModal()">Cancelar</button>
        <button
          class="btn-save"
          (click)="saveCredentials()"
          [disabled]="isSavingCredentials"
        >
          {{ isSavingCredentials ? 'Guardando...' : 'Guardar Credenciales' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Mark Paid Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showMarkPaidConfirm" (click)="cancelMarkPaid()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmar Pago Recibido</h3>
        <button class="modal-close" (click)="cancelMarkPaid()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="confirm-question">¬øEstas seguro de marcar el pago como recibido?</p>
        <p class="confirm-warning">Esta accion registrara que el cliente ha pagado la comision.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelMarkPaid()">Cancelar</button>
        <button class="btn-confirm-action" (click)="confirmMarkPaid()" [disabled]="isMarkingPaid">
          {{ isMarkingPaid ? 'Procesando...' : 'Confirmar Pago' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Mark Filed Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showMarkFiledConfirm" (click)="cancelMarkFiled()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmar Presentacion de Taxes</h3>
        <button class="modal-close" (click)="cancelMarkFiled()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="confirm-question">¬øEstas seguro de marcar los taxes como presentados?</p>
        <p class="confirm-warning">Esta accion cambiara el estado del caso a "Taxes Presentados" con fecha {{ taxesFiledAt | date:'dd/MM/yyyy' }}.</p>
        <p class="confirm-info">Los estados Federal y Estatal se estableceran como "Presentado".</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelMarkFiled()">Cancelar</button>
        <button class="btn-confirm-action filed" (click)="confirmMarkFiled()" [disabled]="isMarkingFiled">
          {{ isMarkingFiled ? 'Procesando...' : 'Confirmar Presentacion' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Status Override Modal -->
  <div class="modal-overlay" *ngIf="showOverrideModal" (click)="closeOverrideModal()">
    <div class="modal-content override-modal" (click)="$event.stopPropagation()">
      <div class="modal-header override-header">
        <h3>Transicion de Estado No Permitida</h3>
        <button class="modal-close" (click)="closeOverrideModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="override-warning-banner">
          <span class="warning-icon">!</span>
          <p>{{ overrideError?.message }}</p>
        </div>

        <div class="override-details" *ngIf="overrideError">
          <div class="detail-row">
            <span class="detail-label">Estado actual:</span>
            <span class="detail-value current">{{ overrideError.currentStatus || 'Sin estado' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Estado intentado:</span>
            <span class="detail-value attempted">{{ overrideError.attemptedStatus }}</span>
          </div>
          <div class="detail-row" *ngIf="overrideError.allowedTransitions.length > 0">
            <span class="detail-label">Transiciones permitidas:</span>
            <div class="allowed-transitions">
              <span class="allowed-status" *ngFor="let status of overrideError.allowedTransitions">{{ status }}</span>
            </div>
          </div>
        </div>

        <div class="override-form">
          <p class="override-instruction">Para forzar esta transicion, proporcione una razon (minimo 10 caracteres):</p>
          <div class="form-group">
            <label>Razon del Override</label>
            <textarea
              [(ngModel)]="overrideReason"
              placeholder="Explique por que es necesario forzar esta transicion de estado..."
              rows="4"
              [class.invalid]="overrideReason.length > 0 && overrideReason.length < 10"
            ></textarea>
            <span class="char-count" [class.invalid]="overrideReason.length > 0 && overrideReason.length < 10">
              {{ overrideReason.length }}/10 caracteres minimos
            </span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeOverrideModal()">Cancelar</button>
        <button
          class="btn-override"
          (click)="confirmOverride()"
          [disabled]="overrideReason.length < 10"
        >
          Forzar Transicion
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Data Modal -->
  <div class="modal-overlay" *ngIf="showProfileModal" (click)="closeProfileModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Datos del Cliente
        </h3>
        <button class="modal-close" (click)="closeProfileModal()">&times;</button>
      </div>
      <div class="modal-body modal-scroll">
        <ng-container *ngIf="client && client.profile">
          <div class="profile-modal-content">
            <!-- Personal Info -->
            <div class="profile-section">
              <h4>Informacion Personal</h4>
              <div class="profile-grid">
                <div class="profile-item">
                  <span class="profile-label">Nombre Completo</span>
                  <span class="profile-value">{{ client.user.firstName || '' }} {{ client.user.lastName || '' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Email</span>
                  <span class="profile-value">{{ client.user.email || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">SSN</span>
                  <span class="profile-value">{{ client.profile.ssn || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Fecha de Nacimiento</span>
                  <span class="profile-value">{{ client.profile.dateOfBirth ? (client.profile.dateOfBirth | date:'dd/MM/yyyy') : 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Telefono</span>
                  <span class="profile-value">{{ client.user.phone || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="profile-section" *ngIf="client.profile.address">
              <h4>Direccion</h4>
              <div class="profile-grid">
                <div class="profile-item full-width">
                  <span class="profile-label">Direccion</span>
                  <span class="profile-value">{{ client.profile.address.street || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Ciudad</span>
                  <span class="profile-value">{{ client.profile.address.city || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Estado</span>
                  <span class="profile-value">{{ client.profile.address.state || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Codigo Postal</span>
                  <span class="profile-value">{{ client.profile.address.zip || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Employment -->
            <div class="profile-section">
              <h4>Informacion de Empleo</h4>
              <div class="profile-grid">
                <div class="profile-item">
                  <span class="profile-label">Estado donde trabajo</span>
                  <span class="profile-value">{{ client.profile.workState || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Empleador</span>
                  <span class="profile-value">{{ client.profile.employerName || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Bank Info -->
            <div class="profile-section" *ngIf="client.profile.bank">
              <h4>Informacion Bancaria</h4>
              <div class="profile-grid">
                <div class="profile-item">
                  <span class="profile-label">Banco</span>
                  <span class="profile-value">{{ client.profile.bank.name || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Routing Number</span>
                  <span class="profile-value">{{ client.profile.bank.routingNumber || 'No proporcionado' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Account Number</span>
                  <span class="profile-value">{{ client.profile.bank.accountNumber || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Tax Case Info -->
            <div class="profile-section" *ngIf="client.taxCases && client.taxCases.length > 0">
              <h4>Caso Fiscal</h4>
              <div class="profile-grid">
                <div class="profile-item">
                  <span class="profile-label">Ano Fiscal</span>
                  <span class="profile-value">{{ client.taxCases[0].taxYear || 'No disponible' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Reembolso Estimado</span>
                  <span class="profile-value">{{ client.taxCases[0].estimatedRefund ? ('$' + client.taxCases[0].estimatedRefund) : 'Pendiente' }}</span>
                </div>
                <div class="profile-item">
                  <span class="profile-label">Pago Recibido</span>
                  <span class="profile-value">{{ client.taxCases[0].paymentReceived ? 'Si' : 'No' }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <div class="empty-profile-modal" *ngIf="!client || !client.profile">
          <span class="empty-icon">üìã</span>
          <p>El cliente aun no ha completado su perfil</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeProfileModal()">Cerrar</button>
        <button class="btn-scroll-to" (click)="closeProfileModal(); scrollToSection('profile')">
          Ver Seccion Completa
        </button>
      </div>
    </div>
  </div>

  <!-- Documents Modal -->
  <div class="modal-overlay" *ngIf="showDocumentsModal" (click)="closeDocumentsModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          Documentos ({{ client?.documents?.length || 0 }})
        </h3>
        <button class="modal-close" (click)="closeDocumentsModal()">&times;</button>
      </div>
      <div class="modal-body modal-scroll">
        <!-- Document Type Tabs -->
        <div class="modal-document-tabs" *ngIf="client && client.documents && client.documents.length > 0">
          <button class="modal-doc-tab" [class.active]="modalDocumentTab === 'all'"
                  (click)="modalDocumentTab = 'all'">
            Todos <span class="tab-count">{{ getDocumentCountByType('all') }}</span>
          </button>
          <button class="modal-doc-tab" [class.active]="modalDocumentTab === 'w2'"
                  (click)="modalDocumentTab = 'w2'">
            W2 <span class="tab-count">{{ getDocumentCountByType('w2') }}</span>
          </button>
          <button class="modal-doc-tab" [class.active]="modalDocumentTab === 'payment_proof'"
                  (click)="modalDocumentTab = 'payment_proof'">
            Comprobantes <span class="tab-count">{{ getDocumentCountByType('payment_proof') }}</span>
          </button>
          <button class="modal-doc-tab" [class.active]="modalDocumentTab === 'other'"
                  (click)="modalDocumentTab = 'other'">
            Otros <span class="tab-count">{{ getDocumentCountByType('other') }}</span>
          </button>
        </div>

        <div class="modal-documents-list" *ngIf="modalFilteredDocuments.length > 0">
          <div class="modal-document-card" *ngFor="let doc of modalFilteredDocuments; trackBy: trackById">
            <div class="modal-doc-icon">{{ getFileIcon(doc.mimeType) }}</div>
            <div class="modal-doc-info">
              <div class="modal-doc-name">{{ doc.fileName }}</div>
              <div class="modal-doc-meta">
                <span class="doc-type-badge" [class]="'type-' + doc.type">{{ getDocumentTypeLabel(doc.type) }}</span>
                <span>{{ formatFileSize(doc.fileSize) }}</span>
                <span>{{ doc.uploadedAt | date:'dd/MM/yyyy HH:mm' }}</span>
                <span *ngIf="doc.isReviewed" class="reviewed-badge">Revisado</span>
              </div>
            </div>
            <button class="btn-modal-download" (click)="downloadDocument(doc)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Descargar
            </button>
          </div>
        </div>

        <div class="empty-docs-modal" *ngIf="!client || !client.documents || client.documents.length === 0">
          <span class="empty-icon">üìÅ</span>
          <p>No hay documentos subidos todavia</p>
        </div>

        <div class="empty-docs-modal" *ngIf="client && client.documents && client.documents.length > 0 && modalFilteredDocuments.length === 0">
          <span class="empty-icon">üìÅ</span>
          <p>No hay documentos de este tipo</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeDocumentsModal()">Cerrar</button>
        <button class="btn-scroll-to" (click)="closeDocumentsModal(); scrollToSection('documents')">
          Ver Seccion Completa
        </button>
      </div>
    </div>
  </div>

  <!-- Visual Review Game Modal -->
  <div class="review-game-overlay" *ngIf="showVisualReview" [class.celebrating]="reviewCelebrating">
    <div class="review-game-container">
      <!-- Progress Bar -->
      <div class="review-progress-bar">
        <div class="review-progress-fill" [style.width.%]="(currentReviewStep / 4) * 100"></div>
      </div>

      <!-- Step Indicator -->
      <div class="review-step-indicator">
        <span class="review-step-number">{{ currentReviewStep }}/4</span>
        <span class="review-step-title">{{ getReviewStepTitle() }}</span>
      </div>

      <!-- Close Button -->
      <button class="review-close-btn" (click)="closeVisualReview()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>

      <!-- Review Main Content (Split Layout) -->
      <div class="review-split-layout">
        <!-- Left: Review Cards -->
        <div class="review-cards-panel">
          <div class="review-cards-viewport">
            <div class="review-cards-track" [style.transform]="'translateX(' + (-100 * (currentReviewStep - 1)) + '%)'">

              <!-- Step 1: Formulario -->
              <div class="review-card" [class.active]="currentReviewStep === 1" [class.completed]="currentReviewStep > 1">
                <div class="review-card-header">
                  <span class="review-card-icon">üìù</span>
                  <h3>Formulario del Cliente</h3>
                </div>
                <div class="review-card-content" *ngIf="client && client.profile">
                  <div class="review-data-grid">
                    <div class="review-data-item">
                      <span class="data-label">Nombre</span>
                      <span class="data-value">{{ client.user.firstName }} {{ client.user.lastName }}</span>
                    </div>
                    <div class="review-data-item">
                      <span class="data-label">SSN</span>
                      <span class="data-value">{{ client.profile.ssn || 'N/A' }}</span>
                    </div>
                    <div class="review-data-item">
                      <span class="data-label">Fecha Nacimiento</span>
                      <span class="data-value">{{ client.profile.dateOfBirth ? (client.profile.dateOfBirth | date:'dd/MM/yyyy') : 'N/A' }}</span>
                    </div>
                    <div class="review-data-item">
                      <span class="data-label">Telefono</span>
                      <span class="data-value">{{ client.user.phone || 'N/A' }}</span>
                    </div>
                    <div class="review-data-item">
                      <span class="data-label">Estado Trabajo</span>
                      <span class="data-value">{{ client.profile.workState || 'N/A' }}</span>
                    </div>
                    <div class="review-data-item">
                      <span class="data-label">Empleador</span>
                      <span class="data-value">{{ client.profile.employerName || 'N/A' }}</span>
                    </div>
                    <div class="review-data-item full-width" *ngIf="client.profile.address">
                      <span class="data-label">Direccion</span>
                      <span class="data-value">{{ client.profile.address.street }}, {{ client.profile.address.city }}, {{ client.profile.address.state }} {{ client.profile.address.zip }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: W2 -->
              <div class="review-card" [class.active]="currentReviewStep === 2" [class.completed]="currentReviewStep > 2">
                <div class="review-card-header">
                  <span class="review-card-icon">üìÑ</span>
                  <h3>Documento W2</h3>
                </div>
                <div class="review-card-content">
                  <div class="review-docs-list">
                    <div class="review-doc-item"
                         *ngFor="let doc of getDocumentsByType('w2')"
                         [class.selected]="previewDocumentId === doc.id"
                         (click)="previewDocument(doc)">
                      <span class="doc-icon-large">{{ getFileIcon(doc.mimeType) }}</span>
                      <div class="doc-details">
                        <span class="doc-name">{{ doc.fileName }}</span>
                        <span class="doc-meta">{{ formatFileSize(doc.fileSize) }} ‚Ä¢ {{ doc.uploadedAt | date:'dd/MM/yyyy' }}</span>
                      </div>
                      <span class="doc-preview-badge" *ngIf="previewDocumentId === doc.id">Viendo</span>
                    </div>
                  </div>
                  <p class="preview-hint" *ngIf="getDocumentsByType('w2').length > 0">Click en documento para ver preview ‚Üí</p>
                </div>
              </div>

              <!-- Step 3: Comprobante -->
              <div class="review-card" [class.active]="currentReviewStep === 3" [class.completed]="currentReviewStep > 3">
                <div class="review-card-header">
                  <span class="review-card-icon">üßæ</span>
                  <h3>Comprobante de Pago</h3>
                </div>
                <div class="review-card-content">
                  <div class="review-docs-list">
                    <div class="review-doc-item"
                         *ngFor="let doc of getDocumentsByType('payment_proof')"
                         [class.selected]="previewDocumentId === doc.id"
                         (click)="previewDocument(doc)">
                      <span class="doc-icon-large">{{ getFileIcon(doc.mimeType) }}</span>
                      <div class="doc-details">
                        <span class="doc-name">{{ doc.fileName }}</span>
                        <span class="doc-meta">{{ formatFileSize(doc.fileSize) }} ‚Ä¢ {{ doc.uploadedAt | date:'dd/MM/yyyy' }}</span>
                      </div>
                      <span class="doc-preview-badge" *ngIf="previewDocumentId === doc.id">Viendo</span>
                    </div>
                  </div>
                  <p class="preview-hint" *ngIf="getDocumentsByType('payment_proof').length > 0">Click en documento para ver preview ‚Üí</p>
                </div>
              </div>

              <!-- Step 4: Consentimiento -->
              <div class="review-card" [class.active]="currentReviewStep === 4" [class.completed]="currentReviewStep > 4">
                <div class="review-card-header">
                  <span class="review-card-icon">‚úçÔ∏è</span>
                  <h3>Formulario de Consentimiento</h3>
                </div>
                <div class="review-card-content">
                  <div class="review-docs-list">
                    <div class="review-doc-item"
                         *ngFor="let doc of getDocumentsByType('consent_form')"
                         [class.selected]="previewDocumentId === doc.id"
                         (click)="previewDocument(doc)">
                      <span class="doc-icon-large">{{ getFileIcon(doc.mimeType) }}</span>
                      <div class="doc-details">
                        <span class="doc-name">{{ doc.fileName }}</span>
                        <span class="doc-meta">{{ formatFileSize(doc.fileSize) }} ‚Ä¢ {{ doc.uploadedAt | date:'dd/MM/yyyy' }}</span>
                      </div>
                      <span class="doc-preview-badge" *ngIf="previewDocumentId === doc.id">Viendo</span>
                    </div>
                  </div>
                  <p class="preview-hint" *ngIf="getDocumentsByType('consent_form').length > 0">Click en documento para ver preview ‚Üí</p>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Right: Document Preview Panel (visible on steps 2, 3, 4) -->
        <div class="review-preview-panel" *ngIf="currentReviewStep >= 2">
          <div class="preview-container" *ngIf="!previewUrl && !isLoadingPreview">
            <div class="preview-placeholder">
              <span class="preview-placeholder-icon">üëÅÔ∏è</span>
              <p>Selecciona un documento para ver preview</p>
            </div>
          </div>
          <div class="preview-loading" *ngIf="isLoadingPreview">
            <div class="loading-spinner"></div>
            <p>Cargando documento...</p>
          </div>
          <div class="preview-content" *ngIf="previewUrl && !isLoadingPreview">
            <!-- PDF Preview -->
            <iframe *ngIf="previewType === 'pdf'" [src]="previewUrl" class="preview-iframe"></iframe>
            <!-- Image Preview -->
            <img *ngIf="previewType === 'image'" [src]="previewUrl" class="preview-image" alt="Document preview"/>
            <!-- Unsupported format -->
            <div class="preview-unsupported" *ngIf="previewType === 'unsupported'">
              <span class="unsupported-icon">üìé</span>
              <p>Vista previa no disponible</p>
              <button class="btn-download-preview" (click)="downloadPreviewDocument()">Descargar Archivo</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons (during review) -->
      <div class="review-actions" *ngIf="!reviewCelebrating && !showFinalDecision">
        <button class="btn-review-back" (click)="previousReviewStep()" [disabled]="currentReviewStep === 1">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          Atras
        </button>
        <button class="btn-review-correct" (click)="approveReviewStep()" [class.pulse]="!reviewStepApproved[currentReviewStep]">
          <span class="correct-icon">‚úì</span>
          <span>CORRECTO</span>
        </button>
      </div>

      <!-- Final Decision Screen (after all 4 steps approved) -->
      <div class="review-final-decision" *ngIf="showFinalDecision && !reviewCelebrating">
        <div class="final-decision-content">
          <div class="decision-icon">‚öñÔ∏è</div>
          <h2>Decision Final</h2>
          <p>Has verificado los 4 documentos del cliente</p>
          <div class="decision-buttons">
            <button class="btn-decision-reject" (click)="rejectReview()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
              <span>PROBLEMA DETECTADO</span>
            </button>
            <button class="btn-decision-accept" (click)="acceptReview()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              <span>ACEPTAR</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Celebration Screen -->
      <div class="review-celebration" *ngIf="reviewCelebrating">
        <div class="celebration-content">
          <div class="celebration-icon">üéâ</div>
          <h2>¬°Revision Completada!</h2>
          <p>Todos los documentos han sido verificados</p>
          <div class="celebration-stats">
            <div class="stat-item">
              <span class="stat-value">4/4</span>
              <span class="stat-label">Documentos OK</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ client?.user?.firstName }}</span>
              <span class="stat-label">Cliente</span>
            </div>
          </div>
          <button class="btn-celebration-close" (click)="finishVisualReview()">
            <span>LISTO PARA PREPARAR</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>
        <div class="confetti-container">
          <div class="confetti" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12]"></div>
        </div>
      </div>
    </div>
  </div>
</div>
