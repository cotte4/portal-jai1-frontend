<div class="client-detail-container">
  <!-- Header -->
  <header class="detail-header">
    <div class="header-content">
      <button class="btn-back" (click)="goBack()">
        <span class="back-icon">‚Üê</span>
        <span>Volver al Dashboard</span>
      </button>
      <div class="logo">JAI1</div>
    </div>
  </header>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando datos del cliente...</p>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- Success Message -->
  <div class="success-message" *ngIf="successMessage">
    {{ successMessage }}
  </div>

  <!-- Main Content -->
  <main class="detail-main" *ngIf="client && !isLoading">
    <!-- Client Info Header -->
    <div class="client-header">
      <div class="client-avatar-large">
        {{ client.user.firstName.charAt(0) || '?' }}{{ client.user.lastName.charAt(0) || '?' }}
      </div>
      <div class="client-info">
        <h1>{{ client.user.firstName || 'Sin nombre' }} {{ client.user.lastName || '' }}</h1>
        <div class="client-meta">
          <span class="meta-item">
            <span class="meta-icon">üìß</span>
            {{ client.user.email || 'Sin email' }}
          </span>
          <span class="meta-item" *ngIf="client.user.phone">
            <span class="meta-icon">üì±</span>
            {{ client.user.phone }}
          </span>
          <span class="meta-item">
            <span class="meta-icon">üìÖ</span>
            Registrado: {{ client.user.createdAt | date:'dd/MM/yyyy' }}
          </span>
        </div>
      </div>
      <!-- Status display - use Status Section below for changes -->
      <div class="status-control">
        <span class="phase-badge" *ngIf="!taxesFiled">Pre-Presentacion</span>
        <span class="phase-badge filed" *ngIf="taxesFiled">Taxes Presentados</span>
        <span class="status-info" *ngIf="selectedFederalStatusNew">Fed: {{ getFederalStatusNewLabel(selectedFederalStatusNew) }}</span>
        <span class="status-info" *ngIf="selectedStateStatusNew">Est: {{ getStateStatusNewLabel(selectedStateStatusNew) }}</span>
      </div>
    </div>

    <!-- Actions Section (Problem + Notify) -->
    <section class="actions-section" *ngIf="client.taxCases && client.taxCases.length > 0">
      <div class="actions-header">
        <h3>Acciones</h3>
        <div class="actions-buttons">
          <button class="btn-problem" [class.has-problem]="hasProblem" (click)="openProblemModal()">
            <span *ngIf="hasProblem" class="problem-indicator"></span>
            {{ hasProblem ? 'Ver Problema' : 'Marcar Problema' }}
          </button>
          <button class="btn-notify" (click)="openNotifyModal()">
            Enviar Notificacion
          </button>
        </div>
      </div>
      <div class="problem-banner" *ngIf="hasProblem">
        <span class="problem-icon">!</span>
        <div class="problem-info">
          <strong>{{ getProblemTypeLabel(selectedProblemType) }}</strong>
          <p *ngIf="problemDescription">{{ problemDescription }}</p>
        </div>
        <button class="btn-resolve" (click)="resolveProblem()" [disabled]="isSaving">
          {{ isSaving ? 'Resolviendo...' : 'Resolver' }}
        </button>
      </div>
      <!-- NEW: Alarms Banner -->
      <div class="alarms-banner" *ngIf="taxCaseAlarms.length > 0">
        <div class="alarms-header">
          <span class="alarm-icon" [class.critical]="hasCriticalAlarm">‚ö†Ô∏è</span>
          <strong>{{ taxCaseAlarms.length }} Alerta{{ taxCaseAlarms.length > 1 ? 's' : '' }}</strong>
        </div>
        <div class="alarms-list">
          <div class="alarm-item" *ngFor="let alarm of taxCaseAlarms; trackBy: trackByIndex"
               [class]="getAlarmLevelClass(alarm.level)">
            <span class="alarm-track">{{ alarm.track === 'federal' ? 'ü¶Ö Fed' : 'üóΩ Est' }}</span>
            <span class="alarm-message">{{ alarm.message }}</span>
            <span class="alarm-days">{{ alarm.daysSinceStatusChange }} d√≠as</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Phase-Based Status Section -->
    <section class="phase-status-section" *ngIf="client.taxCases && client.taxCases.length > 0">
      <div class="section-header">
        <div class="section-title">
          <span class="section-icon">üìä</span>
          <h2>Estado del Caso</h2>
        </div>
        <div class="phase-indicator" [class.filed]="taxesFiled">
          <span class="phase-badge" *ngIf="!taxesFiled">Pre-Presentacion</span>
          <span class="phase-badge filed" *ngIf="taxesFiled">Taxes Presentados</span>
        </div>
      </div>

      <!-- Pre-Filing Phase UI -->
      <div class="pre-filing-section" *ngIf="!taxesFiled">
        <div class="pre-filing-card">
          <div class="pre-filing-header">
            <span class="pre-filing-icon">üìù</span>
            <h3>Estado del Caso</h3>
            <span class="status-badge-large" [class]="'status-' + selectedCaseStatus">
              {{ getCaseStatusLabel(selectedCaseStatus) }}
            </span>
          </div>
          <div class="pre-filing-body">
            <div class="pre-filing-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedCaseStatus">
                <option [ngValue]="null">Sin estado</option>
                <option *ngFor="let status of filteredCaseStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getCaseStatusLabel(status) }}
                </option>
              </select>
            </div>
            <button class="btn-update-prefiling" (click)="updateCaseStatus()" [disabled]="isSavingPreFiling || !selectedCaseStatus">
              {{ isSavingPreFiling ? 'Guardando...' : 'Actualizar Estado' }}
            </button>
          </div>
        </div>

        <div class="mark-filed-card">
          <div class="mark-filed-header">
            <span class="mark-filed-icon">‚úÖ</span>
            <h3>Marcar como Presentado</h3>
          </div>
          <div class="mark-filed-body">
            <p class="mark-filed-description">
              Cuando los taxes hayan sido presentados al IRS, marque esta casilla e ingrese la fecha.
            </p>
            <div class="mark-filed-field">
              <label>Fecha de Presentacion</label>
              <input type="date" [(ngModel)]="taxesFiledAt">
            </div>
            <button class="btn-mark-filed" (click)="markTaxesAsFiled()" [disabled]="isMarkingFiled || !taxesFiledAt">
              {{ isMarkingFiled ? 'Procesando...' : 'Marcar Taxes como Presentados' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Filed Date Display (when already filed) -->
      <div class="filed-info" *ngIf="taxesFiled && taxesFiledAt">
        <span class="filed-icon">üìÖ</span>
        <span class="filed-text">Presentado el {{ taxesFiledAt | date:'dd/MM/yyyy' }}</span>
      </div>
    </section>

    <!-- Federal/State Tracking Section (only show when taxesFiled) -->
    <section class="federal-state-section" *ngIf="client.taxCases && client.taxCases.length > 0 && taxesFiled">
      <div class="section-header">
        <div class="section-title">
          <span class="section-icon">üèõÔ∏è</span>
          <h2>Seguimiento Federal / Estatal</h2>
        </div>
      </div>

      <div class="federal-state-grid">
        <!-- Case Status -->
        <div class="track-card case-status-card" style="grid-column: span 2;">
          <div class="track-header">
            <span class="track-icon">üìä</span>
            <h3>Estado del Caso</h3>
            <span class="track-status" [class]="'status-' + (selectedCaseStatus || 'pending')">
              {{ getCaseStatusLabel(selectedCaseStatus) }}
            </span>
          </div>
          <div class="track-body">
            <div class="track-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedCaseStatus">
                <option [ngValue]="null">Sin estado</option>
                <option *ngFor="let status of filteredCaseStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getCaseStatusLabel(status) }}
                </option>
              </select>
            </div>
            <button class="btn-track-update" (click)="updateCaseStatus()" [disabled]="isSavingPreFiling || !selectedCaseStatus">
              {{ isSavingPreFiling ? 'Guardando...' : 'Actualizar Estado' }}
            </button>
          </div>
        </div>

        <!-- Federal Track -->
        <div class="track-card federal-track">
          <div class="track-header">
            <span class="track-icon">ü¶Ö</span>
            <h3>Federal</h3>
            <span class="track-status" [class]="'status-' + (selectedFederalStatusNew || 'pending')">
              {{ getFederalStatusNewLabel(selectedFederalStatusNew) }}
            </span>
          </div>
          <div class="track-body">
            <div class="track-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedFederalStatusNew">
                <option [ngValue]="null">Sin estado</option>
                <option *ngFor="let status of filteredFederalStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getFederalStatusNewLabel(status) }}
                </option>
              </select>
            </div>
            <div class="track-field">
              <label>Fecha Estimada</label>
              <input type="date" [(ngModel)]="federalEstimatedDate">
            </div>
            <div class="track-field">
              <label>Monto Real ($)</label>
              <input type="number" [(ngModel)]="federalActualRefund" placeholder="0.00" step="0.01">
            </div>
            <div class="track-field">
              <label>Fecha Deposito</label>
              <input type="date" [(ngModel)]="federalDepositDate">
            </div>
            <div class="track-field full-width">
              <label>Comentario</label>
              <input type="text" [(ngModel)]="federalComment" placeholder="Agregar comentario...">
            </div>
            <button class="btn-track-update" (click)="updateFederalStatusNew()" [disabled]="isSavingFederal">
              {{ isSavingFederal ? 'Guardando...' : 'Actualizar Federal' }}
            </button>
          </div>
        </div>

        <!-- State Track -->
        <div class="track-card state-track">
          <div class="track-header">
            <span class="track-icon">üóΩ</span>
            <h3>Estatal</h3>
            <span class="track-status" [class]="'status-' + (selectedStateStatusNew || 'pending')">
              {{ getStateStatusNewLabel(selectedStateStatusNew) }}
            </span>
          </div>
          <div class="track-body">
            <div class="track-field">
              <label>Estado</label>
              <select [(ngModel)]="selectedStateStatusNew">
                <option [ngValue]="null">Sin estado</option>
                <option *ngFor="let status of filteredStateStatusOptions; trackBy: trackByIndex" [ngValue]="status">
                  {{ getStateStatusNewLabel(status) }}
                </option>
              </select>
            </div>
            <div class="track-field">
              <label>Fecha Estimada</label>
              <input type="date" [(ngModel)]="stateEstimatedDate">
            </div>
            <div class="track-field">
              <label>Monto Real ($)</label>
              <input type="number" [(ngModel)]="stateActualRefund" placeholder="0.00" step="0.01">
            </div>
            <div class="track-field">
              <label>Fecha Deposito</label>
              <input type="date" [(ngModel)]="stateDepositDate">
            </div>
            <div class="track-field full-width">
              <label>Comentario</label>
              <input type="text" [(ngModel)]="stateComment" placeholder="Agregar comentario...">
            </div>
            <button class="btn-track-update" (click)="updateStateStatusNew()" [disabled]="isSavingState">
              {{ isSavingState ? 'Guardando...' : 'Actualizar Estatal' }}
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-action btn-paid" (click)="markPaid()" [disabled]="isMarkingPaid" *ngIf="client.taxCases && client.taxCases.length > 0 && !client.taxCases[0].paymentReceived">
        @if (isMarkingPaid) {
          <span class="spinner"></span>
          <span>Procesando...</span>
        } @else {
          Marcar Pago Recibido
        }
      </button>
      <button class="btn-action btn-delete" (click)="deleteClient()" [disabled]="isDeleting">
        @if (isDeleting) {
          <span class="spinner"></span>
          <span>Eliminando...</span>
        } @else {
          Eliminar Cliente
        }
      </button>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Profile Section -->
        <section class="detail-section">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üìã</span>
              <h2>Perfil del Cliente</h2>
            </div>
          </div>

          <div class="form-preview" *ngIf="client.profile">
            <!-- Personal Info -->
            <div class="form-group-preview">
              <h3>Informacion Personal</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Nombre Completo</span>
                  <span class="info-value">{{ client.user.firstName || '' }} {{ client.user.lastName || '' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">SSN</span>
                  <span class="info-value">{{ client.profile.ssn || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Fecha de Nacimiento</span>
                  <span class="info-value">{{ client.profile.dateOfBirth ? (client.profile.dateOfBirth | date:'dd/MM/yyyy') : 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Telefono</span>
                  <span class="info-value">{{ client.user.phone || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="form-group-preview" *ngIf="client.profile.address">
              <h3>Direccion</h3>
              <div class="info-grid">
                <div class="info-item full-width">
                  <span class="info-label">Direccion</span>
                  <span class="info-value">{{ client.profile.address.street || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Ciudad</span>
                  <span class="info-value">{{ client.profile.address.city || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Estado</span>
                  <span class="info-value">{{ client.profile.address.state || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Codigo Postal</span>
                  <span class="info-value">{{ client.profile.address.zip || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Employment -->
            <div class="form-group-preview">
              <h3>Informacion de Empleo</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Estado donde trabajo</span>
                  <span class="info-value">{{ client.profile.workState || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Empleador</span>
                  <span class="info-value">{{ client.profile.employerName || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Bank Info -->
            <div class="form-group-preview" *ngIf="client.profile.bank">
              <h3>Informacion Bancaria</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Banco</span>
                  <span class="info-value">{{ client.profile.bank.name || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Routing Number</span>
                  <span class="info-value">{{ client.profile.bank.routingNumber || 'No proporcionado' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Account Number</span>
                  <span class="info-value">{{ client.profile.bank.accountNumber || 'No proporcionado' }}</span>
                </div>
              </div>
            </div>

            <!-- Client Accounts (Credentials) -->
            <div class="form-group-preview accounts-section">
              <h3>
                <span class="section-icon-small">üîê</span>
                Cuentas del Cliente
              </h3>
              <div class="accounts-grid">
                <!-- TurboTax -->
                <div class="account-card turbotax-card">
                  <div class="account-header">
                    <span class="account-icon">üìä</span>
                    <span class="account-name">TurboTax</span>
                  </div>
                  <div class="account-credentials" *ngIf="client.profile.turbotaxEmail || client.profile.turbotaxPassword">
                    <div class="credential-row">
                      <span class="credential-label">Email</span>
                      <span class="credential-value" [class.masked]="!showTurbotaxCredentials">
                        {{ showTurbotaxCredentials ? (client.profile.turbotaxEmail || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <div class="credential-row">
                      <span class="credential-label">Password</span>
                      <span class="credential-value" [class.masked]="!showTurbotaxCredentials">
                        {{ showTurbotaxCredentials ? (client.profile.turbotaxPassword || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <button class="btn-show-credentials" (click)="toggleTurbotaxCredentials()">
                      {{ showTurbotaxCredentials ? 'Ocultar' : 'Mostrar' }}
                    </button>
                  </div>
                  <div class="account-empty" *ngIf="!client.profile.turbotaxEmail && !client.profile.turbotaxPassword">
                    <span class="empty-text">No configurado</span>
                  </div>
                </div>

                <!-- IRS -->
                <div class="account-card irs-card">
                  <div class="account-header">
                    <span class="account-icon">üèõÔ∏è</span>
                    <span class="account-name">IRS</span>
                  </div>
                  <div class="account-credentials" *ngIf="client.profile.irsUsername || client.profile.irsPassword">
                    <div class="credential-row">
                      <span class="credential-label">Usuario</span>
                      <span class="credential-value" [class.masked]="!showIrsCredentials">
                        {{ showIrsCredentials ? (client.profile.irsUsername || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <div class="credential-row">
                      <span class="credential-label">Password</span>
                      <span class="credential-value" [class.masked]="!showIrsCredentials">
                        {{ showIrsCredentials ? (client.profile.irsPassword || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <button class="btn-show-credentials" (click)="toggleIrsCredentials()">
                      {{ showIrsCredentials ? 'Ocultar' : 'Mostrar' }}
                    </button>
                  </div>
                  <div class="account-empty" *ngIf="!client.profile.irsUsername && !client.profile.irsPassword">
                    <span class="empty-text">No configurado</span>
                  </div>
                </div>

                <!-- State -->
                <div class="account-card state-card">
                  <div class="account-header">
                    <span class="account-icon">üóΩ</span>
                    <span class="account-name">Estado</span>
                  </div>
                  <div class="account-credentials" *ngIf="client.profile.stateUsername || client.profile.statePassword">
                    <div class="credential-row">
                      <span class="credential-label">Usuario</span>
                      <span class="credential-value" [class.masked]="!showStateCredentials">
                        {{ showStateCredentials ? (client.profile.stateUsername || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <div class="credential-row">
                      <span class="credential-label">Password</span>
                      <span class="credential-value" [class.masked]="!showStateCredentials">
                        {{ showStateCredentials ? (client.profile.statePassword || 'No configurado') : '********' }}
                      </span>
                    </div>
                    <button class="btn-show-credentials" (click)="toggleStateCredentials()">
                      {{ showStateCredentials ? 'Ocultar' : 'Mostrar' }}
                    </button>
                  </div>
                  <div class="account-empty" *ngIf="!client.profile.stateUsername && !client.profile.statePassword">
                    <span class="empty-text">No configurado</span>
                  </div>
                </div>
              </div>
              <button class="btn-edit-credentials" (click)="openCredentialsModal()">
                Editar Credenciales
              </button>
            </div>

            <!-- Tax Case Info -->
            <div class="form-group-preview" *ngIf="client.taxCases && client.taxCases.length > 0">
              <h3>Caso Fiscal</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Ano Fiscal</span>
                  <span class="info-value">{{ client.taxCases[0]?.taxYear || 'No disponible' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Reembolso Estimado</span>
                  <span class="info-value">{{ client.taxCases[0]?.estimatedRefund ? ('$' + client.taxCases[0].estimatedRefund) : 'Pendiente' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Pago Recibido</span>
                  <span class="info-value">{{ client.taxCases[0]?.paymentReceived ? 'Si' : 'No' }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="empty-form" *ngIf="!client.profile">
            <span class="empty-icon">üìã</span>
            <p>El cliente aun no ha completado su perfil</p>
          </div>
        </section>

        <!-- Documents Section -->
        <section class="detail-section">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üìÅ</span>
              <h2>Documentos ({{ client.documents.length || 0 }})</h2>
            </div>
          </div>

          <!-- Document Type Tabs -->
          <div class="document-tabs" *ngIf="client.documents && client.documents.length > 0">
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'all'"
                    (click)="selectDocumentTab('all')">
              Todos <span class="tab-count">{{ getDocumentCountByType('all') }}</span>
            </button>
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'w2'"
                    (click)="selectDocumentTab('w2')">
              W2 <span class="tab-count">{{ getDocumentCountByType('w2') }}</span>
            </button>
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'payment_proof'"
                    (click)="selectDocumentTab('payment_proof')">
              Comprobantes <span class="tab-count">{{ getDocumentCountByType('payment_proof') }}</span>
            </button>
            <button class="doc-tab" [class.active]="selectedDocumentTab === 'other'"
                    (click)="selectDocumentTab('other')">
              Otros <span class="tab-count">{{ getDocumentCountByType('other') }}</span>
            </button>
          </div>

          <div class="documents-list" *ngIf="filteredDocuments.length > 0">
            <div class="document-card" *ngFor="let doc of filteredDocuments; trackBy: trackById">
              <div class="doc-icon">{{ getFileIcon(doc.mimeType) }}</div>
              <div class="doc-info">
                <div class="doc-name">{{ doc.fileName }}</div>
                <div class="doc-meta">
                  {{ formatFileSize(doc.fileSize) }} | {{ doc.uploadedAt | date:'dd/MM/yyyy HH:mm' }}
                  <span *ngIf="doc.isReviewed" class="reviewed-badge">Revisado</span>
                </div>
              </div>
              <button class="btn-doc-download" (click)="downloadDocument(doc)">
                Descargar
              </button>
            </div>
          </div>

          <div class="empty-docs" *ngIf="!client.documents || client.documents.length === 0">
            <span class="empty-icon">üìÅ</span>
            <p>No hay documentos subidos todavia</p>
          </div>

          <div class="empty-docs" *ngIf="client.documents && client.documents.length > 0 && filteredDocuments.length === 0">
            <span class="empty-icon">üìÅ</span>
            <p>No hay documentos de este tipo</p>
          </div>
        </section>

        <!-- Status History -->
        <section class="detail-section" *ngIf="client.statusHistory && client.statusHistory.length > 0">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üìú</span>
              <h2>Historial de Estados ({{ client.statusHistory.length }})</h2>
            </div>
          </div>

          <div class="status-history-timeline">
            <div class="history-item" *ngFor="let history of client.statusHistory; let i = index; trackBy: trackById">
              <div class="history-marker">
                <div class="marker-dot" [class.first]="i === 0"></div>
                <div class="marker-line" *ngIf="i < client.statusHistory.length - 1"></div>
              </div>
              <div class="history-content">
                <div class="history-header">
                  <span class="history-date">
                    <span class="date-icon">üìÖ</span>
                    {{ history.createdAt | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                  <span class="history-admin" *ngIf="history.changedBy">
                    <span class="admin-icon">üë§</span>
                    {{ history.changedBy.firstName || '' }} {{ history.changedBy.lastName || '' }}
                  </span>
                </div>
                <div class="history-change">
                  <span class="status-badge-history old">{{ getHistoryStatusLabel(history.previousStatus) }}</span>
                  <span class="arrow-icon">‚Üí</span>
                  <span class="status-badge-history new">{{ getHistoryStatusLabel(history.newStatus) }}</span>
                </div>
                <div class="history-comment" *ngIf="history.comment">
                  <span class="comment-icon">üí¨</span>
                  <span class="comment-text">"{{ history.comment }}"</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Right Column - Tickets -->
      <div class="right-column">
        <section class="messages-section">
          <div class="section-header">
            <div class="section-title">
              <span class="section-icon">üí¨</span>
              <h2>Tickets de Soporte</h2>
            </div>
          </div>

          <div class="tickets-list" *ngIf="tickets.length > 0">
            <div class="ticket-card"
                 *ngFor="let ticket of tickets; trackBy: trackById"
                 [class.selected]="selectedTicketId === ticket.id"
                 (click)="selectTicket(ticket.id)">
              <div class="ticket-subject">{{ ticket.subject }}</div>
              <div class="ticket-status">{{ ticket.status }}</div>
              <div class="ticket-date">{{ ticket.createdAt | date:'dd/MM HH:mm' }}</div>
            </div>
          </div>

          <div class="messages-container" *ngIf="selectedTicket">
            <div class="messages-list">
              <div class="message-item"
                   *ngFor="let msg of selectedTicket.messages; trackBy: trackById"
                   [class.admin-message]="msg.sender?.role === 'admin'"
                   [class.client-message]="msg.sender?.role !== 'admin'">
                <div class="message-header">
                  <span class="sender-name">{{ msg.sender?.firstName || 'Usuario' }}</span>
                  <span class="message-date">{{ msg.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                <div class="message-text">{{ msg.message }}</div>
              </div>
            </div>

            <!-- Ticket Messages -->
            <div class="ticket-error-message" *ngIf="ticketErrorMessage">
              {{ ticketErrorMessage }}
            </div>
            <div class="ticket-success-message" *ngIf="ticketSuccessMessage">
              {{ ticketSuccessMessage }}
            </div>

            <div class="message-input">
              <textarea
                [(ngModel)]="newMessage"
                placeholder="Escribe tu respuesta..."
                rows="3"
                [disabled]="isSendingMessage"
                (keydown.enter)="sendMessage(); $event.preventDefault()"
              ></textarea>
              <button class="btn-send" (click)="sendMessage()" [disabled]="!newMessage.trim() || isSendingMessage">
                <span>{{ isSendingMessage ? 'Enviando...' : 'Enviar' }}</span>
                <span class="send-icon" *ngIf="!isSendingMessage">-></span>
              </button>
            </div>
          </div>

          <div class="empty-messages" *ngIf="tickets.length === 0">
            <span class="empty-icon">üí¨</span>
            <p>No hay tickets de soporte</p>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Problem Modal -->
  <div class="modal-overlay" *ngIf="showProblemModal" (click)="closeProblemModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ hasProblem ? 'Problema Actual' : 'Marcar Problema' }}</h3>
        <button class="modal-close" (click)="closeProblemModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" *ngIf="!hasProblem">
          <label>Tipo de Problema</label>
          <select [(ngModel)]="selectedProblemType">
            <option [ngValue]="null" disabled>Seleccione un tipo...</option>
            <option *ngFor="let type of problemTypeOptions; trackBy: trackByIndex" [ngValue]="type">
              {{ getProblemTypeLabel(type) }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Descripcion</label>
          <textarea
            [(ngModel)]="problemDescription"
            placeholder="Describa el problema..."
            rows="4"
            [readonly]="hasProblem"
          ></textarea>
        </div>
        <div class="current-problem-info" *ngIf="hasProblem">
          <div class="info-row">
            <span class="info-label">Tipo:</span>
            <span class="info-value">{{ getProblemTypeLabel(selectedProblemType) }}</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeProblemModal()">Cancelar</button>
        <button
          *ngIf="!hasProblem"
          class="btn-save"
          (click)="saveProblem()"
          [disabled]="isSaving || !selectedProblemType"
        >
          {{ isSaving ? 'Guardando...' : 'Guardar Problema' }}
        </button>
        <button
          *ngIf="hasProblem"
          class="btn-resolve-modal"
          (click)="resolveProblem()"
          [disabled]="isSaving"
        >
          {{ isSaving ? 'Resolviendo...' : 'Marcar como Resuelto' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Modal -->
  <div class="modal-overlay" *ngIf="showNotifyModal" (click)="closeNotifyModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Enviar Notificacion al Cliente</h3>
        <button class="modal-close" (click)="closeNotifyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Titulo</label>
          <input
            type="text"
            [(ngModel)]="notifyTitle"
            placeholder="Titulo de la notificacion..."
          />
        </div>
        <div class="form-group">
          <label>Mensaje</label>
          <textarea
            [(ngModel)]="notifyMessage"
            placeholder="Escriba el mensaje..."
            rows="4"
          ></textarea>
        </div>
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="notifySendEmail" />
            <span>Enviar tambien por email</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeNotifyModal()">Cancelar</button>
        <button
          class="btn-save"
          (click)="sendNotification()"
          [disabled]="isSaving || !notifyTitle.trim() || !notifyMessage.trim()"
        >
          {{ isSaving ? 'Enviando...' : 'Enviar Notificacion' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Status Update Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showStatusConfirmModal" (click)="closeStatusConfirmModal()">
    <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmar Cambio de Estado</h3>
        <button class="modal-close" (click)="closeStatusConfirmModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="confirm-question">Use los controles de estado Federal/Estatal en la seccion "Estado del Caso" para actualizar el estado.</p>

        <div class="status-change-preview">
          <p>Este modal ya no se utiliza. Los estados se actualizan directamente desde los controles Federal y Estatal.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeStatusConfirmModal()">Cancelar</button>
        <button
          class="btn-save"
          (click)="confirmStatusUpdate()"
          [disabled]="isSaving"
        >
          {{ isSaving ? 'Actualizando...' : 'Confirmar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Credentials Edit Modal -->
  <div class="modal-overlay" *ngIf="showCredentialsModal" (click)="closeCredentialsModal()">
    <div class="modal-content modal-credentials" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar Credenciales del Cliente</h3>
        <button class="modal-close" (click)="closeCredentialsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- TurboTax -->
        <div class="credentials-group">
          <h4><span class="group-icon">üìä</span> TurboTax</h4>
          <div class="form-group">
            <label>Email</label>
            <input type="text" [(ngModel)]="editTurbotaxEmail" placeholder="Email de TurboTax">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="text" [(ngModel)]="editTurbotaxPassword" placeholder="Password de TurboTax">
          </div>
        </div>

        <!-- IRS -->
        <div class="credentials-group">
          <h4><span class="group-icon">üèõÔ∏è</span> IRS</h4>
          <div class="form-group">
            <label>Usuario</label>
            <input type="text" [(ngModel)]="editIrsUsername" placeholder="Usuario del IRS">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="text" [(ngModel)]="editIrsPassword" placeholder="Password del IRS">
          </div>
        </div>

        <!-- State -->
        <div class="credentials-group">
          <h4><span class="group-icon">üóΩ</span> Estado</h4>
          <div class="form-group">
            <label>Usuario</label>
            <input type="text" [(ngModel)]="editStateUsername" placeholder="Usuario del Estado">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="text" [(ngModel)]="editStatePassword" placeholder="Password del Estado">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeCredentialsModal()">Cancelar</button>
        <button
          class="btn-save"
          (click)="saveCredentials()"
          [disabled]="isSavingCredentials"
        >
          {{ isSavingCredentials ? 'Guardando...' : 'Guardar Credenciales' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Mark Paid Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showMarkPaidConfirm" (click)="cancelMarkPaid()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmar Pago Recibido</h3>
        <button class="modal-close" (click)="cancelMarkPaid()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="confirm-question">¬øEstas seguro de marcar el pago como recibido?</p>
        <p class="confirm-warning">Esta accion registrara que el cliente ha pagado la comision.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelMarkPaid()">Cancelar</button>
        <button class="btn-confirm-action" (click)="confirmMarkPaid()" [disabled]="isMarkingPaid">
          {{ isMarkingPaid ? 'Procesando...' : 'Confirmar Pago' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Mark Filed Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showMarkFiledConfirm" (click)="cancelMarkFiled()">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmar Presentacion de Taxes</h3>
        <button class="modal-close" (click)="cancelMarkFiled()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="confirm-question">¬øEstas seguro de marcar los taxes como presentados?</p>
        <p class="confirm-warning">Esta accion cambiara el estado del caso a "Taxes Presentados" con fecha {{ taxesFiledAt | date:'dd/MM/yyyy' }}.</p>
        <p class="confirm-info">Los estados Federal y Estatal se estableceran como "Presentado".</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelMarkFiled()">Cancelar</button>
        <button class="btn-confirm-action filed" (click)="confirmMarkFiled()" [disabled]="isMarkingFiled">
          {{ isMarkingFiled ? 'Procesando...' : 'Confirmar Presentacion' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Status Override Modal -->
  <div class="modal-overlay" *ngIf="showOverrideModal" (click)="closeOverrideModal()">
    <div class="modal-content override-modal" (click)="$event.stopPropagation()">
      <div class="modal-header override-header">
        <h3>Transicion de Estado No Permitida</h3>
        <button class="modal-close" (click)="closeOverrideModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="override-warning-banner">
          <span class="warning-icon">!</span>
          <p>{{ overrideError?.message }}</p>
        </div>

        <div class="override-details" *ngIf="overrideError">
          <div class="detail-row">
            <span class="detail-label">Estado actual:</span>
            <span class="detail-value current">{{ overrideError.currentStatus || 'Sin estado' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Estado intentado:</span>
            <span class="detail-value attempted">{{ overrideError.attemptedStatus }}</span>
          </div>
          <div class="detail-row" *ngIf="overrideError.allowedTransitions.length > 0">
            <span class="detail-label">Transiciones permitidas:</span>
            <div class="allowed-transitions">
              <span class="allowed-status" *ngFor="let status of overrideError.allowedTransitions">{{ status }}</span>
            </div>
          </div>
        </div>

        <div class="override-form">
          <p class="override-instruction">Para forzar esta transicion, proporcione una razon (minimo 10 caracteres):</p>
          <div class="form-group">
            <label>Razon del Override</label>
            <textarea
              [(ngModel)]="overrideReason"
              placeholder="Explique por que es necesario forzar esta transicion de estado..."
              rows="4"
              [class.invalid]="overrideReason.length > 0 && overrideReason.length < 10"
            ></textarea>
            <span class="char-count" [class.invalid]="overrideReason.length > 0 && overrideReason.length < 10">
              {{ overrideReason.length }}/10 caracteres minimos
            </span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeOverrideModal()">Cancelar</button>
        <button
          class="btn-override"
          (click)="confirmOverride()"
          [disabled]="overrideReason.length < 10"
        >
          Forzar Transicion
        </button>
      </div>
    </div>
  </div>
</div>
