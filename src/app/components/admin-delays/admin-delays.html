<div class="delays-container" [class.dark-mode]="darkMode">
  <!-- Header -->
  <header class="page-header">
    <div class="header-left">
      <button class="btn-back" (click)="goBack()">‚Üê Volver</button>
      <h1>Vista de Demoras</h1>
    </div>
    <div class="header-right">
      <button class="help-toggle" (click)="toggleHelp()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        {{ showHelp ? 'Ocultar ayuda' : 'Ayuda' }}
      </button>
      <button class="btn-export" (click)="exportToExcel()" [disabled]="isExporting || clients.length === 0">
        {{ isExporting ? 'Exportando...' : 'Exportar Excel' }}
      </button>
      <button class="btn-refresh" (click)="refreshData()" [disabled]="isLoading">
        {{ isLoading ? 'Cargando...' : 'Actualizar' }}
      </button>
    </div>
  </header>

  <!-- Help Banner -->
  <div class="help-banner" *ngIf="showHelp">
    <div class="help-section">
      <h3>Que es esto?</h3>
      <p>Esta vista muestra cuanto tiempo tarda cada cliente en recibir su reembolso despues de que se presentaron los taxes. Te permite identificar demoras inusuales y hacer seguimiento.</p>
    </div>

    <div class="help-section">
      <h3>Que significa cada columna</h3>
      <div class="help-columns">
        <div class="help-column-item">
          <strong>Docs Completos</strong>
          <span>Fecha en que el cliente completo toda la documentacion necesaria.</span>
        </div>
        <div class="help-column-item">
          <strong>Presentacion</strong>
          <span>Fecha en que se presentaron los taxes al IRS/estado.</span>
        </div>
        <div class="help-column-item">
          <strong>Recibo Federal / Estatal</strong>
          <span>Fecha en que se deposito el reembolso federal o estatal.</span>
        </div>
        <div class="help-column-item">
          <strong>Verificacion</strong>
          <span>Indica si el caso paso por verificacion del IRS (puede causar demoras significativas).</span>
        </div>
        <div class="help-column-item">
          <strong>Demora Federal / Estatal</strong>
          <span>Dias entre la presentacion y el deposito del reembolso. Si no hay deposito aun, muestra "---".</span>
        </div>
      </div>
    </div>

    <div class="help-section">
      <h3>Colores de demora</h3>
      <div class="color-legend">
        <div class="legend-item">
          <span class="legend-badge delay-fast">14 dias</span>
          <span class="legend-text">Rapido - Dentro de lo esperado (hasta 14 dias)</span>
        </div>
        <div class="legend-item">
          <span class="legend-badge delay-normal">25 dias</span>
          <span class="legend-text">Normal - Dentro del rango habitual (15-30 dias)</span>
        </div>
        <div class="legend-item">
          <span class="legend-badge delay-slow">45 dias</span>
          <span class="legend-text">Lento - Demora inusual, verificar con IRS/estado (mas de 30 dias)</span>
        </div>
      </div>
    </div>

    <div class="help-section">
      <h3>Estadisticas</h3>
      <div class="help-columns">
        <div class="help-column-item">
          <strong>Clientes Cargados</strong>
          <span>Total de clientes con taxes presentados en esta vista.</span>
        </div>
        <div class="help-column-item">
          <strong>Promedio Demora</strong>
          <span>Promedio de dias entre presentacion y deposito (solo clientes con deposito recibido).</span>
        </div>
        <div class="help-column-item">
          <strong>Atravesaron Verificacion</strong>
          <span>Cantidad de clientes cuyo caso paso por verificacion del IRS o estado.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row" *ngIf="hasLoaded && !errorMessage">
    <div class="stat-card">
      <div class="stat-value">{{ clients.length }}</div>
      <div class="stat-label">Clientes Cargados</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ avgFederalDelay }} dias</div>
      <div class="stat-label">Promedio Demora Federal</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ avgStateDelay }} dias</div>
      <div class="stat-label">Promedio Demora Estatal</div>
    </div>
    <div class="stat-card highlight">
      <div class="stat-value">{{ federalVerificationCount }}</div>
      <div class="stat-label">Verif. Federal</div>
    </div>
    <div class="stat-card highlight">
      <div class="stat-value">{{ stateVerificationCount }}</div>
      <div class="stat-label">Verif. Estatal</div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-banner" *ngIf="errorMessage">
    <span>{{ errorMessage }}</span>
    <button class="btn-retry" (click)="refreshData()">Reintentar</button>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading && !hasLoaded">
    <div class="spinner"></div>
    <p>Cargando datos de demoras...</p>
  </div>

  <!-- Content -->
  <div class="content-section" *ngIf="hasLoaded && !errorMessage">
    <!-- Search and Sort -->
    <div class="search-sort-row">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          (input)="filterByName()"
          placeholder="Buscar por nombre..."
          class="search-input"
        />
      </div>
      <div class="sort-buttons">
      <span class="sort-label">Ordenar por:</span>
      <button
        class="btn-sort"
        [class.active]="sortField === 'name'"
        (click)="sortBy('name')">
        Nombre {{ sortField === 'name' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : 'A-Z' }}
      </button>
      <button
        class="btn-sort"
        [class.active]="sortField === 'federalDelay'"
        (click)="sortBy('federalDelay')">
        Demora Federal {{ sortField === 'federalDelay' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : '‚Üì' }}
      </button>
      <button
        class="btn-sort"
        [class.active]="sortField === 'stateDelay'"
        (click)="sortBy('stateDelay')">
        Demora Estatal {{ sortField === 'stateDelay' ? (sortDirection === 'desc' ? '‚Üì' : '‚Üë') : '‚Üì' }}
      </button>
      <button
        class="btn-sort-clear"
        *ngIf="sortField"
        (click)="clearSort()">
        Limpiar
      </button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table class="delays-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Docs Completos</th>
            <th>Presentacion</th>
            <th>Recibo Federal</th>
            <th>Recibo Estatal</th>
            <th>Verif. Fed.</th>
            <th>Verif. Est.</th>
            <th>Demora Federal</th>
            <th>Demora Estatal</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let client of filteredClients; trackBy: trackById">
            <td class="col-name">
              <div class="client-cell">
                <span class="client-avatar">{{ getInitials(client.name) }}</span>
                <span class="client-name">{{ client.name }}</span>
              </div>
            </td>
            <td>{{ formatDate(client.documentationCompleteDate) }}</td>
            <td>{{ formatDate(client.taxesFiledAt) }}</td>
            <td>{{ formatDate(client.federalDepositDate) }}</td>
            <td>{{ formatDate(client.stateDepositDate) }}</td>
            <td class="col-verification">
              <span class="badge" [class.badge-yes]="client.federalVerification" [class.badge-no]="!client.federalVerification">
                {{ client.federalVerification ? 'Si' : 'No' }}
              </span>
            </td>
            <td class="col-verification">
              <span class="badge" [class.badge-yes]="client.stateVerification" [class.badge-no]="!client.stateVerification">
                {{ client.stateVerification ? 'Si' : 'No' }}
              </span>
            </td>
            <td class="col-delay">
              <span [class]="getDelayClass(client.federalDelayDays)">
                {{ formatDays(client.federalDelayDays) }}
              </span>
            </td>
            <td class="col-delay">
              <span [class]="getDelayClass(client.stateDelayDays)">
                {{ formatDays(client.stateDelayDays) }}
              </span>
            </td>
            <td>
              <button class="btn-view" (click)="viewClient(client.id)">Ver</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredClients.length === 0">
      <div class="empty-icon">üìä</div>
      <h3>{{ searchQuery ? 'No se encontraron resultados' : 'No hay datos de demoras' }}</h3>
      <p>{{ searchQuery ? 'Intenta con otro nombre' : 'Aun no hay clientes con taxes presentados' }}</p>
    </div>

    <!-- Load More Button -->
    <div class="load-more-section" *ngIf="hasMore && filteredClients.length > 0">
      <button
        class="btn-load-more"
        (click)="loadMoreDelays()"
        [disabled]="isLoadingMore">
        <span *ngIf="!isLoadingMore">Cargar Mas</span>
        <span *ngIf="isLoadingMore">Cargando...</span>
      </button>
    </div>
  </div>
</div>
