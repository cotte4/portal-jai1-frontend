<!-- Initial Loading Screen -->
@if (!hasLoaded) {
  <div class="initial-loading">
    <div class="loading-spinner"></div>
    <p>Cargando seguimiento...</p>
  </div>
}

@if (hasLoaded) {
<div class="tracking-container">
  <!-- Header Section -->
  <div class="tracking-header">
    <div class="header-content">
      <div class="header-icon">üìç</div>
      <div class="header-text">
        <h1>Seguimiento de tu Declaracion</h1>
        <p>Conoce el estado de tu proceso Federal y Estatal</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-refresh" (click)="manualRefresh()" [disabled]="isRefreshing">
        <span class="refresh-icon" [class.spinning]="isRefreshing">üîÑ</span>
        <span>{{ isRefreshing ? 'Actualizando...' : 'Actualizar' }}</span>
      </button>
      <span class="last-update">Ultima actualizacion: {{ lastRefreshFormatted }}</span>
    </div>
  </div>

  <!-- Problem Warning Banner -->
  @if (hasProblem) {
    <div class="problem-warning-banner" (click)="navigateTo('/messages')">
      <div class="problem-warning-icon">‚ö†Ô∏è</div>
      <div class="problem-warning-content">
        <span class="problem-warning-title">Tu tramite requiere atencion</span>
        <span class="problem-warning-text">Contacta a soporte para mas detalles y resolver el inconveniente.</span>
      </div>
      <button class="problem-warning-btn">Contactar ‚Üí</button>
    </div>
  }

  <!-- Summary Cards -->
  @if (!isLoading) {
    <div class="summary-cards">
      <!-- Progress Card -->
      <div class="summary-card progress-summary">
        <div class="card-icon-bg">
          <span>üìä</span>
        </div>
        <div class="card-content">
          <span class="card-label">Progreso Total</span>
          <div class="progress-display">
            <span class="progress-value">{{ overallProgressPercent }}%</span>
            <div class="mini-progress">
              <div class="mini-progress-fill" [style.width.%]="overallProgressPercent"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estimated Refund Card (only show if no final refund exists) -->
      @if (!actualRefund) {
        <div class="summary-card refund-summary" [class.clickable]="!estimatedRefund" (click)="!estimatedRefund && navigateTo('/tax-calculator')">
          <div class="card-icon-bg green">
            <span>üíµ</span>
          </div>
          <div class="card-content">
            <span class="card-label">Reembolso Estimado</span>
            @if (estimatedRefund) {
              <span class="card-value">${{ estimatedRefund.toLocaleString() }} USD</span>
            } @else {
              <span class="card-value no-estimate">Aun no calculaste tu reembolso</span>
              <button class="btn-calculate" (click)="navigateTo('/tax-calculator'); $event.stopPropagation()">Calcular ahora</button>
            }
          </div>
        </div>
      }

      <!-- Actual Refund Card (only show if final refund exists and is greater than 0) -->
      @if (actualRefund) {
        <div class="summary-card actual-summary">
          <div class="card-icon-bg gold">
            <span>üèÜ</span>
          </div>
          <div class="card-content">
            <span class="card-label">Reembolso Final</span>
            <span class="card-value highlight">${{ actualRefund.toLocaleString() }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Wednesday Update Info -->
    <div class="update-info">
      <span class="info-icon">üìÖ</span>
      <span class="info-text">Los estados de tu declaraci√≥n se actualizan todos los mi√©rcoles.</span>
    </div>
  }

  <!-- Skeleton Loading State -->
  @if (isLoading) {
    <div class="tracking-skeleton">
      <!-- Skeleton: Section Title -->
      <div class="skeleton-section">
        <div class="skeleton-row" style="margin-bottom: 20px;">
          <div class="skeleton skeleton-circle" style="width: 32px; height: 32px;"></div>
          <div class="skeleton skeleton-title" style="width: 120px; height: 20px;"></div>
        </div>
        <!-- Skeleton: Steps -->
        <div class="skeleton-steps">
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-title" style="width: 160px; height: 18px; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 220px; height: 14px;"></div>
            </div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-title" style="width: 140px; height: 18px; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 200px; height: 14px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Skeleton: Federal/State Tracks -->
      <div class="skeleton-tracks">
        <div class="skeleton-track">
          <div class="skeleton-row" style="margin-bottom: 16px;">
            <div class="skeleton skeleton-circle" style="width: 28px; height: 28px;"></div>
            <div class="skeleton skeleton-title" style="width: 100px; height: 18px;"></div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 120px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 160px; height: 12px;"></div>
            </div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 140px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 180px; height: 12px;"></div>
            </div>
          </div>
        </div>
        <div class="skeleton-track">
          <div class="skeleton-row" style="margin-bottom: 16px;">
            <div class="skeleton skeleton-circle" style="width: 28px; height: 28px;"></div>
            <div class="skeleton skeleton-title" style="width: 80px; height: 18px;"></div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 130px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 170px; height: 12px;"></div>
            </div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 110px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 150px; height: 12px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  } @else {
    <!-- SHARED STEPS (Steps 1-2) -->
    <div class="shared-timeline" #sharedTrack>
      <div class="timeline-section-title">
        <span class="section-icon">üìÑ</span>
        <span>Etapa Inicial</span>
      </div>
      <div class="shared-steps">
        @for (step of sharedSteps; track step.id; let i = $index) {
          <div
            class="shared-step"
            [class.completed]="step.status === 'completed'"
            [class.active]="step.status === 'active'"
            [class.pending]="step.status === 'pending'"
          >
            <div class="step-indicator">
              @if (step.status === 'completed') {
                <span class="indicator-icon check">‚úì</span>
              } @else if (step.status === 'active') {
                <span class="indicator-icon pulse">‚óè</span>
              } @else {
                <span class="indicator-number">{{ i + 1 }}</span>
              }
            </div>
            <div class="step-info">
              <span class="step-icon">{{ step.icon }}</span>
              <div class="step-text">
                <h3>{{ step.title }}</h3>
                <p>{{ step.description }}</p>
                @if (step.date) {
                  <span class="step-date">üìÖ {{ step.date }}</span>
                }
              </div>
            </div>
            <div class="step-status-badge" [class.success]="step.status === 'completed'">
              {{ step.detail }}
            </div>
          </div>
        }
      </div>

      <!-- In-Progress Message when preparing declaration -->
      @if (isPreparingDeclaration) {
        <div class="preparing-message">
          <div class="preparing-icon">
            <span class="clock-spinner"></span>
          </div>
          <div class="preparing-content">
            <span class="preparing-title">Estamos trabajando en tu caso</span>
            <span class="preparing-text">Estamos revisando tu informacion y preparando tu declaracion. Te avisaremos cuando haya novedades.</span>
          </div>
        </div>
      }
    </div>

    <!-- BRANCH SPLIT VISUAL -->
    <div class="branch-split">
      <div class="split-line"></div>
      <div class="split-icon">‚Üì</div>
      <div class="split-line"></div>
    </div>

    <!-- DUAL TRACK - Federal & Estatal Side by Side -->
    <div class="dual-track">
      <!-- FEDERAL TRACK (Left) -->
      <div class="track federal-track" #federalTrack>
        <div class="track-header federal">
          <span class="track-icon">ü¶Ö</span>
          <h2>Federal</h2>
          <div class="track-progress">
            <span>{{ federalProgressPercent }}%</span>
            <div class="track-progress-bar">
              <div class="track-progress-fill" [style.width.%]="federalProgressPercent"></div>
            </div>
          </div>
        </div>

        <div class="track-timeline">
          <div class="track-line">
            <div class="track-line-fill" [style.height.%]="federalProgressPercent"></div>
          </div>
          <div class="track-steps">
            @for (step of federalSteps; track step.id; let i = $index) {
              <div
                class="track-step"
                [class.completed]="step.status === 'completed'"
                [class.active]="step.status === 'active'"
                [class.rejected]="step.status === 'rejected'"
                [class.pending]="step.status === 'pending'"
              >
                <div class="step-dot">
                  @if (step.status === 'completed') {
                    <span class="dot-icon">‚úì</span>
                  } @else if (step.status === 'rejected') {
                    <span class="dot-icon rejected">‚úó</span>
                  } @else if (step.status === 'active') {
                    <span class="dot-icon active">‚óè</span>
                  } @else {
                    <span class="dot-number">{{ i + 1 }}</span>
                  }
                </div>
                <div class="step-card">
                  <div class="step-card-header">
                    <span class="card-icon">{{ step.icon }}</span>
                    <span class="card-title">{{ step.title }}</span>
                  </div>
                  <p class="card-desc">{{ step.description }}</p>
                  <div class="card-footer">
                    <span class="card-detail" [class.success]="step.status === 'completed'" [class.error]="step.status === 'rejected'">
                      {{ step.detail }}
                    </span>
                    @if (step.date) {
                      <span class="card-date">{{ step.date }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- ESTATAL TRACK (Right) -->
      <div class="track estatal-track" #stateTrack>
        <div class="track-header estatal">
          <span class="track-icon">üóΩ</span>
          <h2>Estatal</h2>
          <div class="track-progress">
            <span>{{ estatalProgressPercent }}%</span>
            <div class="track-progress-bar">
              <div class="track-progress-fill estatal" [style.width.%]="estatalProgressPercent"></div>
            </div>
          </div>
        </div>

        <div class="track-timeline">
          <div class="track-line estatal">
            <div class="track-line-fill estatal" [style.height.%]="estatalProgressPercent"></div>
          </div>
          <div class="track-steps">
            @for (step of estatalSteps; track step.id; let i = $index) {
              <div
                class="track-step"
                [class.completed]="step.status === 'completed'"
                [class.active]="step.status === 'active'"
                [class.rejected]="step.status === 'rejected'"
                [class.pending]="step.status === 'pending'"
              >
                <div class="step-dot estatal">
                  @if (step.status === 'completed') {
                    <span class="dot-icon">‚úì</span>
                  } @else if (step.status === 'rejected') {
                    <span class="dot-icon rejected">‚úó</span>
                  } @else if (step.status === 'active') {
                    <span class="dot-icon active">‚óè</span>
                  } @else {
                    <span class="dot-number">{{ i + 1 }}</span>
                  }
                </div>
                <div class="step-card">
                  <div class="step-card-header">
                    <span class="card-icon">{{ step.icon }}</span>
                    <span class="card-title">{{ step.title }}</span>
                  </div>
                  <p class="card-desc">{{ step.description }}</p>
                  <div class="card-footer">
                    <span class="card-detail" [class.success]="step.status === 'completed'" [class.error]="step.status === 'rejected'">
                      {{ step.detail }}
                    </span>
                    @if (step.date) {
                      <span class="card-date">{{ step.date }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- REFUND CONFIRMATION SECTION -->
    @if (canConfirmFederal || canConfirmState || hasUnpaidFee) {
      <div class="refund-confirmation-section">
        <div class="confirmation-header">
          <span class="confirmation-icon">üí∞</span>
          <h2>Confirmacion de Reembolso</h2>
        </div>

        <!-- Federal Confirmation Card -->
        @if (canConfirmFederal || federalConfirmed) {
          <div class="confirmation-card" [class.confirmed]="federalConfirmed">
            <div class="card-track-badge federal">Federal</div>
            <div class="confirmation-content">
              <div class="refund-info">
                <span class="refund-label">Monto depositado:</span>
                <span class="refund-amount">${{ (profileData?.taxCase?.federalActualRefund || 0).toLocaleString() }}</span>
              </div>
              @if (federalConfirmed) {
                <div class="confirmed-badge">
                  <span class="confirmed-icon">‚úì</span>
                  <span>Recibido confirmado</span>
                </div>
              } @else {
                <button
                  class="btn-confirm"
                  (click)="confirmFederalRefund()"
                  [disabled]="isConfirmingFederal"
                >
                  @if (isConfirmingFederal) {
                    <span class="btn-spinner"></span>
                    <span>Confirmando...</span>
                  } @else {
                    <span>‚úì Confirmo que recibi mi reembolso federal</span>
                  }
                </button>
              }
            </div>
          </div>
        }

        <!-- State Confirmation Card -->
        @if (canConfirmState || stateConfirmed) {
          <div class="confirmation-card" [class.confirmed]="stateConfirmed">
            <div class="card-track-badge state">Estatal</div>
            <div class="confirmation-content">
              <div class="refund-info">
                <span class="refund-label">Monto depositado:</span>
                <span class="refund-amount">${{ (profileData?.taxCase?.stateActualRefund || 0).toLocaleString() }}</span>
              </div>
              @if (stateConfirmed) {
                <div class="confirmed-badge">
                  <span class="confirmed-icon">‚úì</span>
                  <span>Recibido confirmado</span>
                </div>
              } @else {
                <button
                  class="btn-confirm"
                  (click)="confirmStateRefund()"
                  [disabled]="isConfirmingState"
                >
                  @if (isConfirmingState) {
                    <span class="btn-spinner"></span>
                    <span>Confirmando...</span>
                  } @else {
                    <span>‚úì Confirmo que recibi mi reembolso estatal</span>
                  }
                </button>
              }
            </div>
          </div>
        }

        <!-- Payment Section (shows after confirmation) -->
        @if (hasUnpaidFee) {
          <div class="payment-section">
            <div class="payment-header">
              <span class="payment-icon">üìã</span>
              <h3>Pago de Comision JAI1</h3>
            </div>

            <div class="fee-summary">
              <div class="fee-row">
                <span>Comision JAI1 (11%):</span>
                <span class="fee-amount">${{ totalFeeOwed.toLocaleString() }}</span>
              </div>
            </div>

            <div class="payment-methods">
              <!-- Zelle (Primary) -->
              <div class="payment-method primary">
                <div class="method-header">
                  <span class="method-badge recommended">Recomendado</span>
                  <span class="method-name">Zelle</span>
                </div>
                <div class="method-content">
                  <div class="zelle-info">
                    <span class="zelle-label">Enviar a:</span>
                    <div class="zelle-email-container">
                      <span class="zelle-email">jai1&#64;memas.agency</span>
                      <button class="btn-copy" (click)="copyZelleEmail()">
                        @if (copiedToClipboard) {
                          <span class="copy-success">‚úì Copiado</span>
                        } @else {
                          <span>üìã Copiar</span>
                        }
                      </button>
                    </div>
                  </div>
                  <p class="method-note">Usa tu app de banco para enviar el pago por Zelle</p>
                </div>
              </div>

              <!-- Other Methods (Expandable) -->
              <details class="other-methods">
                <summary class="other-methods-toggle">
                  <span>Otros metodos de pago</span>
                  <span class="toggle-icon">‚ñº</span>
                </summary>
                <div class="other-methods-content">
                  <div class="payment-method secondary">
                    <span class="method-name">Transferencia Bancaria</span>
                    <p class="method-note">Contactanos para obtener los datos bancarios</p>
                  </div>
                  <div class="payment-method secondary">
                    <span class="method-name">Stripe / Tarjeta</span>
                    <p class="method-note">Proximamente disponible</p>
                  </div>
                </div>
              </details>
            </div>

            <div class="payment-notice">
              <span class="notice-icon">‚ÑπÔ∏è</span>
              <span class="notice-text">Una vez realizado el pago, nuestro equipo verificara la transaccion y actualizara tu estado.</span>
            </div>
          </div>
        }
      </div>
    }
  }

  <!-- Help Section -->
  <div class="help-section">
    <div class="help-card">
      <div class="help-icon">üí¨</div>
      <div class="help-content">
        <h3>¬øTenes dudas sobre tu estado?</h3>
        <p>Nuestro equipo esta disponible para ayudarte con cualquier consulta</p>
      </div>
      <button class="btn-help" (click)="navigateTo('/messages')">
        Contactar soporte
      </button>
    </div>
  </div>

  <!-- Info Note -->
  <div class="info-note">
    <span class="note-icon">‚ÑπÔ∏è</span>
    <span class="note-text">
      El estado se actualiza automaticamente cada 30 segundos. Los tiempos de procesamiento del IRS pueden variar entre Federal y Estatal.
    </span>
  </div>
</div>
}
