<!-- Initial Loading Screen -->
@if (!hasLoaded) {
  <div class="initial-loading">
    <div class="loading-spinner"></div>
    <p>Cargando seguimiento...</p>
  </div>
}

@if (hasLoaded) {
<div class="tracking-container">
  <!-- Header Section -->
  <div class="tracking-header">
    <div class="header-content">
      <div class="header-icon">ğŸ“</div>
      <div class="header-text">
        <h1>Seguimiento de tu Declaracion</h1>
        <p>Conoce el estado de tu proceso Federal y Estatal</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-refresh" (click)="manualRefresh()" [disabled]="isRefreshing">
        <span class="refresh-icon" [class.spinning]="isRefreshing">ğŸ”„</span>
        <span>{{ isRefreshing ? 'Actualizando...' : 'Actualizar' }}</span>
      </button>
      <span class="last-update">Ultima actualizacion: {{ lastRefreshFormatted }}</span>
    </div>
  </div>

  <!-- Problem Warning Banner -->
  @if (hasProblem) {
    <div class="problem-warning-banner" (click)="navigateTo('/messages')">
      <div class="problem-warning-icon">âš ï¸</div>
      <div class="problem-warning-content">
        <span class="problem-warning-title">Tu tramite requiere atencion</span>
        <span class="problem-warning-text">Contacta a soporte para mas detalles y resolver el inconveniente.</span>
      </div>
      <button class="problem-warning-btn">Contactar â†’</button>
    </div>
  }

  <!-- Summary Cards -->
  @if (!isLoading) {
    <div class="summary-cards">
      <!-- Progress Card -->
      <div class="summary-card progress-summary">
        <div class="card-icon-bg">
          <span>ğŸ“Š</span>
        </div>
        <div class="card-content">
          <span class="card-label">Progreso Total</span>
          <div class="progress-display">
            <span class="progress-value">{{ overallProgressPercent }}%</span>
            <div class="mini-progress">
              <div class="mini-progress-fill" [style.width.%]="overallProgressPercent"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estimated Refund Card (only show if no final refund exists) -->
      @if (!actualRefund) {
        <div class="summary-card refund-summary" [class.clickable]="!estimatedRefund" (click)="!estimatedRefund && navigateTo('/tax-calculator')">
          <div class="card-icon-bg green">
            <span>ğŸ’µ</span>
          </div>
          <div class="card-content">
            <span class="card-label">Reembolso Estimado</span>
            @if (estimatedRefund) {
              <span class="card-value">${{ estimatedRefund.toLocaleString() }} USD</span>
            } @else {
              <span class="card-value no-estimate">Aun no calculaste tu reembolso</span>
              <button class="btn-calculate" (click)="navigateTo('/tax-calculator'); $event.stopPropagation()">Calcular ahora</button>
            }
          </div>
        </div>
      }

      <!-- Actual Refund Card (only show if final refund exists and is greater than 0) -->
      @if (actualRefund) {
        <div class="summary-card actual-summary">
          <div class="card-icon-bg gold">
            <span>ğŸ†</span>
          </div>
          <div class="card-content">
            <span class="card-label">Reembolso Final</span>
            <span class="card-value highlight">${{ actualRefund.toLocaleString() }}</span>
          </div>
        </div>
      }
    </div>
  }

  <!-- Skeleton Loading State -->
  @if (isLoading) {
    <div class="tracking-skeleton">
      <!-- Skeleton: Section Title -->
      <div class="skeleton-section">
        <div class="skeleton-row" style="margin-bottom: 20px;">
          <div class="skeleton skeleton-circle" style="width: 32px; height: 32px;"></div>
          <div class="skeleton skeleton-title" style="width: 120px; height: 20px;"></div>
        </div>
        <!-- Skeleton: Steps -->
        <div class="skeleton-steps">
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-title" style="width: 160px; height: 18px; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 220px; height: 14px;"></div>
            </div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-title" style="width: 140px; height: 18px; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 200px; height: 14px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Skeleton: Federal/State Tracks -->
      <div class="skeleton-tracks">
        <div class="skeleton-track">
          <div class="skeleton-row" style="margin-bottom: 16px;">
            <div class="skeleton skeleton-circle" style="width: 28px; height: 28px;"></div>
            <div class="skeleton skeleton-title" style="width: 100px; height: 18px;"></div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 120px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 160px; height: 12px;"></div>
            </div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 140px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 180px; height: 12px;"></div>
            </div>
          </div>
        </div>
        <div class="skeleton-track">
          <div class="skeleton-row" style="margin-bottom: 16px;">
            <div class="skeleton skeleton-circle" style="width: 28px; height: 28px;"></div>
            <div class="skeleton skeleton-title" style="width: 80px; height: 18px;"></div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 130px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 170px; height: 12px;"></div>
            </div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-text" style="width: 110px; height: 16px; margin-bottom: 6px;"></div>
              <div class="skeleton skeleton-text" style="width: 150px; height: 12px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  } @else {
    <!-- SHARED STEPS (Steps 1-2) -->
    <div class="shared-timeline" #sharedTrack>
      <div class="timeline-section-title">
        <span class="section-icon">ğŸ“„</span>
        <span>Etapa Inicial</span>
      </div>
      <div class="shared-steps">
        @for (step of sharedSteps; track step.id; let i = $index) {
          <div
            class="shared-step"
            [class.completed]="step.status === 'completed'"
            [class.active]="step.status === 'active'"
            [class.pending]="step.status === 'pending'"
          >
            <div class="step-indicator">
              @if (step.status === 'completed') {
                <span class="indicator-icon check">âœ“</span>
              } @else if (step.status === 'active') {
                <span class="indicator-icon pulse">â—</span>
              } @else {
                <span class="indicator-number">{{ i + 1 }}</span>
              }
            </div>
            <div class="step-info">
              <span class="step-icon">{{ step.icon }}</span>
              <div class="step-text">
                <h3>{{ step.title }}</h3>
                <p>{{ step.description }}</p>
                @if (step.date) {
                  <span class="step-date">ğŸ“… {{ step.date }}</span>
                }
              </div>
            </div>
            <div class="step-status-badge" [class.success]="step.status === 'completed'">
              {{ step.detail }}
            </div>
          </div>
        }
      </div>

      <!-- In-Progress Message when preparing declaration -->
      @if (isPreparingDeclaration) {
        <div class="preparing-message">
          <div class="preparing-icon">
            <span class="clock-spinner"></span>
          </div>
          <div class="preparing-content">
            <span class="preparing-title">Estamos trabajando en tu caso</span>
            <span class="preparing-text">Estamos revisando tu informacion y preparando tu declaracion. Te avisaremos cuando haya novedades.</span>
          </div>
        </div>
      }
    </div>

    <!-- BRANCH SPLIT VISUAL -->
    <div class="branch-split">
      <div class="split-line"></div>
      <div class="split-icon">â†“</div>
      <div class="split-line"></div>
    </div>

    <!-- DUAL TRACK - Federal & Estatal Side by Side -->
    <div class="dual-track">
      <!-- FEDERAL TRACK (Left) -->
      <div class="track federal-track" #federalTrack>
        <div class="track-header federal">
          <span class="track-icon">ğŸ¦…</span>
          <h2>Federal</h2>
          <div class="track-progress">
            <span>{{ federalProgressPercent }}%</span>
            <div class="track-progress-bar">
              <div class="track-progress-fill" [style.width.%]="federalProgressPercent"></div>
            </div>
          </div>
        </div>

        <div class="track-timeline">
          <div class="track-line">
            <div class="track-line-fill" [style.height.%]="federalProgressPercent"></div>
          </div>
          <div class="track-steps">
            @for (step of federalSteps; track step.id; let i = $index) {
              <div
                class="track-step"
                [class.completed]="step.status === 'completed'"
                [class.active]="step.status === 'active'"
                [class.rejected]="step.status === 'rejected'"
                [class.pending]="step.status === 'pending'"
              >
                <div class="step-dot">
                  @if (step.status === 'completed') {
                    <span class="dot-icon">âœ“</span>
                  } @else if (step.status === 'rejected') {
                    <span class="dot-icon rejected">âœ—</span>
                  } @else if (step.status === 'active') {
                    <span class="dot-icon active">â—</span>
                  } @else {
                    <span class="dot-number">{{ i + 1 }}</span>
                  }
                </div>
                <div class="step-card">
                  <div class="step-card-header">
                    <span class="card-icon">{{ step.icon }}</span>
                    <span class="card-title">{{ step.title }}</span>
                  </div>
                  <p class="card-desc">{{ step.description }}</p>
                  <div class="card-footer">
                    <span class="card-detail" [class.success]="step.status === 'completed'" [class.error]="step.status === 'rejected'">
                      {{ step.detail }}
                    </span>
                    @if (step.date) {
                      <span class="card-date">{{ step.date }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- ESTATAL TRACK (Right) -->
      <div class="track estatal-track" #stateTrack>
        <div class="track-header estatal">
          <span class="track-icon">ğŸ—½</span>
          <h2>Estatal</h2>
          <div class="track-progress">
            <span>{{ estatalProgressPercent }}%</span>
            <div class="track-progress-bar">
              <div class="track-progress-fill estatal" [style.width.%]="estatalProgressPercent"></div>
            </div>
          </div>
        </div>

        <div class="track-timeline">
          <div class="track-line estatal">
            <div class="track-line-fill estatal" [style.height.%]="estatalProgressPercent"></div>
          </div>
          <div class="track-steps">
            @for (step of estatalSteps; track step.id; let i = $index) {
              <div
                class="track-step"
                [class.completed]="step.status === 'completed'"
                [class.active]="step.status === 'active'"
                [class.rejected]="step.status === 'rejected'"
                [class.pending]="step.status === 'pending'"
              >
                <div class="step-dot estatal">
                  @if (step.status === 'completed') {
                    <span class="dot-icon">âœ“</span>
                  } @else if (step.status === 'rejected') {
                    <span class="dot-icon rejected">âœ—</span>
                  } @else if (step.status === 'active') {
                    <span class="dot-icon active">â—</span>
                  } @else {
                    <span class="dot-number">{{ i + 1 }}</span>
                  }
                </div>
                <div class="step-card">
                  <div class="step-card-header">
                    <span class="card-icon">{{ step.icon }}</span>
                    <span class="card-title">{{ step.title }}</span>
                  </div>
                  <p class="card-desc">{{ step.description }}</p>
                  <div class="card-footer">
                    <span class="card-detail" [class.success]="step.status === 'completed'" [class.error]="step.status === 'rejected'">
                      {{ step.detail }}
                    </span>
                    @if (step.date) {
                      <span class="card-date">{{ step.date }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Help Section -->
  <div class="help-section">
    <div class="help-card">
      <div class="help-icon">ğŸ’¬</div>
      <div class="help-content">
        <h3>Â¿Tenes dudas sobre tu estado?</h3>
        <p>Nuestro equipo esta disponible para ayudarte con cualquier consulta</p>
      </div>
      <button class="btn-help" (click)="navigateTo('/messages')">
        Contactar soporte
      </button>
    </div>
  </div>

  <!-- Info Note -->
  <div class="info-note">
    <span class="note-icon">â„¹ï¸</span>
    <span class="note-text">
      El estado se actualiza automaticamente cada 30 segundos. Los tiempos de procesamiento del IRS pueden variar entre Federal y Estatal.
    </span>
  </div>
</div>
}
