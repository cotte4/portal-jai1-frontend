<!-- Initial Loading Screen -->
@if (!hasLoaded) {
  <div class="initial-loading">
    <div class="loading-spinner"></div>
    <p>Cargando seguimiento...</p>
  </div>
}

@if (hasLoaded) {
<div class="tracking-container">
  <!-- Header Section -->
  <div class="tracking-header">
    <div class="header-content">
      <div class="header-icon">üìç</div>
      <div class="header-text">
        <h1>Seguimiento de tu Declaraci√≥n</h1>
        <p>Conoce el estado de tu proceso Federal y Estatal</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-refresh" (click)="manualRefresh()" [disabled]="isRefreshing">
        <span class="refresh-icon" [class.spinning]="isRefreshing">üîÑ</span>
        <span>{{ isRefreshing ? 'Actualizando...' : 'Actualizar' }}</span>
      </button>
      <span class="last-update">√öltima actualizaci√≥n: {{ lastRefreshFormatted }}</span>
    </div>
  </div>

  <!-- Problem Warning Banner -->
  @if (hasProblem) {
    <div class="problem-warning-banner" (click)="navigateTo('/messages')">
      <div class="problem-warning-icon">‚ö†Ô∏è</div>
      <div class="problem-warning-content">
        <span class="problem-warning-title">Tu tramite requiere atencion</span>
        <span class="problem-warning-text">Contacta a soporte para mas detalles y resolver el inconveniente.</span>
      </div>
      <button class="problem-warning-btn">Contactar ‚Üí</button>
    </div>
  }

  <!-- Summary Cards -->
  @if (!isLoading) {
    <div class="summary-cards">
      <!-- Progress Card -->
      <div class="summary-card progress-summary">
        <div class="card-icon-bg">
          <span>üìä</span>
        </div>
        <div class="card-content">
          <span class="card-label">Progreso Total</span>
          <div class="progress-display">
            <span class="progress-value">Paso {{ currentMajorStep }} de 3</span>
            <div class="mini-progress">
              <div class="mini-progress-fill" [style.width.%]="overallProgressPercent"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estimated Refund Card (only show if no final refund exists) -->
      @if (!actualRefund) {
        <div class="summary-card refund-summary" [class.clickable]="!estimatedRefund" (click)="!estimatedRefund && navigateTo('/tax-calculator')">
          <div class="card-icon-bg green">
            <span>üíµ</span>
          </div>
          <div class="card-content">
            <span class="card-label">Reembolso Estimado</span>
            @if (estimatedRefund) {
              <span class="card-value">${{ estimatedRefund.toLocaleString() }} USD</span>
            } @else {
              <span class="card-value no-estimate">Aun no calculaste tu reembolso</span>
              <button class="btn-calculate" (click)="navigateTo('/tax-calculator'); $event.stopPropagation()">Calcular ahora</button>
            }
          </div>
        </div>
      }

      <!-- Actual Refund Card (only show if final refund exists and is greater than 0) -->
      @if (actualRefund) {
        <div class="summary-card actual-summary">
          <div class="card-icon-bg gold">
            <span>üèÜ</span>
          </div>
          <div class="card-content">
            <span class="card-label">Reembolso Final</span>
            <span class="card-value highlight">${{ actualRefund.toLocaleString() }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Wednesday Update Info -->
    <div class="update-info">
      <span class="info-icon">üìÖ</span>
      <span class="info-text">Los estados de tu declaraci√≥n se actualizan todos los mi√©rcoles.</span>
    </div>
  }

  <!-- Skeleton Loading State -->
  @if (isLoading) {
    <div class="tracking-skeleton">
      <div class="skeleton-section">
        <div class="skeleton-row" style="margin-bottom: 20px;">
          <div class="skeleton skeleton-circle" style="width: 32px; height: 32px;"></div>
          <div class="skeleton skeleton-title" style="width: 120px; height: 20px;"></div>
        </div>
        <div class="skeleton-steps">
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-title" style="width: 160px; height: 18px; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 220px; height: 14px;"></div>
            </div>
          </div>
          <div class="skeleton-step">
            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
            <div class="skeleton-step-content">
              <div class="skeleton skeleton-title" style="width: 140px; height: 18px; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 200px; height: 14px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="skeleton-section" style="margin-top: 24px;">
        <div class="skeleton-row" style="margin-bottom: 16px;">
          <div class="skeleton skeleton-circle" style="width: 32px; height: 32px;"></div>
          <div class="skeleton skeleton-title" style="width: 160px; height: 20px;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="skeleton" style="height: 180px; border-radius: 16px;"></div>
          <div class="skeleton" style="height: 180px; border-radius: 16px;"></div>
        </div>
      </div>
    </div>
  } @else {
    <!-- ===== STEP 1: ETAPA INICIAL (Shared Steps) ===== -->
    <div class="shared-timeline" #sharedTrack>
      <div class="timeline-section-title">
        <span class="section-icon">üìÑ</span>
        <span>Etapa Inicial</span>
      </div>
      <div class="shared-steps">
        @for (step of sharedSteps; track step.id; let i = $index) {
          <div
            class="shared-step"
            [class.completed]="step.status === 'completed'"
            [class.active]="step.status === 'active'"
            [class.pending]="step.status === 'pending'"
          >
            <div class="step-indicator">
              @if (step.status === 'completed') {
                <span class="indicator-icon check">‚úì</span>
              } @else if (step.status === 'active') {
                <span class="indicator-icon pulse">‚óè</span>
              } @else {
                <span class="indicator-number">{{ i + 1 }}</span>
              }
            </div>
            <div class="step-info">
              <span class="step-icon">{{ step.icon }}</span>
              <div class="step-text">
                <h3>{{ step.title }}</h3>
                <p>{{ step.description }}</p>
                @if (step.date) {
                  <span class="step-date">üìÖ {{ step.date }}</span>
                }
              </div>
            </div>
            <div class="step-status-badge" [class.success]="step.status === 'completed'">
              {{ step.detail }}
            </div>
          </div>
        }
      </div>

      <!-- In-Progress Message when preparing declaration -->
      @if (isPreparingDeclaration) {
        <div class="preparing-message">
          <div class="preparing-icon">
            <span class="clock-spinner"></span>
          </div>
          <div class="preparing-content">
            <span class="preparing-title">Estamos trabajando en tu caso</span>
            <span class="preparing-text">Estamos revisando tu informaci√≥n y preparando tu declaraci√≥n. Te avisaremos cuando haya novedades.</span>
          </div>
        </div>
      }
    </div>

    <!-- ===== 3-STEP HORIZONTAL PROGRESS INDICATOR ===== -->
    <div class="major-steps-indicator">
      <div class="major-step" [class.active]="currentMajorStep === 1" [class.completed]="currentMajorStep > 1">
        <div class="major-dot">
          @if (currentMajorStep > 1) {
            <span>‚úì</span>
          } @else {
            <span>1</span>
          }
        </div>
        <span class="major-label">Inicial</span>
      </div>
      <div class="major-connector" [class.filled]="currentMajorStep > 1"></div>
      <div class="major-step" [class.active]="currentMajorStep === 2" [class.completed]="currentMajorStep > 2">
        <div class="major-dot">
          @if (currentMajorStep > 2) {
            <span>‚úì</span>
          } @else {
            <span>2</span>
          }
        </div>
        <span class="major-label">Observaciones</span>
      </div>
      <div class="major-connector" [class.filled]="currentMajorStep > 2"></div>
      <div class="major-step" [class.active]="currentMajorStep === 3" [class.completed]="currentMajorStep >= 3">
        <div class="major-dot">
          @if (currentMajorStep >= 3) {
            <span>‚úì</span>
          } @else {
            <span>3</span>
          }
        </div>
        <span class="major-label">Completado</span>
      </div>
    </div>

    <!-- ===== STEP 2: OBSERVACIONES (Federal & State Cards) ===== -->
    @if (currentMajorStep >= 2) {
      <div class="observaciones-section" #observacionesSection>
        <div class="timeline-section-title">
          <span class="section-icon">üìã</span>
          <span>Observaciones</span>
        </div>

        <div class="obs-grid">
          <!-- Federal Card -->
          <div class="obs-card" [class.obs-pending]="federalCategory === 'pending'" [class.obs-in-progress]="federalCategory === 'in_progress'" [class.obs-completed]="federalCategory === 'completed'" [class.obs-issues]="federalCategory === 'issues'">
            <div class="obs-card-header">
              <span class="obs-track-icon">ü¶Ö</span>
              <span class="obs-track-title">Federal</span>
            </div>

            <div class="obs-status-row" [class.status-pending]="federalCategory === 'pending'" [class.status-in-progress]="federalCategory === 'in_progress'" [class.status-completed]="federalCategory === 'completed'" [class.status-issues]="federalCategory === 'issues'">
              <span class="obs-status-label">Estado:</span>
              <span class="obs-status-value">{{ federalStatusLabel }}</span>
            </div>

            <!-- Admin comment -->
            @if (federalLastComment) {
              <div class="obs-comment">
                <span class="obs-comment-icon">üí¨</span>
                <span>{{ federalLastComment }}</span>
              </div>
            }

            <!-- Refund amount if available -->
            @if (federalRefundAmount > 0) {
              <div class="obs-refund-info">
                <span class="obs-refund-label">Monto:</span>
                <span class="obs-refund-amount">${{ federalRefundAmount.toLocaleString() }}</span>
              </div>
            }

            <!-- Fee row: shows after client confirms refund received -->
            @if (federalConfirmed && federalFeeAmount > 0) {
              <div class="obs-fee-row" [class.fee-paid]="isFederalCommissionPaid">
                <span class="obs-fee-label">{{ isFederalCommissionPaid ? '‚úì Comisi√≥n pagada:' : 'Comisi√≥n a pagar:' }}</span>
                <span class="obs-fee-amount">${{ federalFeeAmount.toLocaleString() }}</span>
              </div>
            }

            <!-- Refund confirmation (moved from old section) -->
            @if (canConfirmFederal || federalConfirmed) {
              <div class="obs-refund">
                @if (federalConfirmed) {
                  <div class="confirmed-badge">
                    <span class="confirmed-icon">‚úì</span>
                    <span>Recibido confirmado</span>
                  </div>
                } @else {
                  <button
                    class="btn-confirm"
                    (click)="confirmFederalRefund()"
                    [disabled]="isConfirmingFederal"
                  >
                    @if (isConfirmingFederal) {
                      <span class="btn-spinner"></span>
                      <span>Confirmando...</span>
                    } @else {
                      <span>‚úì Confirmo que recibi mi reembolso</span>
                    }
                  </button>
                }
              </div>
            }
          </div>

          <!-- State Card -->
          <div class="obs-card" [class.obs-pending]="stateCategory === 'pending'" [class.obs-in-progress]="stateCategory === 'in_progress'" [class.obs-completed]="stateCategory === 'completed'" [class.obs-issues]="stateCategory === 'issues'">
            <div class="obs-card-header">
              <span class="obs-track-icon">üóΩ</span>
              <span class="obs-track-title">Estatal</span>
            </div>

            <div class="obs-status-row" [class.status-pending]="stateCategory === 'pending'" [class.status-in-progress]="stateCategory === 'in_progress'" [class.status-completed]="stateCategory === 'completed'" [class.status-issues]="stateCategory === 'issues'">
              <span class="obs-status-label">Estado:</span>
              <span class="obs-status-value">{{ stateStatusLabel }}</span>
            </div>

            <!-- Admin comment -->
            @if (stateLastComment) {
              <div class="obs-comment">
                <span class="obs-comment-icon">üí¨</span>
                <span>{{ stateLastComment }}</span>
              </div>
            }

            <!-- Refund amount if available -->
            @if (stateRefundAmount > 0) {
              <div class="obs-refund-info">
                <span class="obs-refund-label">Monto:</span>
                <span class="obs-refund-amount">${{ stateRefundAmount.toLocaleString() }}</span>
              </div>
            }

            <!-- Fee row: shows after client confirms refund received -->
            @if (stateConfirmed && stateFeeAmount > 0) {
              <div class="obs-fee-row" [class.fee-paid]="isStateCommissionPaid">
                <span class="obs-fee-label">{{ isStateCommissionPaid ? '‚úì Comisi√≥n pagada:' : 'Comisi√≥n a pagar:' }}</span>
                <span class="obs-fee-amount">${{ stateFeeAmount.toLocaleString() }}</span>
              </div>
            }

            <!-- Refund confirmation (moved from old section) -->
            @if (canConfirmState || stateConfirmed) {
              <div class="obs-refund">
                @if (stateConfirmed) {
                  <div class="confirmed-badge">
                    <span class="confirmed-icon">‚úì</span>
                    <span>Recibido confirmado</span>
                  </div>
                } @else {
                  <button
                    class="btn-confirm"
                    (click)="confirmStateRefund()"
                    [disabled]="isConfirmingState"
                  >
                    @if (isConfirmingState) {
                      <span class="btn-spinner"></span>
                      <span>Confirmando...</span>
                    } @else {
                      <span>‚úì Confirmo que recibi mi reembolso</span>
                    }
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <!-- Payment Section (shows after confirmation, inside observaciones) -->
        @if (hasUnpaidFee) {
          <div class="payment-section">
            <div class="payment-header">
              <span class="payment-icon">üìã</span>
              <h3>Pago de Comision JAI1</h3>
            </div>

            <div class="fee-summary">
              <div class="fee-row">
                <span>Comision JAI1 (11%):</span>
                <span class="fee-amount">${{ totalFeeOwed.toLocaleString() }}</span>
              </div>
            </div>

            <div class="payment-methods">
              <div class="payment-method primary">
                <div class="method-header">
                  <span class="method-badge recommended">Recomendado</span>
                  <span class="method-name">Zelle</span>
                </div>
                <div class="method-content">
                  <div class="zelle-info">
                    <span class="zelle-label">Enviar a:</span>
                    <div class="zelle-email-container">
                      <span class="zelle-email">jai1&#64;memas.agency</span>
                      <button class="btn-copy" (click)="copyZelleEmail()">
                        @if (copiedToClipboard) {
                          <span class="copy-success">‚úì Copiado</span>
                        } @else {
                          <span>üìã Copiar</span>
                        }
                      </button>
                    </div>
                  </div>
                  <p class="method-note">Usa tu app de banco para enviar el pago por Zelle</p>
                </div>
              </div>

              <details class="other-methods">
                <summary class="other-methods-toggle">
                  <span>Otros m√©todos de pago</span>
                  <span class="toggle-icon">‚ñº</span>
                </summary>
                <div class="other-methods-content">
                  <div class="payment-method secondary">
                    <span class="method-name">Transferencia Bancaria</span>
                    <p class="method-note">Contactanos para obtener los datos bancarios</p>
                  </div>
                  <div class="payment-method secondary">
                    <span class="method-name">Stripe / Tarjeta</span>
                    <p class="method-note">Proximamente disponible</p>
                  </div>
                </div>
              </details>
            </div>

            <div class="payment-notice">
              <span class="notice-icon">‚ÑπÔ∏è</span>
              <span class="notice-text">Una vez realizado el pago, nuestro equipo verificara la transaccion y actualizara tu estado.</span>
            </div>
          </div>
        }
      </div>
    }

    <!-- ===== STEP 3: COMPLETADO ===== -->
    @if (isFullyCompleted) {
      <div class="completado-section" #completadoSection>
        <div class="completado-icon">üéâ</div>
        <h2 class="completado-title">¬°Proceso Completado!</h2>
        <p class="completado-message">Tus reembolsos Federal y Estatal han sido depositados exitosamente.</p>
        @if (actualRefund) {
          <div class="completado-amount">
            <span class="completado-amount-label">Monto Total Recibido</span>
            <span class="completado-amount-value">${{ actualRefund.toLocaleString() }}</span>
          </div>
        }
      </div>
    }
  }

  <!-- Help Section -->
  <div class="help-section">
    <div class="help-card">
      <div class="help-icon">üí¨</div>
      <div class="help-content">
        <h3>¬øTenes dudas sobre tu estado?</h3>
        <p>Nuestro equipo esta disponible para ayudarte con cualquier consulta</p>
      </div>
      <button class="btn-help" (click)="navigateTo('/messages')">
        Contactar soporte
      </button>
    </div>
  </div>

  <!-- Info Note -->
  <div class="info-note">
    <span class="note-icon">‚ÑπÔ∏è</span>
    <span class="note-text">
      El estado se actualiza automaticamente cada 30 segundos. Los tiempos de procesamiento del IRS pueden variar entre Federal y Estatal.
    </span>
  </div>
</div>
}
